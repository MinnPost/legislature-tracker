/*! legislature-tracker - v0.0.3 - 2014-02-03
* https://github.com/MinnPost/legislature-tracker
* Copyright (c) 2014 ; Licensed MIT */

(function(t){_.mixin({trim:function(t){return _.isString(t)&&(t=String.prototype.trim?t.trim():t.replace(/^\s+|\s+$/g,"")),t},cssClass:function(t){return t.replace(/[^a-z0-9]/g,"-")},numberFormatCommas:function(t){return(""+t).replace(/\B(?=(\d{3})+(?!\d))/g,",")},ellipsisText:function(t,e){var i,l,n,s,a="",o="<!-- break -->",r='<ins class="ellipsis-start">[[[TEXT]]]</ins>',_='<ins class="ellipsis-ellipsis">...</ins>',c='<ins class="ellipsis-end">[[[TEXT]]]</ins>';return-1!==t.indexOf(o)?(i=t.indexOf(o),a+=r.replace("[[[TEXT]]]",t.substring(0,i))+" ",a+=_+" ",a+=c.replace("[[[TEXT]]]",t.substring(i,t.length))+" "):(s=t.split(" "),e>=s.length?a+=r.replace("[[[TEXT]]]",t):(l=s.slice(0,e),n=s.slice(e),a+=r.replace("[[[TEXT]]]",l.join(" "))+" ",a+=_+" ",a+=c.replace("[[[TEXT]]]",n.join(" "))+" ")),a},parseURL:function(t){var e=document.createElement("a");return e.href=t,e}}),Backbone.ajax=function(){var t=arguments;return t[0].dataTypeForce!==!0&&(t[0].dataType="jsonp"),Backbone.$.ajax.apply(Backbone.$,t)},t.fn.hasScrollBar=function(){return this.get(0)&&this.get(0).scrollHeight?this.get(0).scrollHeight>this.height():!1}})(jQuery,window);var LT,originalLT,exports=exports||void 0;_.isUndefined(exports)?(originalLT=window.LT,LT={},LT.noConflict=function(){return window.LT=originalLT,this},window.LT=LT):LT=exports,function(t,e,i){LT.cache={},LT.cache.models={},LT.log=function(t){_.isUndefined(window.console)||window.console.log(t)},LT.utils={},LT.utils.getModel=function(t,e,i,l){var n=t+":"+e+":"+i[e];return l=l||LT.options,_.isUndefined(LT.cache.models[n])&&(LT.cache.models[n]=new LT[t](i,l)),LT.cache.models[n]},LT.utils.fetchModel=function(e){var i;return e.get("fetched")!==!0?e.fetch():(i=t.Deferred(),i.resolveWith(e),i)},LT.utils.translate=function(t,e){var i=e;return _.isObject(LT.options.wordTranslations[t])&&_.isString(LT.options.wordTranslations[t][e])&&(i=LT.options.wordTranslations[t][e]),i},LT.utils.imagePath=function(t){return 0===t.indexOf("http")?t:LT.options.imagePath+t},LT.templates=LT.templates||{},LT.utils.getTemplate=function(e,i,l,n){var s="js/app/templates/"+e+".html",a=LT.options.templatePath+e+".html";_.isUndefined(LT.templates[s])?t.ajax({url:a,method:"GET",async:!1,contentType:"text",success:function(t){LT.templates[s]=_.template(t),i[l]=LT.templates[s],_.isFunction(n)&&n.apply(this,[t])}}):i[l]=LT.templates[s]},LT.parse=LT.parse||{},LT.parse.eData=function(t){var e={};e.categories=LT.parse.eCategories(t.sheets("Categories").all());var i=t.sheets("Bills").all();return i.length>LT.options.maxBills&&LT.log("The number of bills in your spreadsheet exceeds maxBills. Set the maxBills option to display them, but be aware that this may significantly slow down the Legislature Tracker."),e.bills=LT.parse.eBills(i.slice(0,LT.options.maxBills)),e.events=LT.parse.eEvents(t.sheets("Events").all()),_.each(_.groupBy(e.events,"bill_id"),function(t,i){_.each(e.bills,function(l,n){l.bill===i&&(e.bills[n].custom_events=t)})}),e},LT.parse.validateBillNumber=function(t){return LT.options.billNumberFormat.test(t)},LT.parse.eBills=function(t){return _.map(t,function(t){return LT.parse.translateFields(LT.options.fieldTranslations.eBills,t),t.links=LT.parse.eLinks(t.links),t.categories=t.categories?t.categories.split(","):[],t.categories=_.map(t.categories,_.trim),t.bill_primary=i,t.bill&&LT.parse.validateBillNumber(t.bill)?t.bill_primary=LT.utils.getModel("OSBillModel","bill_id",{bill_id:_.trim(t.bill)}):t.bill&&!LT.parse.validateBillNumber(t.bill)&&LT.log('Invalid primary bill number "'+t.bill+'" for row '+t.rowNumber+", see documentation."),t.bill_companion&&LT.parse.validateBillNumber(t.bill_companion)?t.bill_companion=LT.utils.getModel("OSBillModel","bill_id",{bill_id:_.trim(t.bill_companion)}):t.bill_companion&&!LT.parse.validateBillNumber(t.bill_companion)&&LT.log('Invalid companion bill number "'+t.bill_companion+'" for row '+t.rowNumber+", see documentation."),t.bill_conference&&LT.parse.validateBillNumber(t.bill_conference)?t.bill_conference=LT.utils.getModel("OSBillModel","bill_id",{bill_id:_.trim(t.bill_conference)}):t.bill_conference&&!LT.parse.validateBillNumber(t.bill_conference)&&LT.log('Invalid conference bill number "'+t.bill_conference+'" for row '+t.rowNumber+", see documentation."),t.hasBill=!0,t.bill&&t.bill_primary!==i||(t.hasBill=!1,t.bill=_.cssClass(t.title.toLowerCase())),t})},LT.parse.eCategories=function(t){return _.map(t,function(t){return LT.parse.translateFields(LT.options.fieldTranslations.eCategories,t),t.links=LT.parse.eLinks(t.links),t})},LT.parse.eEvents=function(t){return _.map(t,function(t){return LT.parse.translateFields(LT.options.fieldTranslations.eEvents,t),t.links=LT.parse.eLinks(t.links),t.date=moment(t.date),t.type=["custom"],t})},LT.parse.eLinks=function(t){var e=[];return t=_.trim(t),0===t.length?e:(t='"'===t.substring(0,1)?t.substring(1):t,t='"'===t.substring(t.length-1,t.length)?t.slice(0,-1):t,e=t.split('", "'),e=_.map(e,function(t){return{title:t.split("|")[0],url:t.split("|")[1]}}))},LT.parse.csvCategories=function(t){return t=_.trim(t),0===t.length?[]:(t='"'===t.substring(0,1)?t.substring(1):t,t='"'===t.substring(t.length-1,t.length)?t.slice(0,-1):t,t.split('", "'))},LT.parse.detectCompanionBill=function(t){var e,l;return _.isFunction(LT.options.detectCompanionBill)?(e=LT.options.detectCompanionBill(t),l=LT.parse.validateBillNumber(e)?e:i):_.isRegExp(LT.options.detectCompanionBill)&&(e=LT.options.detectCompanionBill.exec(t),l=e&&LT.parse.validateBillNumber(e[1])?e[1]:i),_.trim(l)},LT.parse.translateFields=function(t,e){return _.each(t,function(t,i){e[i]=e[t],i!==t&&delete e[t]}),e},LT.defaultOptions={sheetsWanted:["Categories","Bills","Events"],fieldTranslations:{eCategories:{id:"categoryid",short_title:"shorttitle"},eBills:{bill:"bill",bill_companion:"companionbill",bill_conference:"conferencebill",categories:"categories",title:"title",description:"description"},eEvents:{bill_id:"bill",actor:"chamber",action:"title"}},wordTranslations:{chamber:{upper:"Senate",lower:"House"},partyAbbr:{"Democratic-Farmer-Labor":"DFL",Democratic:"D",Republican:"R"}},maxBills:30,substituteMatch:/substituted/i,imagePath:"./css/images/",templatePath:"./js/app/templates/",recentChangeThreshold:7,tabletopOptions:{},scrollOffset:!1,conferenceBill:!0,recentImage:"RecentUpdatedBill.png",chamberLabel:!1,detectCompanionBill:/([A-Z]+ [1-9][0-9]*)$/,billNumberFormat:/[A-Z]+ [1-9][0-9]*/,osBillParse:!1}}(jQuery,window),this.LT=this.LT||{},this.LT.templates=this.LT.templates||{},this.LT.templates["js/templates/template-categories.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='\n<div class="categories-container">\n  ',LT.options.title&&(__p+="\n    <h2>"+(null==(__t=LT.options.title)?"":__t)+"</h2>\n  "),__p+="\n  \n  ",LT.app.totalBills!==void 0&&(__p+='\n    <div class="aggregate-counts">\n      <span class="aggregate-stat">\n        <span class="aggregate-count-label">Bills introduced:</span>\n        <span class="aggregate-count-value">'+(null==(__t=_.numberFormatCommas(LT.app.totalBills))?"":__t)+'</span>\n      </span>\n      \n      <span class="aggregate-stat">\n        <span class="aggregate-count-label">Bills signed:</span>\n        <span class="aggregate-count-value">'+(null==(__t=_.numberFormatCommas(LT.app.totalBillsSigned))?"":__t)+"</span>\n      </span>\n    </div>\n  "),__p+='\n\n  <ul class="category-list clear-block">\n    ',_.each(categories,function(t,e){__p+='\n      <li class="category-item category-item-'+(null==(__t=e)?"":__t)+'">\n        <div class="category-inner category-'+(null==(__t=_.cssClass(t.id))?"":__t)+'">\n          ',t.image&&(__p+='\n            <a href="#/category/'+(null==(__t=encodeURI(t.id))?"":__t)+'">\n              <img class="category-image" src="'+(null==(__t=LT.utils.imagePath(t.image))?"":__t)+'" />\n            </a>\n          '),__p+='\n           \n          <h3>\n            <a href="#/category/'+(null==(__t=encodeURI(t.id))?"":__t)+'">\n              '+(null==(__t=t.title)?"":__t)+"\n            </a>\n          </h3>\n          \n          <div>\n            Watching \n            <strong>"+(null==(__t=t.bills.length)?"":__t)+"</strong>\n            ",t.total_bill_count&&(__p+="\n              of "+(null==(__t=t.total_bill_count)?"":__t)+"\n            "),__p+="\n            bills.\n          </div>\n        </div>\n      </li>\n    "}),__p+="\n  </ul>\n</div>";return __p},this.LT.templates["js/templates/template-category.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+="\n"+(null==(__t=header)?"":__t)+'\n\n<div class="category-container">\n  <h2>\n    ',category.image&&(__p+='\n      <img class="category-image" src="'+(null==(__t=LT.utils.imagePath(category.image))?"":__t)+'" />\n    '),__p+="\n    \n    "+(null==(__t=category.title)?"":__t)+"\n  </h2>\n  \n  <p>"+(null==(__t=category.description)?"":__t)+"</p>\n  \n  ",_.isArray(category.links)&&category.links.length>0&&(__p+='\n    <div class="e-links">\n      <h4>In the news</h4>\n      \n      <ul class="e-links-list">\n        ',_.each(category.links,function(t){__p+='\n          <li><a href="'+(null==(__t=t.url)?"":__t)+'">'+(null==(__t=t.title)?"":__t)+"</a></li>\n        "}),__p+="\n      </ul>\n    </div>\n  "),__p+='\n  \n  <div class="clear-block bills-list">\n    ',category.bills.each(function(t){__p+="\n      "+(null==(__t=templates.ebill({bill:t.toJSON(),expandable:!0,templates:templates}))?"":__t)+"\n    "}),__p+='\n  </div>\n  \n  <div class="clear-block total-bill">\n    Watching \n    <strong>'+(null==(__t=category.bills.length)?"":__t)+"</strong>\n    ",category.total_bill_count!==void 0&&(__p+="\n      of "+(null==(__t=category.total_bill_count)?"":__t)+"\n    "),__p+="\n    bills in the "+(null==(__t=category.title)?"":__t)+" category.\n  </div>\n</div>";return __p},this.LT.templates["js/templates/template-ebill.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)expandable||(__p+="\n  "+(null==(__t=header)?"":__t)+"\n"),__p+='\n<div class="bill ebill ',expandable&&(__p+="is-expandable"),__p+=" ",bill.hasBill||(__p+="no-bill"),__p+='">\n  <div class="bill-top">\n    <div class="bill-status">\n      <img class="lower ',bill.newest_action&&Math.abs(parseInt(bill.newest_action.date.diff(moment(),"days")))<LT.options.recentChangeThreshold&&(__p+="passed"),__p+='" src="'+(null==(__t=LT.options.imagePath)?"":__t)+'RecentChanges.png" title="',__p+=bill.newest_action&&Math.abs(parseInt(bill.newest_action.date.diff(moment(),"days")))<LT.options.recentChangeThreshold?"Recently changed":"Not recently changed",__p+='" />\n      \n      <img class="lower ',bill.actions&&bill.actions.lower&&(__p+="passed"),__p+='" src="'+(null==(__t=LT.options.imagePath)?"":__t)+'PassedHouse.png" title="',__p+=bill.actions&&bill.actions.lower?"Passed "+(null==(__t=LT.utils.translate("chamber","lower"))?"":__t):"Not passed "+(null==(__t=LT.utils.translate("chamber","lower"))?"":__t),__p+='" />\n      \n      <img class="upper ',bill.actions&&bill.actions.upper&&(__p+="passed"),__p+='" src="'+(null==(__t=LT.options.imagePath)?"":__t)+'PassedSenate.png" title="',__p+=bill.actions&&bill.actions.upper?"Passed "+(null==(__t=LT.utils.translate("chamber","upper"))?"":__t):"Not passed "+(null==(__t=LT.utils.translate("chamber","upper"))?"":__t),__p+='" />\n      \n      ',LT.options.conferenceBill&&(__p+='\n        <img class="conference ',bill.bill_type&&bill.bill_type.conference&&(__p+="passed"),__p+='" src="'+(null==(__t=LT.options.imagePath)?"":__t)+'InConferenceCommittee.png" title="',__p+=bill.bill_type&&bill.bill_type.conference?"Conference bill created":"Coinference bill not created",__p+='" />\n      '),__p+='\n      \n      <img class="signed ',bill.actions&&bill.actions.signed&&(__p+="passed"),__p+='" src="'+(null==(__t=LT.options.imagePath)?"":__t)+'SignedIntoLaw.png" title="',__p+=bill.actions&&bill.actions.signed?"Signed into law by the Governor":"Not signed into law",__p+='" />\n    </div>\n    \n    ',__p+=expandable?"<h3>":"<h2>",__p+="\n      "+(null==(__t=bill.title)?"":__t)+'\n      <a class="permalink" title="Permanent link to bill" href="#/bill/'+(null==(__t=encodeURI(bill.bill))?"":__t)+'"></a>\n    ',__p+=expandable?"</h3>":"</h2>",__p+="\n    \n    ",bill.hasBill||(__p+='\n      <div class="latest-action">\n        <em>This bill has not been tracked by the legislature yet.</em>\n      </div>\n    '),__p+="\n    \n     ",bill.newest_action&&(__p+='\n      <div class="latest-action">\n        Last action '+(null==(__t=bill.newest_action.date.fromNow())?"":__t)+".\n      </div>\n    "),__p+='\n    \n    <div class="description">\n      ',__p+=3>bill.description.indexOf("<p")?"\n        "+(null==(__t=_.ellipsisText(bill.description,60))?"":__t)+"\n      ":"\n        <p>"+(null==(__t=_.ellipsisText(bill.description,60))?"":__t)+"</p>\n      ",__p+='\n    </div>\n    \n    <div class="e-bill-categories">\n      <strong>Categories:</strong>\n      ',_.each(bill.categories,function(t,e){__p+='\n        <a href="#/category/'+(null==(__t=t.get("id"))?"":__t)+'">\n          ',t.get("image")&&(__p+='<img class="category-image" src="'+(null==(__t=LT.utils.imagePath(t.get("image")))?"":__t)+'" />'),__p+="\n          "+(null==(__t=t.get("title"))?"":__t)+"</a>",bill.categories.length-1>e&&(__p+=","),__p+="\n      "}),__p+="\n    </div>\n    \n    ",expandable&&(bill.hasBill||!(60>bill.description.split(" ").length)||_.isArray(bill.links)&&bill.links.length>0)&&(__p+='\n      <a href="#" class="bill-expand">More detail</a>\n      <a href="#/bill/'+(null==(__t=encodeURI(bill.bill))?"":__t)+'" class="bill-details-link">More detail</a>\n    '),__p+='\n  </div>\n  \n  <div class="bill-bottom">\n    ',_.isArray(bill.links)&&bill.links.length>0&&(__p+='\n      <div class="e-links">\n        <h4>In the news</h4>\n        <ul class="e-links-list">\n          ',_.each(bill.links,function(t){__p+='\n            <li><a href="'+(null==(__t=t.url)?"":__t)+'">'+(null==(__t=t.title)?"":__t)+"</a></li>\n          "}),__p+="\n        </ul>\n      </div>\n    "),__p+="\n    \n    ",_.isArray(bill.custom_events)&&bill.custom_events.length>0&&(__p+='\n      <div class="custom-events">\n        <h4>Events</h4>\n        <ul class="custom-events-inner">\n          ',_.each(bill.custom_events,function(t){__p+="\n            <li><strong>"+(null==(__t=t.bill_id)?"":__t)+" "+(null==(__t=t.action)?"":__t)+"</strong> on  "+(null==(__t=t.date.format("MMM DD, YYYY"))?"":__t)+": "+(null==(__t=t.description)?"":__t)+"</li>\n          "}),__p+="\n        </ul>\n      </div>\n    "),__p+="\n\n    ",_.isObject(bill.bill_conference)&&(__p+='\n      <div class="conference-bill">\n        <div class="conference-bill-inner clear-block">\n          '+(null==(__t=templates.osbill({title:"Conference Bill",bill:bill.bill_conference.toJSON(),templates:templates}))?"":__t)+'\n        </div>\n      </div>\n      \n      <a class="expand-other-bills" href="#">Show other bills</a>\n    '),__p+='\n    \n    <div class="clear-block ',_.isObject(bill.bill_conference)&&(__p+="has-conference-bill"),__p+='">\n      ',_.isObject(bill.bill_primary)&&(__p+='\n        <div class="primary-bill ',_.isObject(bill.bill_companion)&&(__p+="with-companion"),__p+='">\n          <div class="primary-bill-inner clear-block">\n            '+(null==(__t=templates.osbill({title:LT.options.chamberLabel?LT.utils.translate("chamber",bill.bill_primary.get("chamber"))+" Bill":"Primary Bill",bill:bill.bill_primary.toJSON(),templates:templates}))?"":__t)+"\n          </div>\n        </div>\n      "),__p+="\n      \n      ",_.isObject(bill.bill_companion)&&(__p+='\n        <div class="companion-bill">\n          <div class="companion-bill-inner clear-block">\n            '+(null==(__t=templates.osbill({title:LT.options.chamberLabel?LT.utils.translate("chamber",bill.bill_companion.get("chamber"))+" Bill":"Companion Bill",bill:bill.bill_companion.toJSON(),templates:templates}))?"":__t)+"\n          </div>\n        </div>\n      "),__p+="\n    </div>\n  </div>\n</div>";return __p},this.LT.templates["js/templates/template-error.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="error-container">\n  <div class="error"><span>There was an error.</span></div>\n</div>';return __p},this.LT.templates["js/templates/template-header.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='<div class="ls-header-container">\n  <div class="ls-header">\n    <a class="all-categories-link" href="#/">\n      <img src="'+(null==(__t=LT.options.imagePath)?"":__t)+'back-100-85.png" />\n      All Categories\n    </a>\n    \n    <span class="categories-nav">\n      &nbsp;&nbsp;|&nbsp;&nbsp;\n      ',_.each(categories,function(t){__p+='\n        <a class="" href="#/category/'+(null==(__t=t.id)?"":__t)+'" title="'+(null==(__t=t.title)?"":__t)+'">\n          '+(null==(__t=t.short_title?t.short_title:t.title.split(" ")[0])?"":__t)+"\n        </a>&nbsp;&nbsp;\n      "}),__p+="\n    </span>\n  </div>\n</div>";return __p},this.LT.templates["js/templates/template-legislator.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='\n<div class="legislator">\n  ',__p+=LT.options.legImageProxy?'\n    <img src="'+(null==(__t=LT.options.legImageProxy)?"":__t)+(null==(__t=encodeURI(photo_url))?"":__t)+'" />\n  ':'\n    <img src="'+(null==(__t=photo_url)?"":__t)+'" />\n  ',__p+='\n  \n  <div class="legislator-info">\n    '+(null==(__t=full_name)?"":__t)+"<br />\n    ","undefined"!=typeof district&&(__p+="\n      District "+(null==(__t=district)?"":__t)+"\n    "),__p+="\n    ","undefined"!=typeof party&&(__p+="\n      ("+(null==(__t=LT.utils.translate("partyAbbr",party))?"":__t)+") \n    "),__p+=" <br />\n    ","undefined"!=typeof chamber&&(__p+="\n      "+(null==(__t=LT.utils.translate("chamber",chamber))?"":__t)+"\n    "),__p+="\n  </div>\n</div>";return __p},this.LT.templates["js/templates/template-loading.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="loading-general-container">\n  <div class="loading-general"><span>Loading...</span></div>\n</div>';return __p},this.LT.templates["js/templates/template-osbill.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj){"undefined"!=typeof detailed&&detailed&&(__p+="\n  "+(null==(__t=header)?"":__t)+"\n"),__p+='\n\n<div class="osbill">\n  <h4>\n    ',__p+="undefined"!=typeof title?"\n      "+(null==(__t=title)?"":__t)+" ("+(null==(__t=bill.bill_id)?"":__t)+")\n    ":"\n      "+(null==(__t=bill.bill_id)?"":__t)+"\n    ",__p+='\n    <a class="permalink" title="Permanent link to bill" href="#/bill-detail/'+(null==(__t=encodeURI(bill.bill_id))?"":__t)+'"></a>\n  </h4>\n  \n  ',"undefined"!=typeof detailed&&detailed&&(__p+='\n    <p class="description">\n      '+(null==(__t=bill.title)?"":__t)+"\n    </p>\n  "),__p+='\n\n  <div class="sponsors primary-sponsors">\n    <h5>Primary sponsors</h5>\n    \n    <div class="clear-block">\n      ',_.each(bill.sponsors,function(t){__p+="\n        ","primary"===t.type&&(__p+='\n          <div class="sponsor" data-leg-id="'+(null==(__t=t.leg_id)?"":__t)+'" data-sponsor-type="'+(null==(__t=t.type)?"":__t)+'">\n            '+(null==(__t=t.name)?"":__t)+" ("+(null==(__t=t.type)?"":__t)+")\n          </div>\n        "),__p+="\n      "}),__p+='\n    </div>\n  </div>\n  \n  <div class="actions">\n    <h5><span class="latest-action-label">Latest </span>Actions</h5>\n    \n    <div class="actions-inner">\n      ',_.each(bill.actions,function(t){__p+="\n        ",t.date&&(__p+="\n          <div>\n            "+(null==(__t=t.date.format("MMM DD, YYYY"))?"":__t)+":  \n            "+(null==(__t=t.action)?"":__t)+"\n            ("+(null==(__t=LT.utils.translate("chamber",t.actor))?"":__t)+")\n          </div>\n        "),__p+=" \n      "}),__p+="\n    </div>\n  </div>\n\n  ",bill.sponsors.length>1&&(__p+='\n    <div class="sponsors co-sponsors clear-block">\n      <h5>Co-Sponsors</h5>\n      \n      <div class="co-sponsors-inner clear-block">\n        ',_.each(bill.sponsors,function(t){__p+="\n          ","primary"!==t.type&&(__p+='\n            <div class="sponsor" data-leg-id="'+(null==(__t=t.leg_id)?"":__t)+'" data-sponsor-type="'+(null==(__t=t.type)?"":__t)+'">\n              '+(null==(__t=t.name)?"":__t)+" ("+(null==(__t=t.type)?"":__t)+")\n            </div>\n          "),__p+="\n        "}),__p+="\n      </div>\n    </div>\n  "),__p+="\n\n  ",_.isArray(bill.votes)&&bill.votes.length>0&&(__p+='\n    <div class="votes">\n      <h5>Votes</h5>\n      \n      <div class="votes-inner clear-block">\n        ',_.each(bill.votes,function(t){__p+="\n          "+(null==(__t=t.date.format("MMM DD, YYYY"))?"":__t)+":\n          "+(null==(__t=t.motion)?"":__t)+" "+(null==(__t=t.passed?"passed":"failed")?"":__t)+":\n          "+(null==(__t=t.yes_count)?"":__t)+" Y - \n          "+(null==(__t=t.no_count)?"":__t)+" N <br />\n        "}),__p+="\n      </div>\n    </div>\n  "),__p+='\n  \n  <div class="sources">\n    <h5>Sources</h5>\n    \n    ';var sourceCount=0;__p+="\n    ",_.each(bill.sources,function(t){sourceCount++,__p+='\n      <a href="'+(null==(__t=t.url)?"":__t)+'" target="_blank">\n        ',__p+=t.text?"\n          "+(null==(__t=t.text)?"":__t)+"\n        ":"\n          Source at "+(null==(__t=_.parseURL(t.url).hostname)?"":__t)+" ["+(null==(__t=sourceCount)?"":__t)+"]\n        ",__p+="\n      </a> <br />\n    "}),__p+="\n  </div>\n</div>"}return __p},function(t){LT.OSModel=Backbone.Model.extend({urlBase:function(){return"http://openstates.org/api/v1/"},urlEnd:function(){return"/?apikey="+encodeURI(LT.options.OSKey)+"&callback=?"},url:function(){return this.urlBase()+encodeURI(this.osType)+"/"+encodeURI(this.id)+this.urlEnd()},initialize:function(t,e){this.options=e,this.on("sync",function(t){t.set("fetched",!0)})}}),LT.OSStateModel=LT.OSModel.extend({url:function(){return this.urlBase()+"metadata/"+encodeURI(this.options.state)+this.urlEnd()}}),LT.OSBillModel=LT.OSModel.extend({url:function(){return _.isUndefined(this.id)?this.urlBase()+"bills/"+encodeURI(this.options.state)+"/"+encodeURI(this.options.session)+"/"+encodeURI(this.get("bill_id"))+this.urlEnd():this.urlBase()+"bills/"+this.id+this.urlEnd()},initialize:function(){LT.OSBillModel.__super__.initialize.apply(this,arguments),this.on("sync",function(){this.parseOSData()})},parseOSData:function(){var t;this.set("created_at",moment(this.get("created_at"))),this.set("updated_at",moment(this.get("updated_at"))),t=this.get("action_dates"),_.each(t,function(e,i){t[i]=e?moment(e):e}),this.set("action_dates",t),t=this.get("actions"),_.each(t,function(e,i){t[i].date=e.date?moment(e.date):e.date}),this.set("actions",t),t=this.get("votes"),_.each(t,function(e,i){t[i].date=e.date?moment(e.date):e.date}),this.set("votes",t),t=this.get("custom_events"),_.isArray(t)&&t.length>0&&this.set("actions",_.union(this.get("actions"),t)),this.set("actions",_.sortBy(this.get("actions"),function(t,e){return-1*(t.date.unix()+e)})),this.set("newest_action",this.get("actions")[0]),LT.options.osBillParse&&_.isFunction(LT.options.osBillParse)&&LT.options.osBillParse(this)},getActionDate:function(t){return this.get("action_dates")[t]?this.get("action_dates")[t]:!1},isSubstituted:function(){var t=!1;return _.isBoolean(this.get("substitued"))?t=this.get("substitued"):LT.options.substituteMatch===!1?t=!1:(t=_.find(this.get("actions"),function(t){return t.action.match(LT.options.substituteMatch)}),t=t?!0:!1,this.set("substitued",t)),t}}),LT.OSLegislatorModel=LT.OSModel.extend({osType:"legislators"}),LT.OSCommitteeModel=LT.OSModel.extend({osType:"committees"}),LT.BillModel=Backbone.Model.extend({initialize:function(t,e){this.options=e},loadOSBills:function(){var e=this,i=[];return _.each(["bill_primary","bill_companion","bill_conference"],function(t){e.get("hasBill")&&e.get(t)&&i.push(LT.utils.fetchModel(e.get(t)))}),t.when.apply(t,i)},loadOSCompanion:function(){var e,i=[];return this.get("hasBill")===!0&&!this.get("bill_companion")&&_.isObject(this.get("bill_primary"))&&_.isArray(this.get("bill_primary").get("companions"))&&_.isObject(this.get("bill_primary").get("companions")[0])&&(e=LT.parse.detectCompanionBill(this.get("bill_primary").get("companions")[0].bill_id),e&&(this.set("bill_companion",LT.utils.getModel("OSBillModel","bill_id",{bill_id:e})),i.push(LT.utils.fetchModel(this.get("bill_companion"))))),t.when.apply(t,i)},loadCategories:function(){this.get("categories")&&this.set("categories",_.map(this.get("categories"),function(t){return _.isObject(t)||(t=LT.utils.getModel("CategoryModel","id",{id:t})),t}))},lastUpdatedAt:function(){var t,e=this.get("bill_primary"),i=this.get("bill_companion"),l=this.get("bill_conference");return _.isUndefined(this.get("last_updated_at"))&&e.get("updated_at")?(t=e.get("updated_at"),i&&i.get("updated_at")&&(t=i.get("updated_at").unix()>t.unix()?i.get("updated_at"):t),l&&l.get("updated_at")&&(t=l.get("updated_at").unix()>t.unix()?l.get("updated_at"):t),this.set("last_updated_at",t)):_.isUndefined(this.get("last_updated_at"))&&!e.get("updated_at")&&LT.log("Could not fetch primary bill data from OpenStates. Check that the id "+this.get("bill_primary").get("bill_id")+" is formatted properly."),this.get("last_updated_at")},newestAction:function(){var t,e=this.get("bill_primary"),i=this.get("bill_companion"),l=this.get("bill_conference");return this.get("hasBill")&&_.isUndefined(this.get("newest_action"))&&e.get("newest_action")&&(t=e.get("newest_action"),i&&i.get("newest_action")&&(t=i.get("newest_action").date.unix()>t.date.unix()?i.get("newest_action"):t),l&&l.get("newest_action")&&(t=l.get("newest_action").date.unix()>t.date.unix()?l.get("newest_action"):t),this.set("newest_action",t)),this.get("newest_action")},parseMeta:function(){var t={upper:!1,lower:!1,conference:!1,signed:!1,last:!1},e={companion:this.get("bill_companion")?!0:!1,conference:this.get("bill_conference")?!0:!1};if(this.get("custom_events")&&this.set("custom_events",_.sortBy(this.get("custom_events"),function(t,e){return-1*(t.date.unix()+e)})),this.get("hasBill")){if(e.companion&&(this.get("bill_companion").isSubstituted()&&(e.substituted=!0),this.get("bill_primary").isSubstituted()&&(e.substituted=!0)),(!e.companion||e.substituted)&&(t.lower=this.get("bill_primary").getActionDate("passed_lower"),t.upper=this.get("bill_primary").getActionDate("passed_upper")),e.companion&&!e.substituted&&("upper"===this.get("bill_primary").get("chamber")?(t.upper=this.get("bill_primary").getActionDate("passed_upper"),t.lower=this.get("bill_companion").getActionDate("passed_lower")):(t.lower=this.get("bill_primary").getActionDate("passed_lower"),t.upper=this.get("bill_companion").getActionDate("passed_upper"))),e.conference){var i=this.get("bill_conference").getActionDate("passed_lower"),l=this.get("bill_conference").getActionDate("passed_upper");i&&l&&(t.conference=i.unix()>=l.unix()?i:l)}t.signed=e.conference?this.get("bill_conference").getActionDate("signed"):this.get("bill_primary").getActionDate("signed"),t.last=e.conference?this.get("bill_conference").getActionDate("last"):e.companion?this.get("bill_companion").getActionDate("last").unix()>=this.get("bill_primary").getActionDate("last").unix()?this.get("bill_companion").getActionDate("last"):this.get("bill_primary").getActionDate("last"):this.get("bill_primary").getActionDate("last"),this.get("description")||this.set("description",this.get("bill_primary").get("summary"))}return this.set("actions",t),this.set("bill_type",e),this}}),LT.CategoryModel=Backbone.Model.extend({initialize:function(t,e){this.options=e,this.set("bills",new LT.BillsCollection(null)),this.getBills()},getBills:function(){var t=this,e=LT.app.bills,i=this.get("id");return e.each(function(e){-1!==_.indexOf(e.get("categories"),i)&&t.get("bills").push(LT.utils.getModel("BillModel","bill",e.attributes))}),this},loadBills:function(e,i){var l=[],n=this;return this.get("bills").each(function(t){l.push(t.loadOSBills())}),t.when.apply(t,l).done(function(){var l=[];n.get("bills").each(function(t){l.push(t.loadOSCompanion())}),t.when.apply(t,l).done(function(){n.get("bills").each(function(t){t.parseMeta()}),e()}).fail(i)}).fail(i),this}})}(jQuery,window),function(){LT.CategoriesCollection=Backbone.Collection.extend({model:LT.CategoryModel,comparator:function(t){return-1!==t.get("title").toLowerCase().indexOf("recent")?"zzzzz":t.get("title")}}),LT.BillsCollection=Backbone.Collection.extend({model:LT.BillModel,comparator:function(t){var e=t.newestAction()?-1*t.newestAction().date.unix():t.get("title");return e}}),LT.OSBillsCollection=Backbone.Collection.extend({model:LT.OSBillModel,comparator:function(t){var e=t.get("newest_action");return e&&(e=-1*e.date.unix()),e}})}(jQuery,window),function(t,e){LT.MainApplicationView=Backbone.View.extend({initialize:function(){this.$el.addClass("ls"),this.templates=this.templates||{},LT.utils.getTemplate("template-loading",this.templates,"loading"),LT.utils.getTemplate("template-error",this.templates,"error"),LT.utils.getTemplate("template-ebill",this.templates,"ebill"),LT.utils.getTemplate("template-osbill",this.templates,"osbill"),LT.utils.getTemplate("template-category",this.templates,"category"),LT.utils.getTemplate("template-categories",this.templates,"categories"),LT.utils.getTemplate("template-header",this.templates,"header"),_.bindAll(this,"expandBill","expandOtherBills")},events:{"click .bill-expand":"expandBill","click .expand-other-bills":"expandOtherBills"},loading:function(){return _.isNumber(LT.options.scrollOffset)&&(this.initialLoad===!0?this.resetScrollView():this.initialLoad=_.isUndefined(this.initialLoad)?!1:!0),this.$el.html(this.templates.loading({})),this},error:function(t){return this.$el.html(this.templates.error({error:t})),this},renderCategories:function(){this.$el.html(this.templates.categories({categories:LT.app.categories.toJSON(),options:LT.options}))},renderCategory:function(t){_.isObject(t)||(t=LT.app.categories.get(t)),t.get("bills").sort(),this.$el.html(this.templates.category({category:t.toJSON(),templates:this.templates,header:this.renderHeader()})),this.getLegislators().navigationGlue()},renderEBill:function(t){_.isObject(t)||(t=this.router.bills.get(t)),t.newestAction(),this.$el.html(this.templates.ebill({bill:t.toJSON(),expandable:!1,templates:this.templates,header:this.renderHeader()})),this.getLegislators().addTooltips().checkOverflows().navigationGlue()},renderOSBill:function(t){this.$el.html(this.templates.osbill({bill:t.toJSON(),detailed:!0,templates:this.templates,header:this.renderHeader()})),this.getLegislators().addTooltips().checkOverflows().navigationGlue()},renderHeader:function(){return this.templates.header({categories:LT.app.categories.toJSON()})},expandBill:function(e){e.preventDefault();var i=t(e.target),l=["More detail","Less detail"],n=i.text();return i.text(n===l[0]?l[1]:l[0]),i.parent().parent().toggleClass("expanded").find(".bill-bottom").slideToggle(),this.checkOverflows(),this},expandOtherBills:function(e){e.preventDefault();var i=t(e.target),l=["Show other bills","Hide other bills"],n=i.text();return i.text(n===l[0]?l[1]:l[0]),i.parent().find(".has-conference-bill").toggleClass("showing").slideToggle(),this.checkOverflows(),this},getLegislators:function(){return this.$el.find(".sponsor:not(.found)").each(function(){var e=t(this),i=e.data();if(i.id=i.legId,i.id){var l=LT.utils.getModel("OSLegislatorModel","id",i);t.when(LT.utils.fetchModel(l)).then(function(){new LT.LegislatorView({el:e,model:l}).render()})}}),this},addTooltips:function(){return this.$el.find(".bill-progress .bill-progress-section.completed").qtip({style:{classes:"qtip-shadow qtip-light"},position:{my:"bottom center",at:"top center"}}),this},checkOverflows:function(){return this.$el.find(".actions-inner, .co-sponsors-inner").each(function(){t(this).hasScrollBar()&&t(this).addClass("overflowed")
}),this},resetScrollView:function(){return t("html, body").animate({scrollTop:this.$el.offset().top-LT.options.scrollOffset},1e3),this},navigationGlue:function(){var i=this.$el.offset().top,l=t(".ls-header");return t(".ls-header-container").height(l.outerHeight()),t(e).scroll(function(){var e=t(this);e.scrollTop()>i&&!l.hasClass("glued")?l.addClass("glued"):i>=e.scrollTop()&&l.hasClass("glued")&&l.removeClass("glued")}),this}}),LT.LegislatorView=Backbone.View.extend({model:LT.OSLegislatorModel,initialize:function(){this.templates=this.templates||{},LT.utils.getTemplate("template-legislator",this.templates,"legislator")},render:function(){return this.$el.addClass("found").html(this.templates.legislator(this.model.toJSON())),this}})}(jQuery,window),function(t){LT.Application=Backbone.Router.extend({routes:{categories:"routeCategories","category/recent":"routeRecentCategory","category/:category":"routeCategory","bill/:bill":"routeEBill","bill-detail/:bill":"routeOSBill","*defaultR":"routeDefault"},initialize:function(t){LT.options=_.extend(LT.defaultOptions,t),LT.app=this,_.bindAll(this,"loadEBills"),this.mainView=new LT.MainApplicationView(LT.options),this.mainView.router=this,this.mainView.loading(),this.tabletop=Tabletop.init(_.extend(LT.options.tabletopOptions,{key:LT.options.eKey,callback:this.loadEBills,callbackContext:this,wanted:LT.options.sheetsWanted}))},loadEBills:function(e,i){var l=this,n=LT.parse.eData(i);this.categories=new LT.CategoriesCollection(null),this.bills=new LT.BillsCollection(null),_.each(n.bills,function(t){l.bills.add(LT.utils.getModel("BillModel","bill",t))}),_.each(n.categories,function(t){l.categories.add(LT.utils.getModel("CategoryModel","id",t))}),this.bills.each(function(t){t.loadCategories()}),LT.options.aggregateURL?t.getJSON(LT.options.aggregateURL).done(this.loadAggregateCounts):this.start()},loadAggregateCounts:function(t){var e=this;_.each(t,function(t){"total-bills"===t.stat&&(e.totalBills=parseInt(t.value,10)),"total-bills-passed"===t.stat&&(e.totalBillsPassed=parseInt(t.value,10)),"total-bills-signed"===t.stat&&(e.totalBillsSigned=parseInt(t.value,10))}),this.start()},start:function(){Backbone.history.start()},routeDefault:function(){this.navigate("/categories",{trigger:!0,replace:!0}),this.mainView.render()},routeCategories:function(){var t=this;this.mainView.loading(),this.getOSBasicBills(function(){t.makeRecentCategory(),t.mainView.renderCategories()},this.error)},routeCategory:function(t){var e=this;t=decodeURI(t),t=this.categories.get(t),this.mainView.loading(),t.loadBills(function(){e.mainView.renderCategory(t)},e.error)},routeRecentCategory:function(){var t=this;this.mainView.loading(),this.getOSBasicBills(function(){t.makeRecentCategory();var e=t.categories.get("recent");e.loadBills(function(){t.mainView.renderCategory(e)},t.error)},this.error)},routeEBill:function(t){var e=this,i=decodeURI(t);return(t=this.bills.where({bill:i})[0])?(this.mainView.loading(),t.loadOSBills().done(function(){t.loadOSCompanion().done(function(){t.parseMeta(),e.mainView.renderEBill(t)})}).fail(e.error),undefined):(this.navigate("/bill-detail/"+encodeURI(i),{trigger:!0,replace:!0}),undefined)},routeOSBill:function(e){var i=this;e=decodeURI(e),e=LT.utils.getModel("OSBillModel","bill_id",{bill_id:e}),this.mainView.loading(),t.when.apply(t,[LT.utils.fetchModel(e)]).done(function(){i.mainView.renderOSBill(e)}).fail(i.error)},makeRecentCategory:function(){if(!this.madeRecentCategory){var t={id:"recent",title:"Recent Actions",description:"The following bills have been updated in the past "+LT.options.recentChangeThreshold+" days.",image:LT.options.recentImage};this.bills.each(function(e){var i=e.get("categories"),l=e.get("hasBill");l===!0&&Math.abs(parseInt(e.lastUpdatedAt().diff(moment(),"days"),10))<LT.options.recentChangeThreshold&&(i.push(t.id),e.set("categories",i))}),this.categories.add(LT.utils.getModel("CategoryModel","id",t)),this.bills.each(function(t){t.loadCategories()}),this.madeRecentCategory=!0}},getOSBasicBills:function(e){var i=this,l=[];if(this.fetchedCategories)e.call(i);else{this.bills.each(function(t){_.each(["bill_primary","bill_companion","bill_conference"],function(e){t.get(e)&&l.push(t.get(e).get("bill_id"))})});var n="http://openstates.org/api/v1/bills/?state="+LT.options.state+"&search_window=session:"+LT.options.session+"&bill_id__in="+encodeURI(l.join("|"))+"&apikey="+LT.options.OSKey+"&callback=?";t.getJSON(n).done(function(t){i.fetchedCategories=!0,_.each(t,function(t){t.created_at=moment(t.created_at),t.updated_at=moment(t.updated_at),LT.utils.getModel("OSBillModel","bill_id",t).set(t)}),e.call(i)}).fail(this.error)}},error:function(t){this.mainView.error(t)}})}(jQuery,window);