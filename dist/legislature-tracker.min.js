/*! legislature-tracker - v0.1.0 - 2014-03-25
* https://github.com/MinnPost/legislature-tracker
* Copyright (c) 2014 ; Licensed MIT */

(function(t,e){if("undefined"!=typeof module&&module.exports&&"function"==typeof require)e(require("underscore"),require("jquery"),require("backbone"),require("moment"),require("tabletop"),require("ractive"));else if("function"==typeof define&&define.amd)define("LT",["underscore","jquery","backbone","moment","tabletop","Ractive"],e);else{if(!(t._&&t.jQuery&&t.Backbone&&t.moment&&t.Tabletop))throw Error("Could not find dependencies for Legislature Tracker.");t.LT=e(t._,t.jQuery,t.Backbone,t.moment,t.Tabletop,t.Ractive)}})("undefined"!=typeof window?window:this,function(t,e,i,n,s,l){var a,o={};return this.LTTemplates={"template-application":'<div class="ls">\n\n  {{#(menuOff !== true && !!categories)}}\n    <div class="ls-header-container">\n      <div class="ls-header">\n\n        <a class="all-categories-link" href="#/">\n          <img src="{{ options.imagePath }}back-100-85.png" />\n          All Categories\n        </a>\n\n        <span class="categories-nav">\n          &nbsp;&nbsp;|&nbsp;&nbsp;\n\n          {{#categories}}\n            <a class="" href="#/category/{{ id }}" title="{{ title }}">\n              {{ (short_title) ? short_title : title.split(\' \')[0] }}\n            </a>\n            &nbsp;&nbsp;\n          {{/categories}}\n        </span>\n      </div>\n    </div>\n  {{/()}}\n\n  {{#options.title}}\n    <h2>{{ options.title }}</h2>\n  {{/options.title}}\n\n  <div class="ls-content-container">\n    {{>loading}}\n  </div>\n</div>\n',"template-categories":'\n{{^categories}}\n  {{>loading}}\n{{/categories}}\n\n<div class="categories-container">\n  <ul class="category-list clear-block">\n    {{#categories:i}}\n      <li class="category-item category-item-{{ i }}">\n        <div class="category-inner category-{{ _.cssClass(id) }}">\n          {{#image}}\n            <a href="#/category/{{ encodeURI(id) }}">\n              <img class="category-image" src="{{ imagePath(image) }}" />\n            </a>\n          {{/image}}\n\n          <h3>\n            <a href="#/category/{{ encodeURI(id) }}">\n              {{ title }}\n            </a>\n          </h3>\n\n          <div>\n            Watching <strong>{{ bills.length }}</strong> bills.\n          </div>\n        </div>\n      </li>\n    {{/categories}}\n  </ul>\n</div>',"template-category":'\n{{^category}}\n  {{>loading}}\n{{/category}}\n\n<div class="category-container">\n  <h2>\n    {{#category.image}}\n      <img class="category-image" src="{{ imagePath(category.image) }}" />\n    {{/category.image}}\n\n    {{ category.title }}\n  </h2>\n\n  <p class="category-description">{{ category.description }}</p>\n\n  {{#(category.links && category.links.length && category.links.length > 0)}}\n    <div class="elinks">\n      <strong>In the news</strong>\n      <ul class="elinks-list">\n        {{#category.links}}\n          <li><a href="{{ url }}">{{ title }}</a></li>\n        {{/category.links}}\n      </ul>\n    </div>\n  {{/()}}\n\n  <div class="clear-block bills-list">\n    {{#category.bills:bill}}\n      <ebill bill="{{ this }}" compact="true" imagePath="{{ imagePath }}" options="{{ options }}">\n    {{/category.bills}}\n  </div>\n\n  <div class="clear-block total-bill">\n    Watching\n    <strong>{{ category.bills.length }}</strong>\n    {{#(typeof category.total_bill_count != \'undefined\')}}\n      of {{ category.total_bill_count }}\n    {{/()}}\n    bills in the {{ category.title }} category.\n  </div>\n</div>\n',"template-ebill":'\n<div class="bill ebill {{^bill.hasBill}}no-bill{{/bill.hasBill}}">\n  <div class="bill-status">\n    <img\n      class="lower {{#(bill.newest_action && Math.abs(parseInt(bill.newest_action.date.diff(moment(), \'days\'))) < options.recentChangeThreshold)}}passed{{/()}}"\n      src="{{ imagePath(\'RecentChanges.png\') }}"\n      title="{{#(bill.newest_action && Math.abs(parseInt(bill.newest_action.date.diff(moment(), \'days\'))) < options.recentChangeThreshold)}}Recently changed{{/()}}\n      {{^(bill.newest_action && Math.abs(parseInt(bill.newest_action.date.diff(moment(), \'days\'))) < options.recentChangeThreshold)}}Not changed recently{{/()}}"\n     />\n\n    <img\n      class="lower {{#(bill.actions && bill.actions.lower)}}passed{{/()}}"\n      src="{{ imagePath(\'PassedHouse.png\') }}"\n      title="{{#(bill.actions && bill.actions.lower)}}Passed{{/()}}\n        {{^(bill.actions && bill.actions.lower)}}Not passed{{/()}} {{ translate(\'chamber\', \'lower\') }}"\n     />\n\n    <img\n      class="upper {{#(bill.actions && bill.actions.upper)}}passed{{/()}}"\n      src="{{ imagePath(\'PassedSenate.png\') }}"\n      title="{{#(bill.actions && bill.actions.upper)}}Passed{{/()}}\n        {{^(bill.actions && bill.actions.upper)}}Not passed{{/()}} {{ translate(\'chamber\', \'upper\') }}"\n     />\n\n    {{#options.conferenceBill}}\n      <img\n        class="conference {{#(bill.bill_type && bill.bill_type.conference)}}passed{{/()}}"\n        src="{{ imagePath(\'InConferenceCommittee.png\') }}"\n        title="{{#(bill.bill_type && bill.bill_type.conference)}}Conference bill created{{/()}}\n          {{^(bill.bill_type && bill.bill_type.conference)}}Coinference bill not created{{/()}}"\n       />\n    {{/options.conferenceBill}}\n\n   <img\n     class="signed {{#(bill.actions && bill.actions.signed)}}passed{{/()}}"\n     src="{{ imagePath(\'SignedIntoLaw.png\') }}"\n     title="{{#(bill.actions && bill.actions.signed)}}Signed into law by the Governor{{/()}}\n       {{^(bill.actions && bill.actions.upper)}}Not signed into law{{/()}}"\n    />\n  </div>\n\n  {{#compact}}\n    <h3>\n      {{ bill.title }}\n      <a class="permalink" title="Permanent link to bill" href="#/bill/{{ encodeURI(bill.bill) }}"></a>\n    </h3>\n  {{/compact}}\n  {{^compact}}\n    <h2>{{ bill.title }}</h2>\n  {{/compact}}\n\n  {{^bill.hasBill}}\n    <div class="latest-action">\n      <em>This bill has not been tracked by the legislature yet.</em>\n    </div>\n  {{/bill.hasBill}}\n\n  {{#bill.newest_action}}\n    <div class="latest-action">Last action about {{ date.fromNow() }}: {{ action }}.</div>\n  {{/bill.newest_action}}\n\n  <div class="description">\n    {{ bill.description }}\n  </div>\n\n  <div class="ebill-categories">\n    <strong>Categories:</strong>\n    {{#bill.categories:i}}\n      <a href="#/category/{{ id }}">\n        {{#image}}\n          <img class="category-image" src="{{ imagePath(image) }}" />\n        {{/image}}\n        {{ title }}\n      </a>{{#(i < bill.categories.length - 1)}},{{/()}}\n    {{/bill.categories}}\n  </div>\n\n  {{#(bill.links && bill.links.length && bill.links.length > 0)}}\n    <div class="elinks">\n      <strong>In the news</strong>\n      <ul class="elinks-list">\n        {{#bill.links}}\n          <li><a href="{{ url }}">{{ title }}</a></li>\n        {{/bill.links}}\n      </ul>\n    </div>\n  {{/()}}\n\n\n  {{#(compact == true)}}\n    <div class="ebill-sponsors clear-block">\n      {{#bill.bill_conference}}\n        <div class="osbill bill-conference">\n          <strong>Conference bill {{ bill_id }}</strong>\n          {{#sponsors}}\n            <sponsor sponsor="{{ this }}" compact="true" primary="true">\n          {{/sponsors}}\n        </div>\n      {{/bill.bill_conference}}\n\n      {{#bill.bill_primary}}\n        <div class="osbill bill-primary">\n          <strong>Primary bill {{ bill_id }}</strong>\n          {{#sponsors}}\n            <sponsor sponsor="{{ this }}" compact="true" primary="true">\n          {{/sponsors}}\n        </div>\n      {{/bill.bill_primary}}\n    </div>\n  {{/()}}\n\n\n  {{#(compact != true)}}\n    {{#(bill.custom_events && bill.custom_events.length && bill.custom_events.length > 0)}}\n      <div class="custom-events">\n        <strong>Events</strong>\n        <ul class="custom-events-inner">\n          {{#bill.custom_events}}\n            <li><strong>{{ bill_id }} {{ action }}</strong> on  {{ date.format(\'MMM DD, YYYY\') }}: {{ e.description }}</li>\n          {{/bill.custom_events}}\n        </ul>\n      </div>\n    {{/()}}\n\n    {{#bill.bill_conference}}\n      <div class="conference-bill">\n        <div class="conference-bill-inner clear-block">\n          <h3>Conference Bill</h3>\n          <osbill bill="{{ this }}" type="conference" imagePath="{{ imagePath }}" translate="{{ translate }}" options="{{ options }}">\n        </div>\n      </div>\n    {{/bill.bill_conference}}\n\n    {{#bill.bill_primary}}\n      <div class="primary-bill">\n        <div class="primary-bill-inner clear-block">\n          <h3>{{ (options.chamberLabel) ? translate(\'chamber\', chamber) + \' Bill\' : \'Primary Bill\' }}</h3>\n          <osbill bill="{{ this }}" type="primary" imagePath="{{ imagePath }}" translate="{{ translate }}" options="{{ options }}">\n        </div>\n      </div>\n    {{/bill.bill_primary}}\n\n    {{#bill.bill_companion}}\n      <div class="companion-bill">\n        <div class="companion-bill-inner clear-block">\n          <h3>{{ (options.chamberLabel) ? translate(\'chamber\', chamber) + \' Bill\' : \'Companion Bill\' }}</h3>\n          <osbill bill="{{ this }}" type="companion" imagePath="{{ imagePath }}" translate="{{ translate }}" options="{{ options }}">\n        </div>\n      </div>\n    {{/bill.bill_companion}}\n  {{/()}}\n\n</div>\n',"template-error":'<div class="error-container">\n  <div class="error"><span>There was an error.</span></div>\n</div>',"template-legislator":"\n<div class=\"legislator\">\n  <% if (LT.options.legImageProxy) { %>\n    <img src=\"<%= LT.options.legImageProxy %><%= encodeURI(photo_url) %>\" />\n  <% } else { %>\n    <img src=\"<%= photo_url %>\" />\n  <% } %>\n  \n  <div class=\"legislator-info\">\n    <%= full_name %><br />\n    <% if (typeof district != 'undefined') { %>\n      District <%= district %>\n    <% } %>\n    <% if (typeof party != 'undefined') { %>\n      (<%= LT.utils.translate('partyAbbr', party) %>) \n    <% } %> <br />\n    <% if (typeof chamber != 'undefined') { %>\n      <%= LT.utils.translate('chamber', chamber) %>\n    <% } %>\n  </div>\n</div>","template-loading":'<div class="loading-general-container">\n  <div class="loading-general"><span>Loading...</span></div>\n</div>',"template-osbill":'\n<div class="osbill">\n  <h4>\n    {{#(!!bill.title)}}\n      {{ bill.title }} ({{ bill.bill_id }})\n    {{/()}}\n\n    {{^(!!bill.title)}}\n      {{ bill.bill_id }}\n    {{/()}}\n  </h4>\n  <div class="sponsors primary-sponsors">\n    <h5>Primary sponsors</h5>\n\n    <div class="clear-block">\n      {{#bill.sponsors}}\n        {{#(type === \'primary\')}}\n          <div class="sponsor" data-leg-id="{{ leg_id }}" data-sponsor-type="{{ type }}">\n            {{ name }} ({{ type }})\n          </div>\n        {{/()}}\n      {{/bill.sponsors}}\n    </div>\n  </div>\n\n  <div class="actions">\n    <h5><span class="latest-action-label">Latest</span> Actions</h5>\n\n    <div class="actions-inner">\n      {{#bill.actions}}\n        {{#(!!date)}}\n          <div>\n            {{ date.format(\'MMM DD, YYYY\') }}:\n            {{ action }}\n            ({{ translate(\'chamber\', actor) }})\n          </div>\n        {{/())}}\n      {{/bill.actions}}\n    </div>\n  </div>\n\n  {{#(bill.sponsors && bill.sponsors.length && bill.sponsors.length)}}\n    <div class="sponsors co-sponsors clear-block">\n      <h5>Co-Sponsors</h5>\n\n      <div class="co-sponsors-inner clear-block">\n        {{#bill.sponsors}}\n          {{#(type !== \'primary\')}}\n            <div class="sponsor" data-leg-id="{{ leg_id }}" data-sponsor-type="{{ type }}">\n              {{ name }} ({{ type }})\n            </div>\n          {{/()}}\n        {{/bill.sponsors}}\n      </div>\n    </div>\n  {{/()}}\n\n  {{#(bill.votes && bill.votes.length && bill.votes.length > 0)}}\n    <div class="votes">\n      <h5>Votes</h5>\n\n      <div class="votes-inner clear-block">\n        {{#bill.votes}}\n          {{ date.format(\'MMM DD, YYYY\') }}\n          {{ motion }} {{ (passed) ? \'passed\' : \'failed\' }}\n          {{ yes_count }} Y -\n          {{ no_count }} N <br />\n        {{/bill.votes}}\n      </div>\n    </div>\n  {{/()}}\n\n  <div class="sources">\n    <h5>Sources</h5>\n\n    {{#bill.sources}}\n      <a href="{{ url }}" target="_blank">\n        {{#(!!text)}}\n          {{ text }}\n        {{/()}}\n        {{#(!text)}}\n          {{ url }}\n        {{/()}}\n      </a> <br />\n    {{/bill.sources}}\n  </div>\n</div>\n',"template-sponsor":"\n{{#(primary == true && sponsor.type === 'primary')}}\n  <div class=\"sponsor\">\n    {{ sponsor.name }} ({{ sponsor.type }})\n  </div>\n{{/()}}\n"},t.mixin({filterEmpty:function(e){return t.filter(e,function(t){return t})},filterObject:function(e,i,n){return t.reduce(e,function(t,s,l){return i.call(n,s,l,e)&&(t[l]=s),t},{},n)},mapObject:function(e,i,n){return t.reduce(e,function(t,s,l){return t[l]=i.call(n,s,l,e),t},{},n)},trim:function(e){return t.isString(e)&&(e=String.prototype.trim?e.trim():e.replace(/^\s+|\s+$/g,"")),e},cssClass:function(t){return t.replace(/[^a-z0-9]/g,"-")},numberFormatCommas:function(t){return(""+t).replace(/\B(?=(\d{3})+(?!\d))/g,",")},ellipsisText:function(t,e){var i,n,s,l,a="",o="<!-- break -->",r='<ins class="ellipsis-start">[[[TEXT]]]</ins>',c='<ins class="ellipsis-ellipsis">...</ins>',p='<ins class="ellipsis-end">[[[TEXT]]]</ins>';return-1!==t.indexOf(o)?(i=t.indexOf(o),a+=r.replace("[[[TEXT]]]",t.substring(0,i))+" ",a+=c+" ",a+=p.replace("[[[TEXT]]]",t.substring(i,t.length))+" "):(l=t.split(" "),e>=l.length?a+=r.replace("[[[TEXT]]]",t):(n=l.slice(0,e),s=l.slice(e),a+=r.replace("[[[TEXT]]]",n.join(" "))+" ",a+=c+" ",a+=p.replace("[[[TEXT]]]",s.join(" "))+" ")),a},parseURL:function(t){var e=document.createElement("a");return e.href=t,e}}),i.ajax=function(){var t=arguments;return t[0].dataTypeForce!==!0&&(t[0].dataType="jsonp"),i.$.ajax.apply(i.$,t)},e.fn.hasScrollBar=function(){return this.get(0)&&this.get(0).scrollHeight?this.get(0).scrollHeight>this.height():!1},o.parsers=o.parsers||{},o.log=function(e){t.isObject(console)&&t.isFunction(console.log)&&console.log(e)},o.parsers.eData=function(e,i){var n={},s=e.sheets("Bills").all();return s.length>i.maxBills&&o.log("The number of bills in your spreadsheet exceeds maxBills. Set the maxBills option to display them, but be aware that this may significantly slow down the Legislature Tracker."),n.categories=o.parsers.eCategories(e.sheets("Categories").all(),i),n.bills=o.parsers.eBills(s.slice(0,i.maxBills),i),n.events=o.parsers.eEvents(e.sheets("Events").all(),i),t.each(t.groupBy(n.events,"bill_id"),function(e,i){t.each(n.bills,function(t,s){t.bill===i&&(n.bills[s].custom_events=e)})}),n},o.parsers.validateBillNumber=function(t,e){return e.billNumberFormat.test(t)},o.parsers.eBills=function(e,i){return t.map(e,function(e){return o.parsers.translateFields(i.fieldTranslations.eBills,e),e.links=o.parsers.eLinks(e.links),e.categories=e.categories?e.categories.split(","):[],e.categories=t.map(e.categories,t.trim),e.bill_primary=t.trim(e.bill),e.bill&&!o.parsers.validateBillNumber(e.bill,i)&&o.log('Invalid primary bill number "'+e.bill+'" for row '+e.rowNumber+", see documentation."),e.bill_companion=t.trim(e.bill_companion),e.bill_companion&&!o.parsers.validateBillNumber(e.bill_companion,i)&&o.log('Invalid companion bill number "'+e.bill_companion+'" for row '+e.rowNumber+", see documentation."),e.bill_conference=t.trim(e.bill_conference),e.bill_conference&&!o.parsers.validateBillNumber(e.bill_conference,i)&&o.log('Invalid conference bill number "'+e.bill_conference+'" for row '+e.rowNumber+", see documentation."),e.hasBill=!0,e.bill&&e.bill_primary||(e.hasBill=!1,e.bill=t.cssClass(e.title.toLowerCase())),e})},o.parsers.eCategories=function(e,i){return t.map(e,function(t){return o.parsers.translateFields(i.fieldTranslations.eCategories,t),t.links=o.parsers.eLinks(t.links),t})},o.parsers.eEvents=function(e,i){return t.map(e,function(t){return o.parsers.translateFields(i.fieldTranslations.eEvents,t),t.links=o.parsers.eLinks(t.links),t.date=n(t.date),t.type=["custom"],t})},o.parsers.eLinks=function(e){var i=[];return e=t.trim(e),0===e.length?i:(e='"'===e.substring(0,1)?e.substring(1):e,e='"'===e.substring(e.length-1,e.length)?e.slice(0,-1):e,i=e.split('", "'),i=t.map(i,function(t){return{title:t.split("|")[0],url:t.split("|")[1]}}))},o.parsers.csvCategories=function(e){return e=t.trim(e),0===e.length?[]:(e='"'===e.substring(0,1)?e.substring(1):e,e='"'===e.substring(e.length-1,e.length)?e.slice(0,-1):e,e.split('", "'))},o.parsers.detectCompanionBill=function(e,i){var n,s;return t.isFunction(i.detectCompanionBill)?(n=i.detectCompanionBill(e),s=o.parsers.validateBillNumber(n,i)?n:void 0):t.isRegExp(i.detectCompanionBill)&&(n=i.detectCompanionBill.exec(e),s=n&&o.parsers.validateBillNumber(n[1],i)?n[1]:void 0),t.trim(s)},o.parsers.translateFields=function(e,i){return t.each(e,function(t,e){i[e]=i[t],e!==t&&delete i[t]}),i},o.BaseModel=i.Model.extend({initialize:function(t,e){this.options=e,this.app=this.options.app,this.on("sync",function(t){t.set("fetched",!0)})}}),o.OSModel=o.BaseModel.extend({urlBase:function(){return"http://openstates.org/api/v1/"},urlEnd:function(){return"/?apikey="+encodeURI(this.options.app.options.OSKey)+"&callback=?"},url:function(){return this.urlBase()+encodeURI(this.osType)+"/"+encodeURI(this.id)+this.urlEnd()},initialize:function(){o.OSModel.__super__.initialize.apply(this,arguments)}}),o.OSStateModel=o.OSModel.extend({url:function(){return this.urlBase()+"metadata/"+encodeURI(this.options.state)+this.urlEnd()}}),o.OSBillModel=o.OSModel.extend({url:function(){return t.isUndefined(this.id)?t.isUndefined(this.get("bill_id"))||""===this.get("bill_id")?void 0:this.urlBase()+"bills/"+encodeURI(this.options.app.options.state)+"/"+encodeURI(this.options.app.options.session)+"/"+encodeURI(this.get("bill_id"))+this.urlEnd():this.urlBase()+"bills/"+this.id+this.urlEnd()},initialize:function(){o.OSBillModel.__super__.initialize.apply(this,arguments)},parse:function(e){return e.created_at=n(e.created_at),e.updated_at=n(e.updated_at),e.action_dates=t.filterObject(e.action_dates,function(t){return t}),e.action_dates=t.mapObject(e.action_dates,function(t){return n(t)}),e.actions=t.mapObject(e.actions,function(t){return t.date=n(t.date),t}),e.votes=t.mapObject(e.votes,function(t){return t.date=n(t.date),t}),this.get("custom_events")&&(e.actions=t.union(e.actions,this.get("custom_events"))),e.actions=t.sortBy(e.actions,function(t,e){return-1*(t.date.unix()+e)}),e.newest_action=e.actions[0],this.options.app.options.osBillParse&&t.isFunction(this.options.app.options.osBillParse)&&(e=this.options.osBillParse(e,this)),e},getActionDate:function(t){return this.get("action_dates")[t]?this.get("action_dates")[t]:!1},isSubstituted:function(){var e=!1,i=this;return t.isBoolean(this.get("substitued"))?e=this.get("substitued"):this.options.substituteMatch===!1?e=!1:(e=t.find(this.get("actions"),function(t){return t.action.match(i.options.substituteMatch)}),e=e?!0:!1,this.set("substitued",e)),e}}),o.OSLegislatorModel=o.OSModel.extend({osType:"legislators"}),o.OSCommitteeModel=o.OSModel.extend({osType:"committees"}),o.BillModel=o.BaseModel.extend({subbills:["bill_primary","bill_companion","bill_conference"],initialize:function(){o.BillModel.__super__.initialize.apply(this,arguments),this.loadOSBills()},loadOSBills:function(){var e=this;t.each(this.subbills,function(t){e.get(t)&&e.set(t,e.app.getModel("OSBillModel","bill_id",{bill_id:e.get(t)}))})},getOSBills:function(){var e=this;return t.filterEmpty(t.map(this.subbills,function(t){return e.get(t)}))},getOSBillIDs:function(){var e=this.getOSBills();return t.filterEmpty(t.map(e,function(e){return t.isObject(e)?e.get("bill_id"):e}))},fetchOSBills:function(){var i=this,n=[];return this.getCategories(),t.each(this.subbills,function(t){i.get("hasBill")&&i.get(t)&&n.push(i.options.app.fetchModel(i.get(t)))}),e.when.apply(e,n).done(function(){i.loadOSCompanion().done(function(){i.parseMeta(),i.lastUpdatedAt(),i.newestAction(),i.trigger("fetched:osbills")})})},loadOSCompanion:function(){var i,n=this,s=[];return this.get("hasBill")===!0&&!this.get("bill_companion")&&t.isObject(this.get("bill_primary"))&&t.isArray(this.get("bill_primary").get("companions"))&&t.isObject(this.get("bill_primary").get("companions")[0])&&(i=o.parse.detectCompanionBill(this.get("bill_primary").get("companions")[0].bill_id),i&&(this.set("bill_companion",n.options.app.getModel("OSBillModel","bill_id",{bill_id:i})),s.push(n.options.app.fetchModel(this.get("bill_companion"))))),e.when.apply(e,s)},getCategories:function(){var e=this;this.get("categories")&&this.set("categories",t.map(this.get("categories"),function(i){return t.isObject(i)||(i=e.options.app.getModel("CategoryModel","id",{id:i})),i}))},lastUpdatedAt:function(){var e,i=this.get("bill_primary"),n=this.get("bill_companion"),s=this.get("bill_conference");return t.isUndefined(this.get("last_updated_at"))&&i.get("updated_at")?(e=i.get("updated_at"),n&&n.get("updated_at")&&(e=n.get("updated_at").unix()>e.unix()?n.get("updated_at"):e),s&&s.get("updated_at")&&(e=s.get("updated_at").unix()>e.unix()?s.get("updated_at"):e),this.set("last_updated_at",e)):t.isUndefined(this.get("last_updated_at"))&&!i.get("updated_at")&&o.log("Could not fetch primary bill data from OpenStates. Check that the id "+this.get("bill_primary").get("bill_id")+" is formatted properly."),this.get("last_updated_at")},newestAction:function(){var e,i=this.get("bill_primary"),n=this.get("bill_companion"),s=this.get("bill_conference");return this.get("hasBill")&&t.isUndefined(this.get("newest_action"))&&i.get("newest_action")&&(e=i.get("newest_action"),n&&n.get("newest_action")&&(e=n.get("newest_action").date.unix()>e.date.unix()?n.get("newest_action"):e),s&&s.get("newest_action")&&(e=s.get("newest_action").date.unix()>e.date.unix()?s.get("newest_action"):e),this.set("newest_action",e)),this.get("newest_action")},parseMeta:function(){var e={upper:!1,lower:!1,conference:!1,signed:!1,last:!1},i={companion:this.get("bill_companion")?!0:!1,conference:this.get("bill_conference")?!0:!1};if(this.get("custom_events")&&this.set("custom_events",t.sortBy(this.get("custom_events"),function(t,e){return-1*(t.date.unix()+e)})),this.get("hasBill")){if(i.companion&&(this.get("bill_companion").isSubstituted()&&(i.substituted=!0),this.get("bill_primary").isSubstituted()&&(i.substituted=!0)),(!i.companion||i.substituted)&&(e.lower=this.get("bill_primary").getActionDate("passed_lower"),e.upper=this.get("bill_primary").getActionDate("passed_upper")),i.companion&&!i.substituted&&("upper"===this.get("bill_primary").get("chamber")?(e.upper=this.get("bill_primary").getActionDate("passed_upper"),e.lower=this.get("bill_companion").getActionDate("passed_lower")):(e.lower=this.get("bill_primary").getActionDate("passed_lower"),e.upper=this.get("bill_companion").getActionDate("passed_upper"))),i.conference){var n=this.get("bill_conference").getActionDate("passed_lower"),s=this.get("bill_conference").getActionDate("passed_upper");n&&s&&(e.conference=n.unix()>=s.unix()?n:s)}e.signed=i.conference?this.get("bill_conference").getActionDate("signed"):this.get("bill_primary").getActionDate("signed"),e.last=i.conference?this.get("bill_conference").getActionDate("last"):i.companion?this.get("bill_companion").getActionDate("last").unix()>=this.get("bill_primary").getActionDate("last").unix()?this.get("bill_companion").getActionDate("last"):this.get("bill_primary").getActionDate("last"):this.get("bill_primary").getActionDate("last"),this.get("description")||this.set("description",this.get("bill_primary").get("summary"))}return this.set("actions",e),this.set("bill_type",i),this}}),o.CategoryModel=o.BaseModel.extend({initialize:function(){o.CategoryModel.__super__.initialize.apply(this,arguments),this.set("bills",new o.BillsCollection(null))},getBills:function(e){var i=this,n=this.get("id");return e.each(function(e){-1!==t.indexOf(e.get("categories"),n)&&i.get("bills").push(i.app.getModel("BillModel","bill",e.attributes))}),this}}),o.CategoriesCollection=i.Collection.extend({model:o.CategoryModel,comparator:function(t){return-1!==t.get("title").toLowerCase().indexOf("recent")?"zzzzz":t.get("title")}}),o.BillsCollection=i.Collection.extend({model:o.BillModel,comparator:function(t){var e=t.newestAction()?-1*t.newestAction().date.unix():t.get("title");return e}}),o.OSBillsCollection=i.Collection.extend({model:o.OSBillModel,comparator:function(t){var e=t.get("newest_action");return e&&(e=-1*e.date.unix()),e}}),o.BaseView=l.extend({baseInit:function(t){this.options=t.options,this.app=t.app,this.router=t.router},adaptors:["Backbone"]}),o.ApplicationView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.CategoriesView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.CategoryView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.EBillView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.OSBillView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.OSSponsorView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.MainRouter=i.Router.extend({routes:{categories:"routeCategories","category/recent":"routeRecentCategory","category/:category":"routeCategory","bill/:bill":"routeEBill","*defaultR":"routeDefault"},initialize:function(t){t.router=this,this.options=t,this.app=t.app,this.app.views.application=new o.ApplicationView({el:this.app.$el,template:this.app.templates.application,data:{options:this.options,categories:this.app.categories},options:this.options,partials:{loading:this.app.templates.loading}}),this.$content=this.app.$el.find(".ls-content-container")},start:function(){i.history.start()},routeDefault:function(){this.navigate("/categories",{trigger:!0,replace:!0})},routeCategories:function(){this.app.fetchBasicBillData(),this.app.views.application.set("menuOff",!0),this.app.views.categories=new o.CategoriesView({el:this.$content,template:this.app.templates.categories,data:{options:this.options,categories:this.app.categories,imagePath:t.bind(this.app.imagePath,this.app)},options:this.options,partials:{loading:this.app.templates.loading}})},routeCategory:function(e){var i=this,n=decodeURI(e);e=this.app.categories.get(n),this.app.views.application.set("menuOff",!1),e||this.navigate("/",{trigger:!0,replace:!0}),this.app.fetchOSBillsFromCategory(e),this.app.views.category=new o.CategoryView({el:this.$content,template:this.app.templates.category,data:{options:this.options,category:e,categoryID:n,imagePath:t.bind(this.app.imagePath,this.app),translate:t.bind(this.app.translate,this.app)},options:this.options,partials:{loading:this.app.templates.loading},components:{ebill:o.EBillView.extend({template:this.app.templates.ebill,components:{osbill:o.OSBillView.extend({template:this.app.templates.osbill}),sponsor:o.OSSponsorView.extend({template:this.app.templates.sponsor})}})}}),this.app.on("fetched:osbills:category:"+e.id,function(){i.app.views.category.update()})},routeRecentCategory:function(){this.app.fetchBasicBillData(),this.routeCategory("recent")},routeEBill:function(e){var i=this,n=decodeURI(e);e=this.app.bills.where({bill:n})[0],this.app.views.application.set("menuOff",!1),e||this.navigate("/",{trigger:!0,replace:!0}),e.fetchOSBills(),this.app.views.bill=new o.EBillView({el:this.$content,template:this.app.templates.ebill,data:{options:this.options,bill:e,billID:n,imagePath:t.bind(this.app.imagePath,this.app),translate:t.bind(this.app.translate,this.app)},options:this.options,partials:{loading:this.app.templates.loading},components:{osbill:o.OSBillView.extend({template:this.app.templates.osbill})}}),e.on("fetched:osbills",function(){i.app.views.bill.update()})},error:function(){}}),a=function(i){this.options=t.extend({},this.defaultOptions,i),this.options.app=this,this.options.$el=this.$el=e(this.options.el),this.on("fetched:base-data",this.loadBaseData),this.on("loaded:basic-bill-data",this.loadRecentCategory),this.categories=new o.CategoriesCollection(null),this.bills=new o.BillsCollection(null),this.getTemplates(),this.fetchBaseData(),this.router=new o.MainRouter(this.options),this.on("loaded:base-data",this.startRouting)},t.extend(a.prototype,i.Events),t.extend(a.prototype,{views:{},cache:{},fetched:{},startRouting:function(){this.router.start()},fetchBaseData:function(){var e=this;this.fetched.baseData!==!0&&(this.tabletop=s.init(t.extend(this.options.tabletopOptions,{key:this.options.eKey,callback:function(t,i){e.fetched.baseData=!0,e.trigger("fetched:base-data",t,i)},callbackContext:e,wanted:this.options.sheetsWanted})))},loadBaseData:function(e,i){var n,s,l=this;s=o.parsers.eData(i,this.options),t.each(s.categories,function(t){this.categories.add(this.getModel("CategoryModel","id",t))},this),t.each(s.bills,function(t){this.bills.add(this.getModel("BillModel","bill",t))},this),n={id:"recent",title:"Recent Actions",description:"The following bills have been updated in the past "+this.options.recentChangeThreshold+" days.",image:this.options.recentImage},this.categories.add(this.getModel("CategoryModel","id",n)),this.categories.each(function(t){t.getBills(l.bills)}),this.trigger("loaded:base-data")},fetchBasicBillData:function(){var i,s=this,l=[];return this.fetched.basicBillData!==!0?(this.bills.each(function(e){t.each(e.getOSBillIDs(),function(t){l.push(t)})}),i="http://openstates.org/api/v1/bills/?state="+this.options.state+"&search_window=session:"+this.options.session+"&bill_id__in="+encodeURI(l.join("|"))+"&apikey="+this.options.OSKey+"&callback=?",e.getJSON(i).done(function(e){s.fetched.basicBillData=!0,s.trigger("fetched:basic-bill-data"),t.each(e,function(t){t.created_at=n(t.created_at),t.updated_at=n(t.updated_at),s.getModel("OSBillModel","bill_id",t).set(t)}),s.trigger("loaded:basic-bill-data")})):void 0},loadRecentCategory:function(){var t=this,e=this.getModel("CategoryModel","id",{id:"recent"});this.bills.each(function(i){var s=i.get("categories");Math.abs(parseInt(i.lastUpdatedAt().diff(n(),"days"),10))<t.options.recentChangeThreshold&&(s.push(e.get("id")),i.set("categories",s))}),e.getBills(this.bills)},fetchOSBillsFromBill:function(){category.get("id");var e=[];t.each(category.get("bills"),function(t){e.push(t.fetch())})},fetchOSBillsFromCategory:function(t){var i=this,n=[];return t.getBills(this.bills),t.get("bills").each(function(t){n.push(t.fetchOSBills())}),e.when.apply(e,n).done(function(){i.trigger("fetched:osbills"),i.trigger("fetched:osbills:category:"+t.id)})},getModel:function(e,i,n,s){var l="models:"+e+":"+i+":"+n[i];return s=t.extend(s||{},{app:this}),t.isUndefined(this.cache[l])&&(this.cache[l]=new o[e](n,s)),this.cache[l]},fetchModel:function(t){var i;return t.get("fetched")!==!0?t.fetch({success:function(t){t.set("fetched",!0)}}):(i=e.Deferred(),i.resolveWith(t),i)},translate:function(e,i){var n=i;return t.isObject(this.options.wordTranslations[e])&&t.isString(this.options.wordTranslations[e][i])&&(n=this.options.wordTranslations[e][i]),n},imagePath:function(t){return 0===t.indexOf("http")?t:this.options.imagePath+t},getTemplate:function(t){return o.templates[t]},templates:{},getTemplates:function(){this.templates.application=this.getTemplate("template-application"),this.templates.loading=this.getTemplate("template-loading"),this.templates.error=this.getTemplate("template-error"),this.templates.ebill=this.getTemplate("template-ebill"),this.templates.osbill=this.getTemplate("template-osbill"),this.templates.category=this.getTemplate("template-category"),this.templates.categories=this.getTemplate("template-categories"),this.templates.sponsor=this.getTemplate("template-sponsor")},defaultOptions:{sheetsWanted:["Categories","Bills","Events"],fieldTranslations:{eCategories:{id:"categoryid",short_title:"shorttitle"},eBills:{bill:"bill",bill_companion:"companionbill",bill_conference:"conferencebill",categories:"categories",title:"title",description:"description"},eEvents:{bill_id:"bill",actor:"chamber",action:"title"}},wordTranslations:{chamber:{upper:"Senate",lower:"House"},partyAbbr:{"Democratic-Farmer-Labor":"DFL",Democratic:"D",Republican:"R"}},maxBills:30,substituteMatch:/substituted/i,imagePath:"./styles/images/",templatePath:"./js/app/templates/",recentChangeThreshold:7,tabletopOptions:{},scrollOffset:!1,conferenceBill:!0,recentImage:"RecentUpdatedBill.png",chamberLabel:!1,detectCompanionBill:/([A-Z]+ [1-9][0-9]*)$/,billNumberFormat:/[A-Z]+ [1-9][0-9]*/,osBillParse:!1}}),o.templates=this.LTTemplates,a
});