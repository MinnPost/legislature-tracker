/*! legislature-tracker - v0.1.0 - 2014-02-05
* https://github.com/MinnPost/legislature-tracker
* Copyright (c) 2014 ; Licensed MIT */

(function(e,t){if("undefined"!=typeof module&&module.exports&&"function"==typeof require)t(require("underscore"),require("jquery"),require("backbone"));else if("function"==typeof define&&define.amd)define("LTHelpers",["underscore","jquery","backbone"],t);else{if(!(e._&&e.jQuery&&e.Backbone))throw Error("Could not find dependencies for LT Helpers.");t(e._,e.jQuery,e.Backbone)}})("undefined"!=typeof window?window:this,function(e,t,i){e.mixin({trim:function(t){return e.isString(t)&&(t=String.prototype.trim?t.trim():t.replace(/^\s+|\s+$/g,"")),t},cssClass:function(e){return e.replace(/[^a-z0-9]/g,"-")},numberFormatCommas:function(e){return(""+e).replace(/\B(?=(\d{3})+(?!\d))/g,",")},ellipsisText:function(e,t){var i,n,l,s,a="",o="<!-- break -->",r='<ins class="ellipsis-start">[[[TEXT]]]</ins>',c='<ins class="ellipsis-ellipsis">...</ins>',_='<ins class="ellipsis-end">[[[TEXT]]]</ins>';return-1!==e.indexOf(o)?(i=e.indexOf(o),a+=r.replace("[[[TEXT]]]",e.substring(0,i))+" ",a+=c+" ",a+=_.replace("[[[TEXT]]]",e.substring(i,e.length))+" "):(s=e.split(" "),t>=s.length?a+=r.replace("[[[TEXT]]]",e):(n=s.slice(0,t),l=s.slice(t),a+=r.replace("[[[TEXT]]]",n.join(" "))+" ",a+=c+" ",a+=_.replace("[[[TEXT]]]",l.join(" "))+" ")),a},parseURL:function(e){var t=document.createElement("a");return t.href=e,t}}),i.ajax=function(){var e=arguments;return e[0].dataTypeForce!==!0&&(e[0].dataType="jsonp"),i.$.ajax.apply(i.$,e)},t.fn.hasScrollBar=function(){return this.get(0)&&this.get(0).scrollHeight?this.get(0).scrollHeight>this.height():!1}}),function(e,t){if("undefined"!=typeof module&&module.exports&&"function"==typeof require)t(require("underscore"),require("jquery"));else if("function"==typeof define&&define.amd)define("LT",["underscore","jquery"],t);else{if(!e._||!e.jQuery)throw Error("Could not find dependencies for LT Core.");e.LT=t(e._,e.jQuery)}}("undefined"!=typeof window?window:this,function(e,t){var i={};return i.cache={},i.cache.models={},i.log=function(t){e.isUndefined(window.console)||window.console.log(t)},i.utils={},i.utils.getModel=function(t,n,l,s){var a=t+":"+n+":"+l[n];return s=s||i.options,e.isUndefined(i.cache.models[a])&&(i.cache.models[a]=new i[t](l,s)),i.cache.models[a]},i.utils.fetchModel=function(e){var i;return e.get("fetched")!==!0?e.fetch():(i=t.Deferred(),i.resolveWith(e),i)},i.utils.translate=function(t,n){var l=n;return e.isObject(i.options.wordTranslations[t])&&e.isString(i.options.wordTranslations[t][n])&&(l=i.options.wordTranslations[t][n]),l},i.utils.imagePath=function(e){return 0===e.indexOf("http")?e:i.options.imagePath+e},i.templates=i.templates||{},i.utils.getTemplate=function(n,l,s,a){var o="js/app/templates/"+n+".html",r=i.options.templatePath+n+".html";e.isUndefined(i.templates[o])?t.ajax({url:r,method:"GET",async:!1,contentType:"text",success:function(t){i.templates[o]=e.template(t),l[s]=i.templates[o],e.isFunction(a)&&a.apply(this,[t])}}):l[s]=i.templates[o]},i.parse=i.parse||{},i.parse.eData=function(t){var n={};n.categories=i.parse.eCategories(t.sheets("Categories").all());var l=t.sheets("Bills").all();return l.length>i.options.maxBills&&i.log("The number of bills in your spreadsheet exceeds maxBills. Set the maxBills option to display them, but be aware that this may significantly slow down the Legislature Tracker."),n.bills=i.parse.eBills(l.slice(0,i.options.maxBills)),n.events=i.parse.eEvents(t.sheets("Events").all()),e.each(e.groupBy(n.events,"bill_id"),function(t,i){e.each(n.bills,function(e,l){e.bill===i&&(n.bills[l].custom_events=t)})}),n},i.parse.validateBillNumber=function(e){return i.options.billNumberFormat.test(e)},i.parse.eBills=function(t){return e.map(t,function(t){return i.parse.translateFields(i.options.fieldTranslations.eBills,t),t.links=i.parse.eLinks(t.links),t.categories=t.categories?t.categories.split(","):[],t.categories=e.map(t.categories,e.trim),t.bill_primary=void 0,t.bill&&i.parse.validateBillNumber(t.bill)?t.bill_primary=i.utils.getModel("OSBillModel","bill_id",{bill_id:e.trim(t.bill)}):t.bill&&!i.parse.validateBillNumber(t.bill)&&i.log('Invalid primary bill number "'+t.bill+'" for row '+t.rowNumber+", see documentation."),t.bill_companion&&i.parse.validateBillNumber(t.bill_companion)?t.bill_companion=i.utils.getModel("OSBillModel","bill_id",{bill_id:e.trim(t.bill_companion)}):t.bill_companion&&!i.parse.validateBillNumber(t.bill_companion)&&i.log('Invalid companion bill number "'+t.bill_companion+'" for row '+t.rowNumber+", see documentation."),t.bill_conference&&i.parse.validateBillNumber(t.bill_conference)?t.bill_conference=i.utils.getModel("OSBillModel","bill_id",{bill_id:e.trim(t.bill_conference)}):t.bill_conference&&!i.parse.validateBillNumber(t.bill_conference)&&i.log('Invalid conference bill number "'+t.bill_conference+'" for row '+t.rowNumber+", see documentation."),t.hasBill=!0,t.bill&&void 0!==t.bill_primary||(t.hasBill=!1,t.bill=e.cssClass(t.title.toLowerCase())),t})},i.parse.eCategories=function(t){return e.map(t,function(e){return i.parse.translateFields(i.options.fieldTranslations.eCategories,e),e.links=i.parse.eLinks(e.links),e})},i.parse.eEvents=function(t){return e.map(t,function(e){return i.parse.translateFields(i.options.fieldTranslations.eEvents,e),e.links=i.parse.eLinks(e.links),e.date=moment(e.date),e.type=["custom"],e})},i.parse.eLinks=function(t){var i=[];return t=e.trim(t),0===t.length?i:(t='"'===t.substring(0,1)?t.substring(1):t,t='"'===t.substring(t.length-1,t.length)?t.slice(0,-1):t,i=t.split('", "'),i=e.map(i,function(e){return{title:e.split("|")[0],url:e.split("|")[1]}}))},i.parse.csvCategories=function(t){return t=e.trim(t),0===t.length?[]:(t='"'===t.substring(0,1)?t.substring(1):t,t='"'===t.substring(t.length-1,t.length)?t.slice(0,-1):t,t.split('", "'))},i.parse.detectCompanionBill=function(t){var n,l;return e.isFunction(i.options.detectCompanionBill)?(n=i.options.detectCompanionBill(t),l=i.parse.validateBillNumber(n)?n:void 0):e.isRegExp(i.options.detectCompanionBill)&&(n=i.options.detectCompanionBill.exec(t),l=n&&i.parse.validateBillNumber(n[1])?n[1]:void 0),e.trim(l)},i.parse.translateFields=function(t,i){return e.each(t,function(e,t){i[t]=i[e],t!==e&&delete i[e]}),i},i.defaultOptions={sheetsWanted:["Categories","Bills","Events"],fieldTranslations:{eCategories:{id:"categoryid",short_title:"shorttitle"},eBills:{bill:"bill",bill_companion:"companionbill",bill_conference:"conferencebill",categories:"categories",title:"title",description:"description"},eEvents:{bill_id:"bill",actor:"chamber",action:"title"}},wordTranslations:{chamber:{upper:"Senate",lower:"House"},partyAbbr:{"Democratic-Farmer-Labor":"DFL",Democratic:"D",Republican:"R"}},maxBills:30,substituteMatch:/substituted/i,imagePath:"./css/images/",templatePath:"./js/app/templates/",recentChangeThreshold:7,tabletopOptions:{},scrollOffset:!1,conferenceBill:!0,recentImage:"RecentUpdatedBill.png",chamberLabel:!1,detectCompanionBill:/([A-Z]+ [1-9][0-9]*)$/,billNumberFormat:/[A-Z]+ [1-9][0-9]*/,osBillParse:!1},i}),this.LT=this.LT||{},this.LT.templates=this.LT.templates||{},this.LT.templates["js/templates/template-categories.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='\n<div class="categories-container">\n  ',options.title&&(__p+="\n    <h2>"+(null==(__t=options.title)?"":__t)+"</h2>\n  "),__p+="\n\n  ","undefined"!=typeof totalBills&&(__p+='\n    <div class="aggregate-counts">\n      <span class="aggregate-stat">\n        <span class="aggregate-count-label">Bills introduced:</span>\n        <span class="aggregate-count-value">'+(null==(__t=_.numberFormatCommas(totalBills))?"":__t)+'</span>\n      </span>\n\n      <span class="aggregate-stat">\n        <span class="aggregate-count-label">Bills signed:</span>\n        <span class="aggregate-count-value">'+(null==(__t=_.numberFormatCommas(totalBillsSigned))?"":__t)+"</span>\n      </span>\n    </div>\n  "),__p+='\n\n  <ul class="category-list clear-block">\n    ',_.each(categories,function(e,t){__p+='\n      <li class="category-item category-item-'+(null==(__t=t)?"":__t)+'">\n        <div class="category-inner category-'+(null==(__t=_.cssClass(e.id))?"":__t)+'">\n          ',e.image&&(__p+='\n            <a href="#/category/'+(null==(__t=encodeURI(e.id))?"":__t)+'">\n              <img class="category-image" src="'+(null==(__t=utils.imagePath(e.image))?"":__t)+'" />\n            </a>\n          '),__p+='\n\n          <h3>\n            <a href="#/category/'+(null==(__t=encodeURI(e.id))?"":__t)+'">\n              '+(null==(__t=e.title)?"":__t)+"\n            </a>\n          </h3>\n\n          <div>\n            Watching\n            <strong>"+(null==(__t=e.bills.length)?"":__t)+"</strong>\n            ",e.total_bill_count&&(__p+="\n              of "+(null==(__t=e.total_bill_count)?"":__t)+"\n            "),__p+="\n            bills.\n          </div>\n        </div>\n      </li>\n    "}),__p+="\n  </ul>\n</div>";return __p},this.LT.templates["js/templates/template-category.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+="\n"+(null==(__t=header)?"":__t)+'\n\n<div class="category-container">\n  <h2>\n    ',category.image&&(__p+='\n      <img class="category-image" src="'+(null==(__t=LT.utils.imagePath(category.image))?"":__t)+'" />\n    '),__p+="\n    \n    "+(null==(__t=category.title)?"":__t)+"\n  </h2>\n  \n  <p>"+(null==(__t=category.description)?"":__t)+"</p>\n  \n  ",_.isArray(category.links)&&category.links.length>0&&(__p+='\n    <div class="e-links">\n      <h4>In the news</h4>\n      \n      <ul class="e-links-list">\n        ',_.each(category.links,function(e){__p+='\n          <li><a href="'+(null==(__t=e.url)?"":__t)+'">'+(null==(__t=e.title)?"":__t)+"</a></li>\n        "}),__p+="\n      </ul>\n    </div>\n  "),__p+='\n  \n  <div class="clear-block bills-list">\n    ',category.bills.each(function(e){__p+="\n      "+(null==(__t=templates.ebill({bill:e.toJSON(),expandable:!0,templates:templates}))?"":__t)+"\n    "}),__p+='\n  </div>\n  \n  <div class="clear-block total-bill">\n    Watching \n    <strong>'+(null==(__t=category.bills.length)?"":__t)+"</strong>\n    ",category.total_bill_count!==void 0&&(__p+="\n      of "+(null==(__t=category.total_bill_count)?"":__t)+"\n    "),__p+="\n    bills in the "+(null==(__t=category.title)?"":__t)+" category.\n  </div>\n</div>";return __p},this.LT.templates["js/templates/template-ebill.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)expandable||(__p+="\n  "+(null==(__t=header)?"":__t)+"\n"),__p+='\n<div class="bill ebill ',expandable&&(__p+="is-expandable"),__p+=" ",bill.hasBill||(__p+="no-bill"),__p+='">\n  <div class="bill-top">\n    <div class="bill-status">\n      <img class="lower ',bill.newest_action&&Math.abs(parseInt(bill.newest_action.date.diff(moment(),"days")))<LT.options.recentChangeThreshold&&(__p+="passed"),__p+='" src="'+(null==(__t=LT.options.imagePath)?"":__t)+'RecentChanges.png" title="',__p+=bill.newest_action&&Math.abs(parseInt(bill.newest_action.date.diff(moment(),"days")))<LT.options.recentChangeThreshold?"Recently changed":"Not recently changed",__p+='" />\n      \n      <img class="lower ',bill.actions&&bill.actions.lower&&(__p+="passed"),__p+='" src="'+(null==(__t=LT.options.imagePath)?"":__t)+'PassedHouse.png" title="',__p+=bill.actions&&bill.actions.lower?"Passed "+(null==(__t=LT.utils.translate("chamber","lower"))?"":__t):"Not passed "+(null==(__t=LT.utils.translate("chamber","lower"))?"":__t),__p+='" />\n      \n      <img class="upper ',bill.actions&&bill.actions.upper&&(__p+="passed"),__p+='" src="'+(null==(__t=LT.options.imagePath)?"":__t)+'PassedSenate.png" title="',__p+=bill.actions&&bill.actions.upper?"Passed "+(null==(__t=LT.utils.translate("chamber","upper"))?"":__t):"Not passed "+(null==(__t=LT.utils.translate("chamber","upper"))?"":__t),__p+='" />\n      \n      ',LT.options.conferenceBill&&(__p+='\n        <img class="conference ',bill.bill_type&&bill.bill_type.conference&&(__p+="passed"),__p+='" src="'+(null==(__t=LT.options.imagePath)?"":__t)+'InConferenceCommittee.png" title="',__p+=bill.bill_type&&bill.bill_type.conference?"Conference bill created":"Coinference bill not created",__p+='" />\n      '),__p+='\n      \n      <img class="signed ',bill.actions&&bill.actions.signed&&(__p+="passed"),__p+='" src="'+(null==(__t=LT.options.imagePath)?"":__t)+'SignedIntoLaw.png" title="',__p+=bill.actions&&bill.actions.signed?"Signed into law by the Governor":"Not signed into law",__p+='" />\n    </div>\n    \n    ',__p+=expandable?"<h3>":"<h2>",__p+="\n      "+(null==(__t=bill.title)?"":__t)+'\n      <a class="permalink" title="Permanent link to bill" href="#/bill/'+(null==(__t=encodeURI(bill.bill))?"":__t)+'"></a>\n    ',__p+=expandable?"</h3>":"</h2>",__p+="\n    \n    ",bill.hasBill||(__p+='\n      <div class="latest-action">\n        <em>This bill has not been tracked by the legislature yet.</em>\n      </div>\n    '),__p+="\n    \n     ",bill.newest_action&&(__p+='\n      <div class="latest-action">\n        Last action '+(null==(__t=bill.newest_action.date.fromNow())?"":__t)+".\n      </div>\n    "),__p+='\n    \n    <div class="description">\n      ',__p+=3>bill.description.indexOf("<p")?"\n        "+(null==(__t=_.ellipsisText(bill.description,60))?"":__t)+"\n      ":"\n        <p>"+(null==(__t=_.ellipsisText(bill.description,60))?"":__t)+"</p>\n      ",__p+='\n    </div>\n    \n    <div class="e-bill-categories">\n      <strong>Categories:</strong>\n      ',_.each(bill.categories,function(e,t){__p+='\n        <a href="#/category/'+(null==(__t=e.get("id"))?"":__t)+'">\n          ',e.get("image")&&(__p+='<img class="category-image" src="'+(null==(__t=LT.utils.imagePath(e.get("image")))?"":__t)+'" />'),__p+="\n          "+(null==(__t=e.get("title"))?"":__t)+"</a>",bill.categories.length-1>t&&(__p+=","),__p+="\n      "}),__p+="\n    </div>\n    \n    ",expandable&&(bill.hasBill||!(60>bill.description.split(" ").length)||_.isArray(bill.links)&&bill.links.length>0)&&(__p+='\n      <a href="#" class="bill-expand">More detail</a>\n      <a href="#/bill/'+(null==(__t=encodeURI(bill.bill))?"":__t)+'" class="bill-details-link">More detail</a>\n    '),__p+='\n  </div>\n  \n  <div class="bill-bottom">\n    ',_.isArray(bill.links)&&bill.links.length>0&&(__p+='\n      <div class="e-links">\n        <h4>In the news</h4>\n        <ul class="e-links-list">\n          ',_.each(bill.links,function(e){__p+='\n            <li><a href="'+(null==(__t=e.url)?"":__t)+'">'+(null==(__t=e.title)?"":__t)+"</a></li>\n          "}),__p+="\n        </ul>\n      </div>\n    "),__p+="\n    \n    ",_.isArray(bill.custom_events)&&bill.custom_events.length>0&&(__p+='\n      <div class="custom-events">\n        <h4>Events</h4>\n        <ul class="custom-events-inner">\n          ',_.each(bill.custom_events,function(e){__p+="\n            <li><strong>"+(null==(__t=e.bill_id)?"":__t)+" "+(null==(__t=e.action)?"":__t)+"</strong> on  "+(null==(__t=e.date.format("MMM DD, YYYY"))?"":__t)+": "+(null==(__t=e.description)?"":__t)+"</li>\n          "}),__p+="\n        </ul>\n      </div>\n    "),__p+="\n\n    ",_.isObject(bill.bill_conference)&&(__p+='\n      <div class="conference-bill">\n        <div class="conference-bill-inner clear-block">\n          '+(null==(__t=templates.osbill({title:"Conference Bill",bill:bill.bill_conference.toJSON(),templates:templates}))?"":__t)+'\n        </div>\n      </div>\n      \n      <a class="expand-other-bills" href="#">Show other bills</a>\n    '),__p+='\n    \n    <div class="clear-block ',_.isObject(bill.bill_conference)&&(__p+="has-conference-bill"),__p+='">\n      ',_.isObject(bill.bill_primary)&&(__p+='\n        <div class="primary-bill ',_.isObject(bill.bill_companion)&&(__p+="with-companion"),__p+='">\n          <div class="primary-bill-inner clear-block">\n            '+(null==(__t=templates.osbill({title:LT.options.chamberLabel?LT.utils.translate("chamber",bill.bill_primary.get("chamber"))+" Bill":"Primary Bill",bill:bill.bill_primary.toJSON(),templates:templates}))?"":__t)+"\n          </div>\n        </div>\n      "),__p+="\n      \n      ",_.isObject(bill.bill_companion)&&(__p+='\n        <div class="companion-bill">\n          <div class="companion-bill-inner clear-block">\n            '+(null==(__t=templates.osbill({title:LT.options.chamberLabel?LT.utils.translate("chamber",bill.bill_companion.get("chamber"))+" Bill":"Companion Bill",bill:bill.bill_companion.toJSON(),templates:templates}))?"":__t)+"\n          </div>\n        </div>\n      "),__p+="\n    </div>\n  </div>\n</div>";return __p},this.LT.templates["js/templates/template-error.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="error-container">\n  <div class="error"><span>There was an error.</span></div>\n</div>';return __p},this.LT.templates["js/templates/template-header.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='<div class="ls-header-container">\n  <div class="ls-header">\n    <a class="all-categories-link" href="#/">\n      <img src="'+(null==(__t=LT.options.imagePath)?"":__t)+'back-100-85.png" />\n      All Categories\n    </a>\n    \n    <span class="categories-nav">\n      &nbsp;&nbsp;|&nbsp;&nbsp;\n      ',_.each(categories,function(e){__p+='\n        <a class="" href="#/category/'+(null==(__t=e.id)?"":__t)+'" title="'+(null==(__t=e.title)?"":__t)+'">\n          '+(null==(__t=e.short_title?e.short_title:e.title.split(" ")[0])?"":__t)+"\n        </a>&nbsp;&nbsp;\n      "}),__p+="\n    </span>\n  </div>\n</div>";return __p},this.LT.templates["js/templates/template-legislator.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj)__p+='\n<div class="legislator">\n  ',__p+=LT.options.legImageProxy?'\n    <img src="'+(null==(__t=LT.options.legImageProxy)?"":__t)+(null==(__t=encodeURI(photo_url))?"":__t)+'" />\n  ':'\n    <img src="'+(null==(__t=photo_url)?"":__t)+'" />\n  ',__p+='\n  \n  <div class="legislator-info">\n    '+(null==(__t=full_name)?"":__t)+"<br />\n    ","undefined"!=typeof district&&(__p+="\n      District "+(null==(__t=district)?"":__t)+"\n    "),__p+="\n    ","undefined"!=typeof party&&(__p+="\n      ("+(null==(__t=LT.utils.translate("partyAbbr",party))?"":__t)+") \n    "),__p+=" <br />\n    ","undefined"!=typeof chamber&&(__p+="\n      "+(null==(__t=LT.utils.translate("chamber",chamber))?"":__t)+"\n    "),__p+="\n  </div>\n</div>";return __p},this.LT.templates["js/templates/template-loading.html"]=function(obj){obj||(obj={});var __p="";with(_.escape,obj)__p+='<div class="loading-general-container">\n  <div class="loading-general"><span>Loading...</span></div>\n</div>';return __p},this.LT.templates["js/templates/template-osbill.html"]=function(obj){obj||(obj={});var __t,__p="";with(_.escape,Array.prototype.join,obj){"undefined"!=typeof detailed&&detailed&&(__p+="\n  "+(null==(__t=header)?"":__t)+"\n"),__p+='\n\n<div class="osbill">\n  <h4>\n    ',__p+="undefined"!=typeof title?"\n      "+(null==(__t=title)?"":__t)+" ("+(null==(__t=bill.bill_id)?"":__t)+")\n    ":"\n      "+(null==(__t=bill.bill_id)?"":__t)+"\n    ",__p+='\n    <a class="permalink" title="Permanent link to bill" href="#/bill-detail/'+(null==(__t=encodeURI(bill.bill_id))?"":__t)+'"></a>\n  </h4>\n  \n  ',"undefined"!=typeof detailed&&detailed&&(__p+='\n    <p class="description">\n      '+(null==(__t=bill.title)?"":__t)+"\n    </p>\n  "),__p+='\n\n  <div class="sponsors primary-sponsors">\n    <h5>Primary sponsors</h5>\n    \n    <div class="clear-block">\n      ',_.each(bill.sponsors,function(e){__p+="\n        ","primary"===e.type&&(__p+='\n          <div class="sponsor" data-leg-id="'+(null==(__t=e.leg_id)?"":__t)+'" data-sponsor-type="'+(null==(__t=e.type)?"":__t)+'">\n            '+(null==(__t=e.name)?"":__t)+" ("+(null==(__t=e.type)?"":__t)+")\n          </div>\n        "),__p+="\n      "}),__p+='\n    </div>\n  </div>\n  \n  <div class="actions">\n    <h5><span class="latest-action-label">Latest </span>Actions</h5>\n    \n    <div class="actions-inner">\n      ',_.each(bill.actions,function(e){__p+="\n        ",e.date&&(__p+="\n          <div>\n            "+(null==(__t=e.date.format("MMM DD, YYYY"))?"":__t)+":  \n            "+(null==(__t=e.action)?"":__t)+"\n            ("+(null==(__t=LT.utils.translate("chamber",e.actor))?"":__t)+")\n          </div>\n        "),__p+=" \n      "}),__p+="\n    </div>\n  </div>\n\n  ",bill.sponsors.length>1&&(__p+='\n    <div class="sponsors co-sponsors clear-block">\n      <h5>Co-Sponsors</h5>\n      \n      <div class="co-sponsors-inner clear-block">\n        ',_.each(bill.sponsors,function(e){__p+="\n          ","primary"!==e.type&&(__p+='\n            <div class="sponsor" data-leg-id="'+(null==(__t=e.leg_id)?"":__t)+'" data-sponsor-type="'+(null==(__t=e.type)?"":__t)+'">\n              '+(null==(__t=e.name)?"":__t)+" ("+(null==(__t=e.type)?"":__t)+")\n            </div>\n          "),__p+="\n        "}),__p+="\n      </div>\n    </div>\n  "),__p+="\n\n  ",_.isArray(bill.votes)&&bill.votes.length>0&&(__p+='\n    <div class="votes">\n      <h5>Votes</h5>\n      \n      <div class="votes-inner clear-block">\n        ',_.each(bill.votes,function(e){__p+="\n          "+(null==(__t=e.date.format("MMM DD, YYYY"))?"":__t)+":\n          "+(null==(__t=e.motion)?"":__t)+" "+(null==(__t=e.passed?"passed":"failed")?"":__t)+":\n          "+(null==(__t=e.yes_count)?"":__t)+" Y - \n          "+(null==(__t=e.no_count)?"":__t)+" N <br />\n        "}),__p+="\n      </div>\n    </div>\n  "),__p+='\n  \n  <div class="sources">\n    <h5>Sources</h5>\n    \n    ';var sourceCount=0;__p+="\n    ",_.each(bill.sources,function(e){sourceCount++,__p+='\n      <a href="'+(null==(__t=e.url)?"":__t)+'" target="_blank">\n        ',__p+=e.text?"\n          "+(null==(__t=e.text)?"":__t)+"\n        ":"\n          Source at "+(null==(__t=_.parseURL(e.url).hostname)?"":__t)+" ["+(null==(__t=sourceCount)?"":__t)+"]\n        ",__p+="\n      </a> <br />\n    "}),__p+="\n  </div>\n</div>"}return __p},function(e,t){if("undefined"!=typeof module&&module.exports&&"function"==typeof require)t(require("underscore"),require("jquery"),require("backbone"),require("moment"),require("LT"));else if("function"==typeof define&&define.amd)define("LTModels",["underscore","jquery","backbone","moment","LT"],t);else{if(!(e._&&e.jQuery&&e.Backbone&&e.moment&&e.LT))throw Error("Could not find dependencies for LT Models.");t(e._,e.jQuery,e.Backbone,e.moment,e.LT)}}("undefined"!=typeof window?window:this,function(e,t,i,n,l){l.OSModel=i.Model.extend({urlBase:function(){return"http://openstates.org/api/v1/"},urlEnd:function(){return"/?apikey="+encodeURI(l.options.OSKey)+"&callback=?"},url:function(){return this.urlBase()+encodeURI(this.osType)+"/"+encodeURI(this.id)+this.urlEnd()},initialize:function(e,t){this.options=t,this.on("sync",function(e){e.set("fetched",!0)})}}),l.OSStateModel=l.OSModel.extend({url:function(){return this.urlBase()+"metadata/"+encodeURI(this.options.state)+this.urlEnd()}}),l.OSBillModel=l.OSModel.extend({url:function(){return e.isUndefined(this.id)?this.urlBase()+"bills/"+encodeURI(this.options.state)+"/"+encodeURI(this.options.session)+"/"+encodeURI(this.get("bill_id"))+this.urlEnd():this.urlBase()+"bills/"+this.id+this.urlEnd()},initialize:function(){l.OSBillModel.__super__.initialize.apply(this,arguments),this.on("sync",function(){this.parseOSData()})},parseOSData:function(){var t;this.set("created_at",n(this.get("created_at"))),this.set("updated_at",n(this.get("updated_at"))),t=this.get("action_dates"),e.each(t,function(e,i){t[i]=e?n(e):e}),this.set("action_dates",t),t=this.get("actions"),e.each(t,function(e,i){t[i].date=e.date?n(e.date):e.date}),this.set("actions",t),t=this.get("votes"),e.each(t,function(e,i){t[i].date=e.date?n(e.date):e.date}),this.set("votes",t),t=this.get("custom_events"),e.isArray(t)&&t.length>0&&this.set("actions",e.union(this.get("actions"),t)),this.set("actions",e.sortBy(this.get("actions"),function(e,t){return-1*(e.date.unix()+t)})),this.set("newest_action",this.get("actions")[0]),l.options.osBillParse&&e.isFunction(l.options.osBillParse)&&l.options.osBillParse(this)},getActionDate:function(e){return this.get("action_dates")[e]?this.get("action_dates")[e]:!1},isSubstituted:function(){var t=!1;return e.isBoolean(this.get("substitued"))?t=this.get("substitued"):l.options.substituteMatch===!1?t=!1:(t=e.find(this.get("actions"),function(e){return e.action.match(l.options.substituteMatch)}),t=t?!0:!1,this.set("substitued",t)),t}}),l.OSLegislatorModel=l.OSModel.extend({osType:"legislators"}),l.OSCommitteeModel=l.OSModel.extend({osType:"committees"}),l.BillModel=i.Model.extend({initialize:function(e,t){this.options=t},loadOSBills:function(){var i=this,n=[];return e.each(["bill_primary","bill_companion","bill_conference"],function(e){i.get("hasBill")&&i.get(e)&&n.push(l.utils.fetchModel(i.get(e)))}),t.when.apply(t,n)},loadOSCompanion:function(){var i,n=[];return this.get("hasBill")===!0&&!this.get("bill_companion")&&e.isObject(this.get("bill_primary"))&&e.isArray(this.get("bill_primary").get("companions"))&&e.isObject(this.get("bill_primary").get("companions")[0])&&(i=l.parse.detectCompanionBill(this.get("bill_primary").get("companions")[0].bill_id),i&&(this.set("bill_companion",l.utils.getModel("OSBillModel","bill_id",{bill_id:i})),n.push(l.utils.fetchModel(this.get("bill_companion"))))),t.when.apply(t,n)},loadCategories:function(){this.get("categories")&&this.set("categories",e.map(this.get("categories"),function(t){return e.isObject(t)||(t=l.utils.getModel("CategoryModel","id",{id:t})),t}))},lastUpdatedAt:function(){var t,i=this.get("bill_primary"),n=this.get("bill_companion"),s=this.get("bill_conference");return e.isUndefined(this.get("last_updated_at"))&&i.get("updated_at")?(t=i.get("updated_at"),n&&n.get("updated_at")&&(t=n.get("updated_at").unix()>t.unix()?n.get("updated_at"):t),s&&s.get("updated_at")&&(t=s.get("updated_at").unix()>t.unix()?s.get("updated_at"):t),this.set("last_updated_at",t)):e.isUndefined(this.get("last_updated_at"))&&!i.get("updated_at")&&l.log("Could not fetch primary bill data from OpenStates. Check that the id "+this.get("bill_primary").get("bill_id")+" is formatted properly."),this.get("last_updated_at")},newestAction:function(){var t,i=this.get("bill_primary"),n=this.get("bill_companion"),l=this.get("bill_conference");return this.get("hasBill")&&e.isUndefined(this.get("newest_action"))&&i.get("newest_action")&&(t=i.get("newest_action"),n&&n.get("newest_action")&&(t=n.get("newest_action").date.unix()>t.date.unix()?n.get("newest_action"):t),l&&l.get("newest_action")&&(t=l.get("newest_action").date.unix()>t.date.unix()?l.get("newest_action"):t),this.set("newest_action",t)),this.get("newest_action")},parseMeta:function(){var t={upper:!1,lower:!1,conference:!1,signed:!1,last:!1},i={companion:this.get("bill_companion")?!0:!1,conference:this.get("bill_conference")?!0:!1};if(this.get("custom_events")&&this.set("custom_events",e.sortBy(this.get("custom_events"),function(e,t){return-1*(e.date.unix()+t)})),this.get("hasBill")){if(i.companion&&(this.get("bill_companion").isSubstituted()&&(i.substituted=!0),this.get("bill_primary").isSubstituted()&&(i.substituted=!0)),(!i.companion||i.substituted)&&(t.lower=this.get("bill_primary").getActionDate("passed_lower"),t.upper=this.get("bill_primary").getActionDate("passed_upper")),i.companion&&!i.substituted&&("upper"===this.get("bill_primary").get("chamber")?(t.upper=this.get("bill_primary").getActionDate("passed_upper"),t.lower=this.get("bill_companion").getActionDate("passed_lower")):(t.lower=this.get("bill_primary").getActionDate("passed_lower"),t.upper=this.get("bill_companion").getActionDate("passed_upper"))),i.conference){var n=this.get("bill_conference").getActionDate("passed_lower"),l=this.get("bill_conference").getActionDate("passed_upper");n&&l&&(t.conference=n.unix()>=l.unix()?n:l)}t.signed=i.conference?this.get("bill_conference").getActionDate("signed"):this.get("bill_primary").getActionDate("signed"),t.last=i.conference?this.get("bill_conference").getActionDate("last"):i.companion?this.get("bill_companion").getActionDate("last").unix()>=this.get("bill_primary").getActionDate("last").unix()?this.get("bill_companion").getActionDate("last"):this.get("bill_primary").getActionDate("last"):this.get("bill_primary").getActionDate("last"),this.get("description")||this.set("description",this.get("bill_primary").get("summary"))}return this.set("actions",t),this.set("bill_type",i),this}}),l.CategoryModel=i.Model.extend({initialize:function(e,t){this.options=t,this.set("bills",new l.BillsCollection(null)),this.getBills()},getBills:function(){var t=this,i=l.app.bills,n=this.get("id");return i.each(function(i){-1!==e.indexOf(i.get("categories"),n)&&t.get("bills").push(l.utils.getModel("BillModel","bill",i.attributes))}),this},loadBills:function(e,i){var n=[],l=this;return this.get("bills").each(function(e){n.push(e.loadOSBills())}),t.when.apply(t,n).done(function(){var n=[];l.get("bills").each(function(e){n.push(e.loadOSCompanion())}),t.when.apply(t,n).done(function(){l.get("bills").each(function(e){e.parseMeta()}),e()}).fail(i)}).fail(i),this}})}),function(e,t){if("undefined"!=typeof module&&module.exports&&"function"==typeof require)t(require("underscore"),require("jquery"),require("backbone"),require("moment"),require("LT"),require("LTModels"));else if("function"==typeof define&&define.amd)define("LTCollections",["underscore","jquery","backbone","moment","LT","LTModels"],t);else{if(!(e._&&e.jQuery&&e.Backbone&&e.moment&&e.LT))throw Error("Could not find dependencies for LT Collections.");t(e._,e.jQuery,e.Backbone,e.moment,e.LT)}}("undefined"!=typeof window?window:this,function(e,t,i,n,l){l.CategoriesCollection=i.Collection.extend({model:l.CategoryModel,comparator:function(e){return-1!==e.get("title").toLowerCase().indexOf("recent")?"zzzzz":e.get("title")}}),l.BillsCollection=i.Collection.extend({model:l.BillModel,comparator:function(e){var t=e.newestAction()?-1*e.newestAction().date.unix():e.get("title");return t}}),l.OSBillsCollection=i.Collection.extend({model:l.OSBillModel,comparator:function(e){var t=e.get("newest_action");return t&&(t=-1*t.date.unix()),t}})}),function(e,t){if("undefined"!=typeof module&&module.exports&&"function"==typeof require)t(require("underscore"),require("jquery"),require("backbone"),require("moment"),require("LT"),require("LTModels"),require("LTCollections"));else if("function"==typeof define&&define.amd)define("LTViews",["underscore","jquery","backbone","moment","LT","LTModels","LTCollections"],t);else{if(!(e._&&e.jQuery&&e.Backbone&&e.moment&&e.LT))throw Error("Could not find dependencies for LT Views.");t(e._,e.jQuery,e.Backbone,e.moment,e.LT)}}("undefined"!=typeof window?window:this,function(e,t,i,n,l){l.MainApplicationView=i.View.extend({initialize:function(){this.$el.addClass("ls"),this.templates=this.templates||{},l.utils.getTemplate("template-loading",this.templates,"loading"),l.utils.getTemplate("template-error",this.templates,"error"),l.utils.getTemplate("template-ebill",this.templates,"ebill"),l.utils.getTemplate("template-osbill",this.templates,"osbill"),l.utils.getTemplate("template-category",this.templates,"category"),l.utils.getTemplate("template-categories",this.templates,"categories"),l.utils.getTemplate("template-header",this.templates,"header"),e.bindAll(this,"expandBill","expandOtherBills")},events:{"click .bill-expand":"expandBill","click .expand-other-bills":"expandOtherBills"},loading:function(){return e.isNumber(l.options.scrollOffset)&&(this.initialLoad===!0?this.resetScrollView():this.initialLoad=e.isUndefined(this.initialLoad)?!1:!0),this.$el.html(this.templates.loading({})),this},error:function(e){return this.$el.html(this.templates.error({error:e})),this},renderCategories:function(){this.$el.html(this.templates.categories({categories:l.app.categories.toJSON(),options:l.options,totalBills:l.app.totalBills,totalBillsSigned:l.app.totalBillsSigned,utils:l.utils}))
},renderCategory:function(t){e.isObject(t)||(t=l.app.categories.get(t)),t.get("bills").sort(),this.$el.html(this.templates.category({category:t.toJSON(),templates:this.templates,header:this.renderHeader()})),this.getLegislators().navigationGlue()},renderEBill:function(t){e.isObject(t)||(t=this.router.bills.get(t)),t.newestAction(),this.$el.html(this.templates.ebill({bill:t.toJSON(),expandable:!1,templates:this.templates,header:this.renderHeader()})),this.getLegislators().checkOverflows().navigationGlue()},renderOSBill:function(e){this.$el.html(this.templates.osbill({bill:e.toJSON(),detailed:!0,templates:this.templates,header:this.renderHeader()})),this.getLegislators().checkOverflows().navigationGlue()},renderHeader:function(){return this.templates.header({categories:l.app.categories.toJSON()})},expandBill:function(e){e.preventDefault();var i=t(e.target),n=["More detail","Less detail"],l=i.text();return i.text(l===n[0]?n[1]:n[0]),i.parent().parent().toggleClass("expanded").find(".bill-bottom").slideToggle(),this.checkOverflows(),this},expandOtherBills:function(e){e.preventDefault();var i=t(e.target),n=["Show other bills","Hide other bills"],l=i.text();return i.text(l===n[0]?n[1]:n[0]),i.parent().find(".has-conference-bill").toggleClass("showing").slideToggle(),this.checkOverflows(),this},getLegislators:function(){return this.$el.find(".sponsor:not(.found)").each(function(){var e=t(this),i=e.data();if(i.id=i.legId,i.id){var n=l.utils.getModel("OSLegislatorModel","id",i);t.when(l.utils.fetchModel(n)).then(function(){new l.LegislatorView({el:e,model:n}).render()})}}),this},checkOverflows:function(){return this.$el.find(".actions-inner, .co-sponsors-inner").each(function(){t(this).hasScrollBar()&&t(this).addClass("overflowed")}),this},resetScrollView:function(){return t("html, body").animate({scrollTop:this.$el.offset().top-l.options.scrollOffset},1e3),this},navigationGlue:function(){var e=this.$el.offset().top,i=t(".ls-header");return t(".ls-header-container").height(i.outerHeight()),t(window).scroll(function(){var n=t(this);n.scrollTop()>e&&!i.hasClass("glued")?i.addClass("glued"):e>=n.scrollTop()&&i.hasClass("glued")&&i.removeClass("glued")}),this}}),l.LegislatorView=i.View.extend({model:l.OSLegislatorModel,initialize:function(){this.templates=this.templates||{},l.utils.getTemplate("template-legislator",this.templates,"legislator")},render:function(){return this.$el.addClass("found").html(this.templates.legislator(this.model.toJSON())),this}})}),function(e,t){if("undefined"!=typeof module&&module.exports&&"function"==typeof require)t(require("underscore"),require("jquery"),require("backbone"),require("moment"),require("tabletop"),require("LT"),require("LTHelpers"),require("LTViews"));else if("function"==typeof define&&define.amd)define("LTApp",["underscore","jquery","backbone","moment","tabletop","LT","LTHelpers","LTViews"],t);else{if(!(e._&&e.jQuery&&e.Backbone&&e.moment&&e.Tabletop&&e.LT))throw Error("Could not find dependencies for LT App.");t(e._,e.jQuery,e.Backbone,e.moment,e.Tabletop,e.LT)}}("undefined"!=typeof window?window:this,function(e,t,i,n,l,s){s.Application=i.Router.extend({routes:{categories:"routeCategories","category/recent":"routeRecentCategory","category/:category":"routeCategory","bill/:bill":"routeEBill","bill-detail/:bill":"routeOSBill","*defaultR":"routeDefault"},initialize:function(t){s.options=e.extend(s.defaultOptions,t),s.app=this,e.bindAll(this,"loadEBills"),this.mainView=new s.MainApplicationView(s.options),this.mainView.router=this,this.mainView.loading(),this.tabletop=l.init(e.extend(s.options.tabletopOptions,{key:s.options.eKey,callback:this.loadEBills,callbackContext:this,wanted:s.options.sheetsWanted}))},loadEBills:function(i,n){var l=this,a=s.parse.eData(n);this.categories=new s.CategoriesCollection(null),this.bills=new s.BillsCollection(null),e.each(a.bills,function(e){l.bills.add(s.utils.getModel("BillModel","bill",e))}),e.each(a.categories,function(e){l.categories.add(s.utils.getModel("CategoryModel","id",e))}),this.bills.each(function(e){e.loadCategories()}),s.options.aggregateURL?t.getJSON(s.options.aggregateURL).done(this.loadAggregateCounts):this.start()},loadAggregateCounts:function(t){var i=this;e.each(t,function(e){"total-bills"===e.stat&&(i.totalBills=parseInt(e.value,10)),"total-bills-passed"===e.stat&&(i.totalBillsPassed=parseInt(e.value,10)),"total-bills-signed"===e.stat&&(i.totalBillsSigned=parseInt(e.value,10))}),this.start()},start:function(){i.history.start()},routeDefault:function(){this.navigate("/categories",{trigger:!0,replace:!0}),this.mainView.render()},routeCategories:function(){var e=this;this.mainView.loading(),this.getOSBasicBills(function(){e.makeRecentCategory(),e.mainView.renderCategories()},this.error)},routeCategory:function(e){var t=this;e=decodeURI(e),e=this.categories.get(e),this.mainView.loading(),e.loadBills(function(){t.mainView.renderCategory(e)},t.error)},routeRecentCategory:function(){var e=this;this.mainView.loading(),this.getOSBasicBills(function(){e.makeRecentCategory();var t=e.categories.get("recent");t.loadBills(function(){e.mainView.renderCategory(t)},e.error)},this.error)},routeEBill:function(e){var t=this,i=decodeURI(e);return(e=this.bills.where({bill:i})[0])?(this.mainView.loading(),e.loadOSBills().done(function(){e.loadOSCompanion().done(function(){e.parseMeta(),t.mainView.renderEBill(e)})}).fail(t.error),void 0):(this.navigate("/bill-detail/"+encodeURI(i),{trigger:!0,replace:!0}),void 0)},routeOSBill:function(e){var i=this;e=decodeURI(e),e=s.utils.getModel("OSBillModel","bill_id",{bill_id:e}),this.mainView.loading(),t.when.apply(t,[s.utils.fetchModel(e)]).done(function(){i.mainView.renderOSBill(e)}).fail(i.error)},makeRecentCategory:function(){if(!this.madeRecentCategory){var e={id:"recent",title:"Recent Actions",description:"The following bills have been updated in the past "+s.options.recentChangeThreshold+" days.",image:s.options.recentImage};this.bills.each(function(t){var i=t.get("categories"),l=t.get("hasBill");l===!0&&Math.abs(parseInt(t.lastUpdatedAt().diff(n(),"days"),10))<s.options.recentChangeThreshold&&(i.push(e.id),t.set("categories",i))}),this.categories.add(s.utils.getModel("CategoryModel","id",e)),this.bills.each(function(e){e.loadCategories()}),this.madeRecentCategory=!0}},getOSBasicBills:function(i){var l=this,a=[];if(this.fetchedCategories)i.call(l);else{this.bills.each(function(t){e.each(["bill_primary","bill_companion","bill_conference"],function(e){t.get(e)&&a.push(t.get(e).get("bill_id"))})});var o="http://openstates.org/api/v1/bills/?state="+s.options.state+"&search_window=session:"+s.options.session+"&bill_id__in="+encodeURI(a.join("|"))+"&apikey="+s.options.OSKey+"&callback=?";t.getJSON(o).done(function(t){l.fetchedCategories=!0,e.each(t,function(e){e.created_at=n(e.created_at),e.updated_at=n(e.updated_at),s.utils.getModel("OSBillModel","bill_id",e).set(e)}),i.call(l)}).fail(this.error)}},error:function(e){this.mainView.error(e)}})});