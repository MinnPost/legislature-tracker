/*! legislature-tracker - v0.2.0-alpha - 2014-03-27
* https://github.com/MinnPost/legislature-tracker
* Copyright (c) 2014 ; Licensed MIT */

(function(e,t){if("undefined"!=typeof module&&module.exports&&"function"==typeof require)t(require("underscore"),require("jquery"),require("backbone"),require("moment"),require("tabletop"),require("ractive"));else if("function"==typeof define&&define.amd)define("LT",["underscore","jquery","backbone","moment","tabletop","Ractive"],t);else{if(!(e._&&e.jQuery&&e.Backbone&&e.moment&&e.Tabletop))throw Error("Could not find dependencies for Legislature Tracker.");e.LT=t(e._,e.jQuery,e.Backbone,e.moment,e.Tabletop,e.Ractive)}})("undefined"!=typeof window?window:this,function(e,t,i,n,s,l){var a,o={};return this.LTTemplates={"template-application":'<div class="ls">\n\n  {{#(menuOff !== true && !!categories)}}\n    <div class="ls-header-container">\n      <div class="ls-header">\n\n        <a class="all-categories-link" href="#/">\n          <img src="{{ options.imagePath }}back-100-85.png" />\n          All Categories\n        </a>\n\n        <span class="categories-nav">\n          &nbsp;&nbsp;|&nbsp;&nbsp;\n\n          {{#categories}}\n            <a class="" href="#/category/{{ id }}" title="{{ title }}">\n              {{ (short_title) ? short_title : title.split(\' \')[0] }}\n            </a>\n            &nbsp;&nbsp;\n          {{/categories}}\n        </span>\n      </div>\n    </div>\n  {{/()}}\n\n  {{#options.title}}\n    <h2>{{ options.title }}</h2>\n  {{/options.title}}\n\n  <div class="ls-content-container">\n    {{>loading}}\n  </div>\n</div>\n',"template-categories":'\n{{^categories}}\n  {{>loading}}\n{{/categories}}\n\n<div class="categories-container">\n  <ul class="category-list clear-block">\n    {{#categories:i}}\n      <li class="category-item category-item-{{ i }}">\n        <div class="category-inner category-{{ _.cssClass(id) }}">\n          {{#image}}\n            <a href="#/category/{{ encodeURI(id) }}">\n              <img class="category-image" src="{{ imagePath(image) }}" />\n            </a>\n          {{/image}}\n\n          <h3>\n            <a href="#/category/{{ encodeURI(id) }}">\n              {{ title }}\n            </a>\n          </h3>\n\n          <div>\n            Watching <strong>{{ bills.length }}</strong> bills.\n          </div>\n        </div>\n      </li>\n    {{/categories}}\n  </ul>\n</div>',"template-category":'\n{{^category}}\n  {{>loading}}\n{{/category}}\n\n<div class="category-container">\n  <h2>\n    {{#category.image}}\n      <img class="category-image" src="{{ imagePath(category.image) }}" />\n    {{/category.image}}\n\n    {{ category.title }}\n  </h2>\n\n  <p class="category-description">{{ category.description }}</p>\n\n  {{#(category.links && category.links.length && category.links.length > 0)}}\n    <div class="elinks">\n      <strong>In the news</strong>\n      <ul class="elinks-list">\n        {{#category.links}}\n          <li><a href="{{ url }}">{{ title }}</a></li>\n        {{/category.links}}\n      </ul>\n    </div>\n  {{/()}}\n\n  <div class="clear-block bills-list">\n    {{#category.bills:bill}}\n      <ebill bill="{{ this }}" compact="true" imagePath="{{ imagePath }}" options="{{ options }}">\n    {{/category.bills}}\n  </div>\n\n  <div class="clear-block total-bill">\n    Watching\n    <strong>{{ category.bills.length }}</strong>\n    {{#(typeof category.total_bill_count != \'undefined\')}}\n      of {{ category.total_bill_count }}\n    {{/()}}\n    bills in the {{ category.title }} category.\n  </div>\n</div>\n',"template-ebill":'\n<div class="bill ebill {{^bill.hasBill}}no-bill{{/bill.hasBill}}">\n  <div class="bill-status">\n    <img\n      class="lower {{#bill.bill_type.recent}}passed{{/bill.bill_type.recent}}"\n      src="{{ imagePath(\'RecentChanges.png\') }}"\n      title="{{#bill.bill_type.recent}}Recently changed{{/bill.bill_type.recent}}\n        {{^bill.bill_type.recent}}Not changed recently{{/bill.bill_type.recent}}"\n     />\n\n    <img\n      class="lower {{#bill.actions.lower}}passed{{/bill.actions.lower}}"\n      src="{{ imagePath(\'PassedHouse.png\') }}"\n      title="{{#bill.actions.lower}}Passed{{/bill.actions.lower}}\n        {{^bill.actions.lower}}Not passed (yet){{/bill.actions.lower}} {{ translate(\'chamber\', \'lower\') }}"\n     />\n\n    <img\n      class="lower {{#bill.actions.upper}}passed{{/bill.actions.upper}}"\n      src="{{ imagePath(\'PassedSenate.png\') }}"\n      title="{{#bill.actions.upper}}Passed{{/bill.actions.upper}}\n        {{^bill.actions.upper}}Not passed (yet){{/bill.actions.upper}} {{ translate(\'chamber\', \'upper\') }}"\n     />\n\n    {{#options.conferenceBill}}\n      <img\n        class="conference {{#bill.bill_type.conference}}passed{{/bill.bill_type.conference}}"\n        src="{{ imagePath(\'InConferenceCommittee.png\') }}"\n        title="{{#bill.bill_type.conference}}Conference bill created{{/bill.bill_type.conference}}\n          {{#bill.bill_type.conference}}Conference bill not created (yet){{/bill.bill_type.conference}}"\n       />\n    {{/options.conferenceBill}}\n\n   <img\n     class="signed {{#bill.actions.signed}}passed{{/bill.actions.signed}}"\n     src="{{ imagePath(\'SignedIntoLaw.png\') }}"\n     title="{{#bill.actions.signed}}Signed into law by the Governor{{/bill.actions.signed}}\n       {{#bill.actions.signed}}Not signed into law (yet){{/bill.actions.signed}}"\n    />\n  </div>\n\n  {{#compact}}\n    <h3>\n      {{ bill.title }}\n      <a class="permalink" title="Permanent link to bill" href="#/bill/{{ encodeURI(bill.bill) }}"></a>\n    </h3>\n  {{/compact}}\n  {{^compact}}\n    <h2>{{ bill.title }}</h2>\n  {{/compact}}\n\n  {{^bill.hasBill}}\n    <div class="latest-action">\n      <em>This bill has not been tracked by the legislature yet.</em>\n    </div>\n  {{/bill.hasBill}}\n\n  {{#bill.newest_action}}\n    <div class="latest-action">Last action about {{ date.fromNow() }}: {{ action }}.</div>\n  {{/bill.newest_action}}\n\n  <div class="description">\n    {{{ bill.description }}}\n  </div>\n\n  <div class="ebill-categories">\n    <strong>Categories:</strong>\n    {{#bill.categories:i}}\n      <a href="#/category/{{ id }}">\n        {{#image}}\n          <img class="category-image" src="{{ imagePath(image) }}" />\n        {{/image}}\n        {{ title }}\n      </a>{{#(i < bill.categories.length - 1)}},{{/()}}\n    {{/bill.categories}}\n  </div>\n\n  {{#(bill.links && bill.links.length && bill.links.length > 0)}}\n    <div class="elinks">\n      <strong>In the news</strong>\n      <ul class="elinks-list">\n        {{#bill.links}}\n          <li><a href="{{ url }}">{{ title }}</a></li>\n        {{/bill.links}}\n      </ul>\n    </div>\n  {{/()}}\n\n\n  {{#(compact == true)}}\n    <div class="osbills ebill-sponsors clear-block\n      {{#bill.bill_conference}}has-conference{{/bill.bill_conference}}\n      {{#bill.bill_primary}}has-primary{{/bill.bill_primary}}\n      {{#bill.bill_companion}}has-companion{{/bill.bill_companion}}\n      ">\n      {{#bill.bill_conference}}\n        <div class="osbill bill-conference">\n          <strong>Conference bill\n            {{#sources.0.url}}\n              <a href="{{ sources.0.url }}" target="_blank">{{ bill_id }}</a>\n            {{/sources.0.url}}\n            {{^sources.0.url}} {{ bill_id }} {{/sources.0.url}}\n          </strong>\n          {{#sponsors}}\n            <sponsor sponsor="{{ this }}" type="primary">\n          {{/sponsors}}\n        </div>\n      {{/bill.bill_conference}}\n\n      {{#bill.bill_primary}}\n        <div class="osbill bill-primary">\n          <strong>Primary bill\n            {{#sources.0.url}}\n              <a href="{{ sources.0.url }}" target="_blank">{{ bill_id }}</a>\n            {{/sources.0.url}}\n            {{^sources.0.url}} {{ bill_id }} {{/sources.0.url}}\n          </strong>\n          {{#sponsors}}\n            <sponsor sponsor="{{ this }}" type="primary">\n          {{/sponsors}}\n        </div>\n      {{/bill.bill_primary}}\n\n      {{#bill.bill_companion}}\n        <div class="osbill bill-companion">\n          <strong>Companion bill\n            {{#sources.0.url}}\n              <a href="{{ sources.0.url }}" target="_blank">{{ bill_id }}</a>\n            {{/sources.0.url}}\n            {{^sources.0.url}} {{ bill_id }} {{/sources.0.url}}\n          </strong>\n          {{#sponsors}}\n            <sponsor sponsor="{{ this }}" type="primary">\n          {{/sponsors}}\n        </div>\n      {{/bill.bill_companion}}\n    </div>\n\n    <div class="details-link">\n      <a title="See more details about bill" href="#/bill/{{ encodeURI(bill.bill) }}">More details\n        <img src="{{ options.imagePath }}forward-100-85.png" /></a>\n    </div>\n  {{/()}}\n\n\n  {{#(compact != true)}}\n    {{#(bill.custom_events && bill.custom_events.length && bill.custom_events.length > 0)}}\n      <div class="custom-events">\n        <strong>Events</strong>\n        <ul class="custom-events-inner">\n          {{#bill.custom_events}}\n            <li><strong>{{ bill_id }} {{ action }}</strong> on  {{ date.format(\'MMM DD, YYYY\') }}: {{ e.description }}</li>\n          {{/bill.custom_events}}\n        </ul>\n      </div>\n    {{/()}}\n\n    <div class="osbills clear-block\n      {{#bill.bill_conference}}has-conference{{/bill.bill_conference}}\n      {{#bill.bill_primary}}has-primary{{/bill.bill_primary}}\n      {{#bill.bill_companion}}has-companion{{/bill.bill_companion}}\n    ">\n\n      {{#bill.bill_conference}}\n        <div class="osbill conference-bill">\n          <h3>Conference Bill</h3>\n          <osbill bill="{{ this }}" type="conference" imagePath="{{ imagePath }}" translate="{{ translate }}" options="{{ options }}">\n        </div>\n      {{/bill.bill_conference}}\n\n      {{#bill.bill_primary}}\n        <div class="osbill primary-bill">\n          <h3>{{ (options.chamberLabel) ? translate(\'chamber\', chamber) + \' Bill\' : \'Primary Bill\' }}</h3>\n          <osbill bill="{{ this }}" type="primary" imagePath="{{ imagePath }}" translate="{{ translate }}" options="{{ options }}">\n        </div>\n      {{/bill.bill_primary}}\n\n      {{#bill.bill_companion}}\n        <div class="osbill companion-bill">\n          <h3>{{ (options.chamberLabel) ? translate(\'chamber\', chamber) + \' Bill\' : \'Companion Bill\' }}</h3>\n          <osbill bill="{{ this }}" type="companion" imagePath="{{ imagePath }}" translate="{{ translate }}" options="{{ options }}">\n        </div>\n      {{/bill.bill_companion}}\n  {{/()}}\n\n</div>\n',"template-error":'<div class="error-container">\n  <div class="error"><span>There was an error.</span></div>\n</div>',"template-legislator":"\n<div class=\"legislator\">\n  <% if (LT.options.legImageProxy) { %>\n    <img src=\"<%= LT.options.legImageProxy %><%= encodeURI(photo_url) %>\" />\n  <% } else { %>\n    <img src=\"<%= photo_url %>\" />\n  <% } %>\n  \n  <div class=\"legislator-info\">\n    <%= full_name %><br />\n    <% if (typeof district != 'undefined') { %>\n      District <%= district %>\n    <% } %>\n    <% if (typeof party != 'undefined') { %>\n      (<%= LT.utils.translate('partyAbbr', party) %>) \n    <% } %> <br />\n    <% if (typeof chamber != 'undefined') { %>\n      <%= LT.utils.translate('chamber', chamber) %>\n    <% } %>\n  </div>\n</div>","template-loading":'<div class="loading-general-container">\n  <div class="loading-general"><span>Loading...</span></div>\n</div>',"template-osbill":'\n<div class="osbill-container {{ type }}-bill">\n  <h4>\n    {{#(!!bill.title)}}\n      {{ bill.title }} ({{ bill.bill_id }})\n    {{/()}}\n\n    {{^(!!bill.title)}}\n      {{ bill.bill_id }}\n    {{/()}}\n  </h4>\n\n  <div class="primary-sponsors">\n    <strong>Primary sponsors</strong>\n    <div class="clear-block">\n      {{#bill.sponsors}}\n        <sponsor sponsor="{{ this }}" type="primary">\n      {{/bill.sponsors}}\n    </div>\n  </div>\n\n  <div class="actions">\n    <strong>Actions</strong>\n    <div class="actions-inner">\n      {{#bill.actions}}\n        {{#(!!date)}}\n          <div>\n            {{ date.format(\'MMM DD, YYYY\') }}:\n            {{ action }}\n            ({{ translate(\'chamber\', actor) }})\n          </div>\n        {{/())}}\n      {{/bill.actions}}\n    </div>\n  </div>\n\n  <div class="co-sponsors">\n    <strong>Co-Sponsors</strong>\n    <div>\n      {{#bill.sponsors}}\n        <sponsor sponsor="{{ this }}" type="cosponsor" compact="true">\n      {{/bill.sponsors}}\n    </div>\n  </div>\n\n  {{#(bill.votes && bill.votes.length && bill.votes.length > 0)}}\n    <div class="votes">\n      <strong>Votes</strong>\n      <div>\n        {{#bill.votes}}\n          {{ date.format(\'MMM DD, YYYY\') }}\n          {{ motion }} {{ (passed) ? \'passed\' : \'failed\' }}\n          {{ yes_count }} Y -\n          {{ no_count }} N <br />\n        {{/bill.votes}}\n      </div>\n    </div>\n  {{/()}}\n\n  <div class="sources">\n    <strong>Sources</strong>\n    <div>\n      {{#bill.sources}}\n        <a href="{{ url }}" target="_blank">\n          {{#(!!text)}}\n            {{ text }}\n          {{/()}}\n          {{#(!text)}}\n            {{ url }}\n          {{/()}}\n        </a> <br />\n      {{/bill.sources}}\n    </div>\n  </div>\n</div>\n',"template-sponsor":'\n{{#(((!!type && sponsor.type === type) || !type) && !compact)}}\n\n  <div class="sponsor clear-block">\n    {{#sponsor.leg.photo_url}}\n      <div class="sponsor-image">\n        {{#options.legImageProxy}}\n          <img src="{{ options.legImageProxy }}{{ encodeURI(sponsor.leg.photo_url) }}" />\n        {{/options.legImageProxy}}\n        {{^options.legImageProxy}}\n          <img src="{{ sponsor.leg.photo_url }}" />\n        {{/options.legImageProxy}}\n      </div>\n    {{/sponsor.leg.photo_url}}\n\n    <div class="sponsor-info">\n      {{#sponsor.leg.full_name}}\n        {{ sponsor.leg.full_name }} <br />\n        District {{ sponsor.leg.district }}\n        ({{ translate(\'chamber\', sponsor.leg.chamber) }}) <br />\n        {{ translate(\'partyAbbr\', sponsor.leg.party) }}\n      {{/sponsor.leg.full_name}}\n\n      {{^sponsor.leg.full_name}}\n        {{ sponsor.name }}\n      {{/sponsor.leg.full_name}}\n    </div>\n  </div>\n{{/()}}\n\n\n{{#(((!!type && sponsor.type === type) || !type) && !!compact)}}\n  <div class="sponsor">\n    {{#sponsor.leg.full_name}}\n      {{ sponsor.leg.full_name }},\n      {{ translate(\'partyAbbr\', sponsor.leg.party) }}\n    {{/sponsor.leg.full_name}}\n\n    {{^sponsor.leg.full_name}}\n      {{ sponsor.name }}\n    {{/sponsor.leg.full_name}}\n  </div>\n{{/()}}\n'},e.mixin({filterEmpty:function(t){return e.filter(t,function(e){return e})},filterObject:function(t,i,n){return e.reduce(t,function(e,s,l){return i.call(n,s,l,t)&&(e[l]=s),e},{},n)},mapObject:function(t,i,n){return e.reduce(t,function(e,s,l){return e[l]=i.call(n,s,l,t),e},{},n)},trim:function(t){return e.isString(t)&&(t=String.prototype.trim?t.trim():t.replace(/^\s+|\s+$/g,"")),t},cssClass:function(e){return e.replace(/[^a-z0-9]/g,"-")},numberFormatCommas:function(e){return(""+e).replace(/\B(?=(\d{3})+(?!\d))/g,",")},ellipsisText:function(e,t){var i,n,s,l,a="",o="<!-- break -->",r='<ins class="ellipsis-start">[[[TEXT]]]</ins>',c='<ins class="ellipsis-ellipsis">...</ins>',p='<ins class="ellipsis-end">[[[TEXT]]]</ins>';return-1!==e.indexOf(o)?(i=e.indexOf(o),a+=r.replace("[[[TEXT]]]",e.substring(0,i))+" ",a+=c+" ",a+=p.replace("[[[TEXT]]]",e.substring(i,e.length))+" "):(l=e.split(" "),t>=l.length?a+=r.replace("[[[TEXT]]]",e):(n=l.slice(0,t),s=l.slice(t),a+=r.replace("[[[TEXT]]]",n.join(" "))+" ",a+=c+" ",a+=p.replace("[[[TEXT]]]",s.join(" "))+" ")),a},parseURL:function(e){var t=document.createElement("a");return t.href=e,t}}),i.ajax=function(){var e=arguments;return e[0].dataTypeForce!==!0&&(e[0].dataType="jsonp"),i.$.ajax.apply(i.$,e)},t.fn.hasScrollBar=function(){return this.get(0)&&this.get(0).scrollHeight?this.get(0).scrollHeight>this.height():!1},function(){var e,t;if(!l||!i)throw Error("Could not find Ractive or Backbone! Check your paths config");l.adaptors.Backbone={filter:function(e){return e instanceof i.Model||e instanceof i.Collection,e instanceof i.Model||e instanceof i.Collection},wrap:function(n,s,l,a){return s instanceof i.Model?new e(n,s,l,a):new t(n,s,l,a)}},e=function(e,t,i,n){var s=this;this.value=t,t.on("change",this.modelChangeHandler=function(){s.setting=!0,e.set(n(t.changed)),s.setting=!1}),t.on("sync",this.modelSyncHandler=function(){e.update(i)})},e.prototype={teardown:function(){this.value.off("change",this.changeHandler),this.value.off("sync",this.modelSyncHandler)},get:function(){return this.value.attributes},set:function(e,t){this.setting||-1!==e.indexOf(".")||this.value.set(e,t)},reset:function(e){return e instanceof i.Model||"object"!=typeof e?!1:(this.value.reset(e),void 0)}},t=function(e,t,i){var n=this;this.value=t,t.on("add remove reset",this.changeHandler=function(){n.setting=!0,e.set(i,t.models),n.setting=!1}),t.on("sort",this.sortHandler=function(){n.setting=!0,e.update(i),n.setting=!1})},t.prototype={teardown:function(){this.value.off("add remove reset",this.changeHandler),this.value.off("sort",this.sortHandler)},get:function(){return this.value.models},reset:function(e){return this.setting?void 0:e instanceof i.Collection||"[object Array]"!==Object.prototype.toString.call(e)?!1:(this.value.reset(e),void 0)}}}(),o.parsers=o.parsers||{},o.log=function(t){e.isObject(console)&&e.isFunction(console.log)&&console.log(t)},o.parsers.eData=function(t,i){var n={},s=t.sheets("Bills").all();return s.length>i.maxBills&&o.log("The number of bills in your spreadsheet exceeds maxBills. Set the maxBills option to display them, but be aware that this may significantly slow down the Legislature Tracker."),n.categories=o.parsers.eCategories(t.sheets("Categories").all(),i),n.bills=o.parsers.eBills(s.slice(0,i.maxBills),i),n.events=o.parsers.eEvents(t.sheets("Events").all(),i),e.each(e.groupBy(n.events,"bill_id"),function(t,i){e.each(n.bills,function(e,s){e.bill===i&&(n.bills[s].custom_events=t)})}),n},o.parsers.validateBillNumber=function(e,t){return t.billNumberFormat.test(e)},o.parsers.eBills=function(t,i){return e.map(t,function(t){return o.parsers.translateFields(i.fieldTranslations.eBills,t),t.links=o.parsers.eLinks(t.links),t.categories=t.categories?t.categories.split(","):[],t.categories=e.map(t.categories,e.trim),t.bill_primary=e.trim(t.bill),t.bill&&!o.parsers.validateBillNumber(t.bill,i)&&o.log('Invalid primary bill number "'+t.bill+'" for row '+t.rowNumber+", see documentation."),t.bill_companion=e.trim(t.bill_companion),t.bill_companion&&!o.parsers.validateBillNumber(t.bill_companion,i)&&o.log('Invalid companion bill number "'+t.bill_companion+'" for row '+t.rowNumber+", see documentation."),t.bill_conference=e.trim(t.bill_conference),t.bill_conference&&!o.parsers.validateBillNumber(t.bill_conference,i)&&o.log('Invalid conference bill number "'+t.bill_conference+'" for row '+t.rowNumber+", see documentation."),t.hasBill=!0,t.bill&&t.bill_primary||(t.hasBill=!1,t.bill=e.cssClass(t.title.toLowerCase())),t})},o.parsers.eCategories=function(t,i){return e.map(t,function(e){return o.parsers.translateFields(i.fieldTranslations.eCategories,e),e.links=o.parsers.eLinks(e.links),e})},o.parsers.eEvents=function(t,i){return e.map(t,function(e){return o.parsers.translateFields(i.fieldTranslations.eEvents,e),e.links=o.parsers.eLinks(e.links),e.date=n(e.date),e.type=["custom"],e})},o.parsers.eLinks=function(t){var i=[];return t=e.trim(t),0===t.length?i:(t='"'===t.substring(0,1)?t.substring(1):t,t='"'===t.substring(t.length-1,t.length)?t.slice(0,-1):t,i=t.split('", "'),i=e.map(i,function(e){return{title:e.split("|")[0],url:e.split("|")[1]}}))},o.parsers.csvCategories=function(t){return t=e.trim(t),0===t.length?[]:(t='"'===t.substring(0,1)?t.substring(1):t,t='"'===t.substring(t.length-1,t.length)?t.slice(0,-1):t,t.split('", "'))},o.parsers.detectCompanionBill=function(t,i){var n,s;return e.isFunction(i.detectCompanionBill)?(n=i.detectCompanionBill(t),s=o.parsers.validateBillNumber(n,i)?n:void 0):e.isRegExp(i.detectCompanionBill)&&(n=i.detectCompanionBill.exec(t),s=n&&o.parsers.validateBillNumber(n[1],i)?n[1]:void 0),e.trim(s)},o.parsers.translateFields=function(t,i){return e.each(t,function(e,t){i[t]=i[e],t!==e&&delete i[e]}),i},o.BaseModel=i.Model.extend({initialize:function(e,t){this.options=t,this.app=this.options.app,this.on("sync",function(e){e.set("fetched",!0)})}}),o.OSModel=o.BaseModel.extend({urlBase:function(){return"http://openstates.org/api/v1/"},urlEnd:function(){return"/?apikey="+encodeURI(this.app.options.OSKey)+"&callback=?"},url:function(){return this.urlBase()+encodeURI(this.osType)+"/"+encodeURI(this.id)+this.urlEnd()},initialize:function(){o.OSModel.__super__.initialize.apply(this,arguments)}}),o.OSStateModel=o.OSModel.extend({url:function(){return this.urlBase()+"metadata/"+encodeURI(this.options.state)+this.urlEnd()}}),o.OSLegislatorModel=o.OSModel.extend({osType:"legislators",initialize:function(){o.OSBillModel.__super__.initialize.apply(this,arguments),this.get("leg_id")&&this.app.fetchModel(this)}}),o.OSCommitteeModel=o.OSModel.extend({osType:"committees"}),o.OSBillModel=o.OSModel.extend({url:function(){return e.isUndefined(this.id)?e.isUndefined(this.get("bill_id"))||""===this.get("bill_id")?void 0:this.urlBase()+"bills/"+encodeURI(this.app.options.state)+"/"+encodeURI(this.app.options.session)+"/"+encodeURI(this.get("bill_id"))+this.urlEnd():this.urlBase()+"bills/"+this.id+this.urlEnd()},initialize:function(){o.OSBillModel.__super__.initialize.apply(this,arguments)},parse:function(t){var i=this;return t.created_at=t.created_at?n(t.created_at):void 0,t.updated_at=t.updated_at?n(t.updated_at):void 0,t.action_dates=e.filterObject(t.action_dates,function(e){return e}),t.action_dates=e.mapObject(t.action_dates,function(e){return n(e)}),t.actions=e.mapObject(t.actions,function(e){return e.date=n(e.date),e}),t.votes=e.mapObject(t.votes,function(e){return e.date=n(e.date),e}),this.get("custom_events")&&(t.actions=e.union(t.actions,this.get("custom_events"))),t.actions=e.sortBy(t.actions,function(e,t){return-1*(e.date.unix()+t)}),t.newest_action=t.actions[0],this.app.options.osBillParse&&e.isFunction(this.app.options.osBillParse)&&(t=this.options.osBillParse(t,this)),t.sponsors&&(t.sponsors=e.map(t.sponsors,function(e){return e.id=e.leg_id,e.leg=i.app.getModel("OSLegislatorModel","leg_id",e),e})),t},getActionDate:function(e){return this.get("action_dates")[e]?this.get("action_dates")[e]:!1},isSubstituted:function(){var t=!1,i=this;return e.isBoolean(this.get("substitued"))?t=this.get("substitued"):this.app.options.substituteMatch===!1?t=!1:(t=e.find(this.get("actions"),function(e){return e.action.match(i.app.options.substituteMatch)}),t=t?!0:!1,this.set("substitued",t)),t}}),o.BillModel=o.BaseModel.extend({subbills:["bill_primary","bill_companion","bill_conference"],initialize:function(){o.BillModel.__super__.initialize.apply(this,arguments),this.loadOSBills()},loadOSBills:function(){var t=this;e.each(this.subbills,function(e){var i;t.get(e)&&(i=t.app.getModel("OSBillModel","bill_id",{bill_id:t.get(e)}),t.set(e,i))})},getOSBills:function(){var t=this;return e.filterEmpty(e.map(this.subbills,function(e){return t.get(e)}))},getOSBillIDs:function(){var t=this.getOSBills();return e.filterEmpty(e.map(t,function(t){return e.isObject(t)?t.get("bill_id"):t}))},fetchOSBills:function(){var i=this,n=[];return this.getCategories(),e.each(this.subbills,function(e){i.get("hasBill")&&i.get(e)&&n.push(i.app.fetchModel(i.get(e)))}),t.when.apply(t,n).done(function(){i.loadOSCompanion().done(function(){i.parseMeta(),i.lastUpdatedAt(),i.newestAction(),i.trigger("fetched:osbills")})})},fetch:function(){return this.fetchOSBills()},loadOSCompanion:function(){var i,n=this,s=[];return this.get("hasBill")===!0&&!this.get("bill_companion")&&e.isObject(this.get("bill_primary"))&&e.isArray(this.get("bill_primary").get("companions"))&&e.isObject(this.get("bill_primary").get("companions")[0])&&(i=o.parse.detectCompanionBill(this.get("bill_primary").get("companions")[0].bill_id),i&&(this.set("bill_companion",n.app.getModel("OSBillModel","bill_id",{bill_id:i})),s.push(n.app.fetchModel(this.get("bill_companion"))))),t.when.apply(t,s)},getCategories:function(){var t=this;this.get("categories")&&this.set("categories",e.map(this.get("categories"),function(i){return e.isObject(i)||(i=t.app.getModel("CategoryModel","id",{id:i})),i}))},lastUpdatedAt:function(){var e,t=this.get("bill_primary"),i=this.get("bill_companion"),n=this.get("bill_conference");return t&&t.get("updated_at")&&(e=t.get("updated_at"),i&&i.get("updated_at")&&(e=i.get("updated_at").unix()>e.unix()?i.get("updated_at"):e),n&&n.get("updated_at")&&(e=n.get("updated_at").unix()>e.unix()?n.get("updated_at"):e),this.set("last_updated_at",e)),this.get("last_updated_at")},newestAction:function(){var e,t=this.get("bill_primary"),i=this.get("bill_companion"),n=this.get("bill_conference");return this.get("hasBill")&&t.get("newest_action")&&(e=t.get("newest_action"),i&&i.get("newest_action")&&(e=i.get("newest_action").date.unix()>e.date.unix()?i.get("newest_action"):e),n&&n.get("newest_action")&&(e=n.get("newest_action").date.unix()>e.date.unix()?n.get("newest_action"):e),this.set("newest_action",e)),this.get("newest_action")},isRecent:function(){var t=this.newestAction(),i=this.get("bill_primary")?this.get("bill_primary").get("action_dates"):null;return e.isObject(t)&&t.date&&n().diff(t.date,"days")<=this.app.options.recentChangeThreshold?!0:e.isObject(i)&&i.last&&n().diff(i.last,"days")<=this.app.options.recentChangeThreshold?!0:!1},parseMeta:function(){var t,i,n=this,s={upper:!1,lower:!1,conference:!1,signed:!1,last:!1},l={companion:this.get("bill_companion")?!0:!1,conference:this.get("bill_conference")?!0:!1};if(this.get("custom_events")&&this.set("custom_events",e.sortBy(this.get("custom_events"),function(e,t){return-1*(e.date.unix()+t)})),this.get("hasBill")){if(l.companion&&(this.get("bill_companion").isSubstituted()&&(l.substituted=!0),this.get("bill_primary").isSubstituted()&&(l.substituted=!0,t=this.get("bill_primary").get("bill_id"),i=this.get("bill_companion").get("bill_id"),this.unset("bill_primary"),this.set("bill_primary",function(){return n.app.getModel("OSBillModel","bill_id",{bill_id:i})}()),this.unset("bill_companion"),this.set("bill_companion",function(){return n.app.getModel("OSBillModel","bill_id",{bill_id:t})}()))),(!l.companion||l.substituted)&&(s.lower=this.get("bill_primary").getActionDate("passed_lower"),s.upper=this.get("bill_primary").getActionDate("passed_upper")),l.companion&&!l.substituted&&("upper"===this.get("bill_primary").get("chamber")?(s.upper=this.get("bill_primary").getActionDate("passed_upper"),s.lower=this.get("bill_companion").getActionDate("passed_lower")):(s.lower=this.get("bill_primary").getActionDate("passed_lower"),s.upper=this.get("bill_companion").getActionDate("passed_upper"))),l.conference){var a=this.get("bill_conference").getActionDate("passed_lower"),o=this.get("bill_conference").getActionDate("passed_upper");a&&o&&(s.conference=a.unix()>=o.unix()?a:o)}s.signed=l.conference?this.get("bill_conference").getActionDate("signed"):this.get("bill_primary").getActionDate("signed"),s.last=l.conference?this.get("bill_conference").getActionDate("last"):l.companion?this.get("bill_companion").getActionDate("last").unix()>=this.get("bill_primary").getActionDate("last").unix()?this.get("bill_companion").getActionDate("last"):this.get("bill_primary").getActionDate("last"):this.get("bill_primary").getActionDate("last"),this.get("description")||this.set("description",this.get("bill_primary").get("summary"))}return l.recent=this.isRecent(),this.set("actions",s),this.set("bill_type",l),this.trigger("change"),this}}),o.CategoryModel=o.BaseModel.extend({initialize:function(){o.CategoryModel.__super__.initialize.apply(this,arguments),this.set("bills",new o.BillsCollection(null))},getBills:function(t){var i=this,n=this.get("id");return t.each(function(t){-1!==e.indexOf(t.get("categories"),n)&&i.get("bills").push(i.app.getModel("BillModel","bill",t.attributes))}),this}}),o.CategoriesCollection=i.Collection.extend({model:o.CategoryModel,comparator:function(e){return-1!==e.get("title").toLowerCase().indexOf("recent")?"zzzzz":e.get("title")}}),o.BillsCollection=i.Collection.extend({model:o.BillModel,comparator:function(e){return e.newestAction()?-1*e.newestAction().date.unix():9999}}),o.OSBillsCollection=i.Collection.extend({model:o.OSBillModel,comparator:function(e){var t=e.get("newest_action");return t?-1*t.date.unix():9999}}),o.OSLegislatorsCollection=i.Collection.extend({model:o.OSLegislatorModel,comparator:function(e){return("primary"===e.get("type")?"aaa":"bbb")+e.get("name")}}),o.BaseView=l.extend({baseInit:function(e){this.options=e.options,this.app=e.app,this.router=e.router},adaptors:["Backbone"]}),o.ApplicationView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.CategoriesView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.CategoryView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.EBillView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.OSBillView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.OSSponsorView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.MainRouter=i.Router.extend({routes:{categories:"routeCategories","category/recent":"routeRecentCategory","category/:category":"routeCategory","bill/:bill":"routeEBill","*defaultR":"routeDefault"},initialize:function(t){t.router=this,this.options=t,this.app=t.app,this.app.views.application=new o.ApplicationView({el:this.app.$el,template:this.app.templates.application,data:{options:this.options,categories:this.app.categories},options:this.options,partials:{loading:this.app.templates.loading}}),this.$content=this.app.$el.find(".ls-content-container"),this.imagePath=e.bind(this.app.imagePath,this.app),this.translate=e.bind(this.app.translate,this.app)},start:function(){i.history.start()},routeDefault:function(){this.navigate("/categories",{trigger:!0,replace:!0})},routeCategories:function(){this.app.fetchBasicBillData(),this.app.views.application.set("menuOff",!0),e.isObject(this.app.views.categories)&&this.app.views.categories.teardown(),this.app.views.categories=new o.CategoriesView({el:this.$content,template:this.app.templates.categories,data:{options:this.options,categories:this.app.categories,imagePath:this.imagePath},options:this.options,partials:{loading:this.app.templates.loading}})},routeCategory:function(t,i){i=i||!0;var n=decodeURI(t),s={options:this.options,imagePath:this.imagePath,translate:this.translate};t=this.app.categories.get(n),this.app.views.application.set("menuOff",!1),t||this.navigate("/",{trigger:!0,replace:!0}),e.isObject(this.app.views.category)&&this.app.views.category.teardown(),i&&this.app.fetchOSBillsFromCategory(t),this.app.views.category=new o.CategoryView({el:this.$content,template:this.app.templates.category,data:e.extend({},s,{category:t,categoryID:n}),options:this.options,partials:{loading:this.app.templates.loading},components:{ebill:o.EBillView.extend({template:this.app.templates.ebill,data:s,components:{osbill:o.OSBillView.extend({template:this.app.templates.osbill,data:s}),sponsor:o.OSSponsorView.extend({template:this.app.templates.sponsor,data:s})}})}}),this.app.on("fetched:osbills:category:"+t.id,function(){t.get("bills").sort()})},routeRecentCategory:function(){var e=this;this.app.fetchBasicBillData().done(function(){e.app.fetchOSBillsFromCategory(e.app.categories.get("recent"))}),this.routeCategory("recent",!1)},routeEBill:function(t){var i=decodeURI(t),n={options:this.options,imagePath:this.imagePath,translate:this.translate};t=this.app.bills.where({bill:i})[0],this.app.views.application.set("menuOff",!1),t||this.navigate("/",{trigger:!0,replace:!0}),e.isObject(this.app.views.bill)&&this.app.views.bill.teardown(),t.fetchOSBills(),this.app.views.bill=new o.EBillView({el:this.$content,template:this.app.templates.ebill,data:e.extend({},n,{bill:t,billID:i}),options:this.options,partials:{loading:this.app.templates.loading},components:{osbill:o.OSBillView.extend({template:this.app.templates.osbill,data:n,components:{sponsor:o.OSSponsorView.extend({template:this.app.templates.sponsor,data:n})}})}})
},error:function(){}}),a=function(i){this.options=e.extend({},this.defaultOptions,i),this.options.app=this,this.options.$el=this.$el=t(this.options.el),this.on("fetched:base-data",this.loadBaseData),this.on("loaded:basic-bill-data",this.loadRecentCategory),this.categories=new o.CategoriesCollection(null),this.bills=new o.BillsCollection(null),this.getTemplates(),this.fetchBaseData(),this.router=new o.MainRouter(this.options),this.on("loaded:base-data",this.startRouting)},e.extend(a.prototype,i.Events),e.extend(a.prototype,{views:{},cache:{},fetched:{},startRouting:function(){this.router.start()},fetchBaseData:function(){var t=this;this.fetched.baseData!==!0&&(this.tabletop=s.init(e.extend(this.options.tabletopOptions,{key:this.options.eKey,callback:function(e,i){t.fetched.baseData=!0,t.trigger("fetched:base-data",e,i)},callbackContext:t,wanted:this.options.sheetsWanted})))},loadBaseData:function(t,i){var n,s,l=this;s=o.parsers.eData(i,this.options),e.each(s.categories,function(e){this.categories.add(this.getModel("CategoryModel","id",e))},this),e.each(s.bills,function(e){this.bills.add(this.getModel("BillModel","bill",e))},this),n={id:"recent",title:"Recent Actions",description:"The following bills have been updated in the past "+this.options.recentChangeThreshold+" days.",image:this.options.recentImage},this.categories.add(this.getModel("CategoryModel","id",n)),this.categories.each(function(e){e.getBills(l.bills)}),this.trigger("loaded:base-data")},fetchBasicBillData:function(){var i,s=this,l=[];return this.fetched.basicBillData===!0?t.when.apply(t,[]):(this.bills.each(function(t){e.each(t.getOSBillIDs(),function(e){l.push(e)})}),i="http://openstates.org/api/v1/bills/?state="+this.options.state+"&fields=action_dates,chamber,title,id,created_at,updated_at,bill_id"+"&search_window=session:"+this.options.session+"&bill_id__in="+encodeURI(l.join("|"))+"&apikey="+this.options.OSKey+"&callback=?",t.getJSON(i).done(function(t){s.fetched.basicBillData=!0,s.trigger("fetched:basic-bill-data"),e.each(t,function(t){t.action_dates=e.filterObject(t.action_dates,function(e){return e}),t.action_dates=e.mapObject(t.action_dates,function(e){return n(e)}),t.created_at=n(t.created_at),t.updated_at=n(t.updated_at),s.getModel("OSBillModel","bill_id",t).set(t)}),s.trigger("loaded:basic-bill-data")}))},loadRecentCategory:function(){var e=this.getModel("CategoryModel","id",{id:"recent"});this.bills.each(function(t){var i=t.get("categories");t.isRecent()&&(i.push(e.get("id")),t.set("categories",i))}),e.getBills(this.bills)},fetchOSBillsFromBill:function(){category.get("id");var t=[];e.each(category.get("bills"),function(e){t.push(e.fetch())})},fetchOSBillsFromCategory:function(e){var i=this,n=[];return e.getBills(this.bills),e.get("bills").each(function(e){n.push(i.fetchModel(e))}),t.when.apply(t,n).done(function(){i.trigger("fetched:osbills"),i.trigger("fetched:osbills:category:"+e.id)})},getModel:function(t,i,n,s){var l="models:"+t+":"+i+":"+n[i];return s=e.extend(s||{},{app:this}),e.isUndefined(this.cache[l])&&(this.cache[l]=new o[t](n,s)),this.cache[l]},fetchModel:function(e){var i;return e.get("fetched")!==!0?e.fetch({success:function(e){e.set("fetched",!0,{silent:!0})}}):(i=t.Deferred(),i.resolveWith(e),i)},translate:function(t,i){var n=i;return e.isObject(this.options.wordTranslations[t])&&e.isString(this.options.wordTranslations[t][i])&&(n=this.options.wordTranslations[t][i]),n},imagePath:function(e){return 0===e.indexOf("http")?e:this.options.imagePath+e},getTemplate:function(e){return o.templates[e]},templates:{},getTemplates:function(){this.templates.application=this.getTemplate("template-application"),this.templates.loading=this.getTemplate("template-loading"),this.templates.error=this.getTemplate("template-error"),this.templates.ebill=this.getTemplate("template-ebill"),this.templates.osbill=this.getTemplate("template-osbill"),this.templates.category=this.getTemplate("template-category"),this.templates.categories=this.getTemplate("template-categories"),this.templates.sponsor=this.getTemplate("template-sponsor")},defaultOptions:{sheetsWanted:["Categories","Bills","Events"],fieldTranslations:{eCategories:{id:"categoryid",short_title:"shorttitle"},eBills:{bill:"bill",bill_companion:"companionbill",bill_conference:"conferencebill",categories:"categories",title:"title",description:"description"},eEvents:{bill_id:"bill",actor:"chamber",action:"title"}},wordTranslations:{chamber:{upper:"Senate",lower:"House"},partyAbbr:{"Democratic-Farmer-Labor":"DFL",Democratic:"D",Republican:"R"}},maxBills:30,substituteMatch:/substituted/i,imagePath:"./styles/images/",templatePath:"./js/app/templates/",recentChangeThreshold:7,tabletopOptions:{},scrollOffset:!1,conferenceBill:!0,recentImage:"RecentUpdatedBill.png",chamberLabel:!1,detectCompanionBill:/([A-Z]+ [1-9][0-9]*)$/,billNumberFormat:/[A-Z]+ [1-9][0-9]*/,osBillParse:!1}}),o.templates=this.LTTemplates,a});