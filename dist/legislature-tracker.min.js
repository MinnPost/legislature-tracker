/*! legislature-tracker - v0.1.0 - 2014-03-24
* https://github.com/MinnPost/legislature-tracker
* Copyright (c) 2014 ; Licensed MIT */

(function(e,t){if("undefined"!=typeof module&&module.exports&&"function"==typeof require)t(require("underscore"),require("jquery"),require("backbone"),require("moment"),require("tabletop"),require("ractive"));else if("function"==typeof define&&define.amd)define("LT",["underscore","jquery","backbone","moment","tabletop","Ractive"],t);else{if(!(e._&&e.jQuery&&e.Backbone&&e.moment&&e.Tabletop))throw Error("Could not find dependencies for Legislature Tracker.");e.LT=t(e._,e.jQuery,e.Backbone,e.moment,e.Tabletop,e.Ractive)}})("undefined"!=typeof window?window:this,function(e,t,i,n,s,l){var a,o={};return this.LTTemplates={"template-application":'<div class="ls">\n  <div class="ls-header-container">\n    <div class="ls-header">\n\n      <a class="all-categories-link" href="#/">\n        <img src="{{ options.imagePath }}back-100-85.png" />\n        All Categories\n      </a>\n\n      <span class="categories-nav">\n        &nbsp;&nbsp;|&nbsp;&nbsp;\n\n        {{#categories}}\n          <a class="" href="#/category/{{ id }}" title="{{ title }}">\n            {{ (short_title) ? short_title : title.split(\' \')[0] }}\n          </a>\n          &nbsp;&nbsp;\n        {{/categories}}\n      </span>\n    </div>\n  </div>\n\n  {{#options.title}}\n    <h2>{{ options.title }}</h2>\n  {{/options.title}}\n\n  <div class="ls-content-container">\n    {{>loading}}\n  </div>\n</div>',"template-categories":'\n{{^categories}}\n  {{>loading}}\n{{/categories}}\n\n<div class="categories-container">\n  <ul class="category-list clear-block">\n    {{#categories:i}}\n      <li class="category-item category-item-{{ i }}">\n        <div class="category-inner category-{{ _.cssClass(id) }}">\n          {{#image}}\n            <a href="#/category/{{ encodeURI(id) }}">\n              <img class="category-image" src="{{ imagePath(image) }}" />\n            </a>\n          {{/image}}\n\n          <h3>\n            <a href="#/category/{{ encodeURI(id) }}">\n              {{ title }}\n            </a>\n          </h3>\n\n          <div>\n            Watching <strong>{{ bills.length }}</strong> bills.\n          </div>\n        </div>\n      </li>\n    {{/categories}}\n  </ul>\n</div>',"template-category":'\n{{^category}}\n  {{>loading}}\n{{/category}}\n\n<div class="category-container">\n  <h2>\n    {{#category.image}}\n      <img class="category-image" src="{{ imagePath(category.image) }}" />\n    {{/category.image}}\n\n    {{ category.title }}\n  </h2>\n\n  <p>{{ category.description }}</p>\n\n  {{#(category.links && category.links.length && category.links.length > 0)}}\n    <div class="e-links">\n      <h4>In the news</h4>\n\n      <ul class="e-links-list">\n        {{#category.links}}\n          <li><a href="{{ url }}">{{ title }}</a></li>\n        {{/category.links}}\n      </ul>\n    </div>\n  {{/()}}\n\n  <div class="clear-block bills-list">\n    {{#category.bills:bill}}\n      <ebill bill="{{ this }}" compact="true" imagePath="{{ imagePath }}" options="{{ options }}">\n    {{/category.bills}}\n  </div>\n\n  <div class="clear-block total-bill">\n    Watching\n    <strong>{{ category.bills.length }}</strong>\n    {{#(typeof category.total_bill_count != \'undefined\')}}\n      of {{ category.total_bill_count }}\n    {{/()}}\n    bills in the {{ category.title }} category.\n  </div>\n</div>\n',"template-ebill":'\n\n<div class="bill ebill {{^bill.hasBill}}no-bill{{/bill.hasBill}}">\n  <div class="bill-top">\n    <div class="bill-status">\n      <img\n        class="lower {{#(bill.newest_action && Math.abs(parseInt(bill.newest_action.date.diff(moment(), \'days\'))) < options.recentChangeThreshold)}}passed{{/()}}"\n        src="{{ imagePath(\'RecentChanges.png\') }}"\n        title="{{#(bill.newest_action && Math.abs(parseInt(bill.newest_action.date.diff(moment(), \'days\'))) < options.recentChangeThreshold)}}Recently changed{{/()}}\n        {{^(bill.newest_action && Math.abs(parseInt(bill.newest_action.date.diff(moment(), \'days\'))) < options.recentChangeThreshold)}}Not changed recently{{/()}}"\n       />\n\n      <img\n        class="lower {{#(bill.actions && bill.actions.lower)}}passed{{/()}}"\n        src="{{ imagePath(\'PassedHouse.png\') }}"\n        title="{{#(bill.actions && bill.actions.lower)}}Passed{{/()}}\n          {{^(bill.actions && bill.actions.lower)}}Not passed{{/()}} {{ translate(\'chamber\', \'lower\') }}"\n       />\n\n      <img\n        class="upper {{#(bill.actions && bill.actions.upper)}}passed{{/()}}"\n        src="{{ imagePath(\'PassedSenate.png\') }}"\n        title="{{#(bill.actions && bill.actions.upper)}}Passed{{/()}}\n          {{^(bill.actions && bill.actions.upper)}}Not passed{{/()}} {{ translate(\'chamber\', \'upper\') }}"\n       />\n\n      {{#options.conferenceBill}}\n        <img\n          class="conference {{#(bill.bill_type && bill.bill_type.conference)}}passed{{/()}}"\n          src="{{ imagePath(\'InConferenceCommittee.png\') }}"\n          title="{{#(bill.bill_type && bill.bill_type.conference)}}Conference bill created{{/()}}\n            {{^(bill.bill_type && bill.bill_type.conference)}}Coinference bill not created{{/()}}"\n         />\n      {{/options.conferenceBill}}\n\n     <img\n       class="signed {{#(bill.actions && bill.actions.signed)}}passed{{/()}}"\n       src="{{ imagePath(\'SignedIntoLaw.png\') }}"\n       title="{{#(bill.actions && bill.actions.signed)}}Signed into law by the Governor{{/()}}\n         {{^(bill.actions && bill.actions.upper)}}Not signed into law{{/()}}"\n      />\n    </div>\n\n    <h3>\n      {{ bill.title }}\n      <a class="permalink" title="Permanent link to bill" href="#/bill/{{ encodeURI(bill.bill) }}"></a>\n    </h3>\n\n    {{^bill.hasBill}}\n      <div class="latest-action">\n        <em>This bill has not been tracked by the legislature yet.</em>\n      </div>\n    {{/bill.hasBill}}\n\n    {{#bill.newest_action}}\n      <div class="latest-action">Last action {{ date.fromNow() }}.</div>\n    {{/bill.newest_action}}\n\n    <div class="description">\n      {{ bill.description }}\n    </div>\n\n    <div class="e-bill-categories">\n      <strong>Categories:</strong>\n      {{#bill.categories:i}}\n        <a href="#/category/{{ id }}">\n          {{#image}}\n            <img class="category-image" src="{{ imagePath(image) }}" />\n          {{/image}}\n          {{ title }}\n        </a>{{#(i < bill.categories.length - 1)}},{{/()}}\n      {{/bill.categories}}\n    </div>\n  </div>\n\n\n  <div class="bill-bottom">\n    {{#(bill.links && bill.links.length && bill.links.length > 0)}}\n      <div class="e-links">\n        <h4>In the news</h4>\n        <ul class="e-links-list">\n          {{#bill.links}}\n            <li><a href="{{ url }}">{{ title }}</a></li>\n          {{/bill.links}}\n        </ul>\n      </div>\n    {{/()}}\n\n    {{#(bill.custom_events && bill.custom_events.length && bill.custom_events.length > 0)}}\n      <div class="custom-events">\n        <h4>Events</h4>\n        <ul class="custom-events-inner">\n          {{#bill.custom_events}}\n            <li><strong>{{ bill_id }} {{ action }}</strong> on  {{ date.format(\'MMM DD, YYYY\') }}: {{ e.description }}</li>\n          {{/bill.custom_events}}\n        </ul>\n      </div>\n    {{/()}}\n\n    {{#bill.bill_conference}}\n      <div class="conference-bill">\n        <div class="conference-bill-inner clear-block">\n          <h3>Conference Bill</h3>\n          <osbill bill="{{ this }}" type="conference" imagePath="{{ imagePath }}" translate="{{ translate }}" options="{{ options }}">\n        </div>\n      </div>\n    {{/bill.bill_conference}}\n\n    {{#bill.bill_primary}}\n      <div class="primary-bill">\n        <div class="primary-bill-inner clear-block">\n          <h3>{{ (options.chamberLabel) ? translate(\'chamber\', chamber) + \' Bill\' : \'Primary Bill\' }}</h3>\n          <osbill bill="{{ this }}" type="primary" imagePath="{{ imagePath }}" translate="{{ translate }}" options="{{ options }}">\n        </div>\n      </div>\n    {{/bill.bill_primary}}\n\n    {{#bill.bill_companion}}\n      <div class="companion-bill">\n        <div class="companion-bill-inner clear-block">\n          <h3>{{ (options.chamberLabel) ? translate(\'chamber\', chamber) + \' Bill\' : \'Companion Bill\' }}</h3>\n          <osbill bill="{{ this }}" type="companion" imagePath="{{ imagePath }}" translate="{{ translate }}" options="{{ options }}">\n        </div>\n      </div>\n    {{/bill.bill_companion}}\n\n  </div>\n</div>\n',"template-error":'<div class="error-container">\n  <div class="error"><span>There was an error.</span></div>\n</div>',"template-legislator":"\n<div class=\"legislator\">\n  <% if (LT.options.legImageProxy) { %>\n    <img src=\"<%= LT.options.legImageProxy %><%= encodeURI(photo_url) %>\" />\n  <% } else { %>\n    <img src=\"<%= photo_url %>\" />\n  <% } %>\n  \n  <div class=\"legislator-info\">\n    <%= full_name %><br />\n    <% if (typeof district != 'undefined') { %>\n      District <%= district %>\n    <% } %>\n    <% if (typeof party != 'undefined') { %>\n      (<%= LT.utils.translate('partyAbbr', party) %>) \n    <% } %> <br />\n    <% if (typeof chamber != 'undefined') { %>\n      <%= LT.utils.translate('chamber', chamber) %>\n    <% } %>\n  </div>\n</div>","template-loading":'<div class="loading-general-container">\n  <div class="loading-general"><span>Loading...</span></div>\n</div>',"template-osbill":'\n<div class="osbill">\n  <h4>\n    {{#(!!bill.title)}}\n      {{ bill.title }} ({{ bill.bill_id }})\n    {{/()}}\n\n    {{^(!!bill.title)}}\n      {{ bill.bill_id }}\n    {{/()}}\n  </h4>\n  <div class="sponsors primary-sponsors">\n    <h5>Primary sponsors</h5>\n\n    <div class="clear-block">\n      {{#bill.sponsors}}\n        {{#(type === \'primary\')}}\n          <div class="sponsor" data-leg-id="{{ leg_id }}" data-sponsor-type="{{ type }}">\n            {{ name }} ({{ type }})\n          </div>\n        {{/()}}\n      {{/bill.sponsors}}\n    </div>\n  </div>\n\n  <div class="actions">\n    <h5><span class="latest-action-label">Latest</span> Actions</h5>\n\n    <div class="actions-inner">\n      {{#bill.actions}}\n        {{#(!!date)}}\n          <div>\n            {{ date.format(\'MMM DD, YYYY\') }}:\n            {{ action }}\n            ({{ translate(\'chamber\', actor) }})\n          </div>\n        {{/())}}\n      {{/bill.actions}}\n    </div>\n  </div>\n\n  {{#(bill.sponsors && bill.sponsors.length && bill.sponsors.length)}}\n    <div class="sponsors co-sponsors clear-block">\n      <h5>Co-Sponsors</h5>\n\n      <div class="co-sponsors-inner clear-block">\n        {{#bill.sponsors}}\n          {{#(type !== \'primary\')}}\n            <div class="sponsor" data-leg-id="{{ leg_id }}" data-sponsor-type="{{ type }}">\n              {{ name }} ({{ type }})\n            </div>\n          {{/()}}\n        {{/bill.sponsors}}\n      </div>\n    </div>\n  {{/()}}\n\n  {{#(bill.votes && bill.votes.length && bill.votes.length > 0)}}\n    <div class="votes">\n      <h5>Votes</h5>\n\n      <div class="votes-inner clear-block">\n        {{#bill.votes}}\n          {{ date.format(\'MMM DD, YYYY\') }}\n          {{ motion }} {{ (passed) ? \'passed\' : \'failed\' }}\n          {{ yes_count }} Y -\n          {{ no_count }} N <br />\n        {{/bill.votes}}\n      </div>\n    </div>\n  {{/()}}\n\n  <div class="sources">\n    <h5>Sources</h5>\n\n    {{#bill.sources}}\n      <a href="{{ url }}" target="_blank">\n        {{#(!!text)}}\n          {{ text }}\n        {{/()}}\n        {{#(!text)}}\n          {{ url }}\n        {{/()}}\n      </a> <br />\n    {{/bill.sources}}\n  </div>\n</div>\n'},e.mixin({filterEmpty:function(t){return e.filter(t,function(e){return e})},filterObject:function(t,i,n){return e.reduce(t,function(e,s,l){return i.call(n,s,l,t)&&(e[l]=s),e},{},n)},mapObject:function(t,i,n){return e.reduce(t,function(e,s,l){return e[l]=i.call(n,s,l,t),e},{},n)},trim:function(t){return e.isString(t)&&(t=String.prototype.trim?t.trim():t.replace(/^\s+|\s+$/g,"")),t},cssClass:function(e){return e.replace(/[^a-z0-9]/g,"-")},numberFormatCommas:function(e){return(""+e).replace(/\B(?=(\d{3})+(?!\d))/g,",")},ellipsisText:function(e,t){var i,n,s,l,a="",o="<!-- break -->",r='<ins class="ellipsis-start">[[[TEXT]]]</ins>',c='<ins class="ellipsis-ellipsis">...</ins>',p='<ins class="ellipsis-end">[[[TEXT]]]</ins>';return-1!==e.indexOf(o)?(i=e.indexOf(o),a+=r.replace("[[[TEXT]]]",e.substring(0,i))+" ",a+=c+" ",a+=p.replace("[[[TEXT]]]",e.substring(i,e.length))+" "):(l=e.split(" "),t>=l.length?a+=r.replace("[[[TEXT]]]",e):(n=l.slice(0,t),s=l.slice(t),a+=r.replace("[[[TEXT]]]",n.join(" "))+" ",a+=c+" ",a+=p.replace("[[[TEXT]]]",s.join(" "))+" ")),a},parseURL:function(e){var t=document.createElement("a");return t.href=e,t}}),i.ajax=function(){var e=arguments;return e[0].dataTypeForce!==!0&&(e[0].dataType="jsonp"),i.$.ajax.apply(i.$,e)},t.fn.hasScrollBar=function(){return this.get(0)&&this.get(0).scrollHeight?this.get(0).scrollHeight>this.height():!1},o.parsers=o.parsers||{},o.log=function(t){e.isObject(console)&&e.isFunction(console.log)&&console.log(t)},o.parsers.eData=function(t,i){var n={},s=t.sheets("Bills").all();return s.length>i.maxBills&&o.log("The number of bills in your spreadsheet exceeds maxBills. Set the maxBills option to display them, but be aware that this may significantly slow down the Legislature Tracker."),n.categories=o.parsers.eCategories(t.sheets("Categories").all(),i),n.bills=o.parsers.eBills(s.slice(0,i.maxBills),i),n.events=o.parsers.eEvents(t.sheets("Events").all(),i),e.each(e.groupBy(n.events,"bill_id"),function(t,i){e.each(n.bills,function(e,s){e.bill===i&&(n.bills[s].custom_events=t)})}),n},o.parsers.validateBillNumber=function(e,t){return t.billNumberFormat.test(e)},o.parsers.eBills=function(t,i){return e.map(t,function(t){return o.parsers.translateFields(i.fieldTranslations.eBills,t),t.links=o.parsers.eLinks(t.links),t.categories=t.categories?t.categories.split(","):[],t.categories=e.map(t.categories,e.trim),t.bill_primary=e.trim(t.bill),t.bill&&!o.parsers.validateBillNumber(t.bill,i)&&o.log('Invalid primary bill number "'+t.bill+'" for row '+t.rowNumber+", see documentation."),t.bill_companion=e.trim(t.bill_companion),t.bill_companion&&!o.parsers.validateBillNumber(t.bill_companion,i)&&o.log('Invalid companion bill number "'+t.bill_companion+'" for row '+t.rowNumber+", see documentation."),t.bill_conference=e.trim(t.bill_conference),t.bill_conference&&!o.parsers.validateBillNumber(t.bill_conference,i)&&o.log('Invalid conference bill number "'+t.bill_conference+'" for row '+t.rowNumber+", see documentation."),t.hasBill=!0,t.bill&&t.bill_primary||(t.hasBill=!1,t.bill=e.cssClass(t.title.toLowerCase())),t})},o.parsers.eCategories=function(t,i){return e.map(t,function(e){return o.parsers.translateFields(i.fieldTranslations.eCategories,e),e.links=o.parsers.eLinks(e.links),e})},o.parsers.eEvents=function(t,i){return e.map(t,function(e){return o.parsers.translateFields(i.fieldTranslations.eEvents,e),e.links=o.parsers.eLinks(e.links),e.date=n(e.date),e.type=["custom"],e})},o.parsers.eLinks=function(t){var i=[];return t=e.trim(t),0===t.length?i:(t='"'===t.substring(0,1)?t.substring(1):t,t='"'===t.substring(t.length-1,t.length)?t.slice(0,-1):t,i=t.split('", "'),i=e.map(i,function(e){return{title:e.split("|")[0],url:e.split("|")[1]}}))},o.parsers.csvCategories=function(t){return t=e.trim(t),0===t.length?[]:(t='"'===t.substring(0,1)?t.substring(1):t,t='"'===t.substring(t.length-1,t.length)?t.slice(0,-1):t,t.split('", "'))},o.parsers.detectCompanionBill=function(t,i){var n,s;return e.isFunction(i.detectCompanionBill)?(n=i.detectCompanionBill(t),s=o.parsers.validateBillNumber(n,i)?n:void 0):e.isRegExp(i.detectCompanionBill)&&(n=i.detectCompanionBill.exec(t),s=n&&o.parsers.validateBillNumber(n[1],i)?n[1]:void 0),e.trim(s)},o.parsers.translateFields=function(t,i){return e.each(t,function(e,t){i[t]=i[e],t!==e&&delete i[e]}),i},o.BaseModel=i.Model.extend({initialize:function(e,t){this.options=t,this.app=this.options.app,this.on("sync",function(e){e.set("fetched",!0)})}}),o.OSModel=o.BaseModel.extend({urlBase:function(){return"http://openstates.org/api/v1/"},urlEnd:function(){return"/?apikey="+encodeURI(this.options.app.options.OSKey)+"&callback=?"},url:function(){return this.urlBase()+encodeURI(this.osType)+"/"+encodeURI(this.id)+this.urlEnd()},initialize:function(){o.OSModel.__super__.initialize.apply(this,arguments)}}),o.OSStateModel=o.OSModel.extend({url:function(){return this.urlBase()+"metadata/"+encodeURI(this.options.state)+this.urlEnd()}}),o.OSBillModel=o.OSModel.extend({url:function(){return e.isUndefined(this.id)?e.isUndefined(this.get("bill_id"))||""===this.get("bill_id")?void 0:this.urlBase()+"bills/"+encodeURI(this.options.app.options.state)+"/"+encodeURI(this.options.app.options.session)+"/"+encodeURI(this.get("bill_id"))+this.urlEnd():this.urlBase()+"bills/"+this.id+this.urlEnd()},initialize:function(){o.OSBillModel.__super__.initialize.apply(this,arguments)},parse:function(t){return t.created_at=n(t.created_at),t.updated_at=n(t.updated_at),t.action_dates=e.filterObject(t.action_dates,function(e){return e}),t.action_dates=e.mapObject(t.action_dates,function(e){return n(e)}),t.actions=e.mapObject(t.actions,function(e){return e.date=n(e.date),e}),t.votes=e.mapObject(t.votes,function(e){return e.date=n(e.date),e}),this.get("custom_events")&&(t.actions=e.union(t.actions,this.get("custom_events"))),t.actions=e.sortBy(t.actions,function(e,t){return-1*(e.date.unix()+t)}),t.newest_action=t.actions[0],this.options.app.options.osBillParse&&e.isFunction(this.options.app.options.osBillParse)&&(t=this.options.osBillParse(t,this)),t},getActionDate:function(e){return this.get("action_dates")[e]?this.get("action_dates")[e]:!1},isSubstituted:function(){var t=!1,i=this;return e.isBoolean(this.get("substitued"))?t=this.get("substitued"):this.options.substituteMatch===!1?t=!1:(t=e.find(this.get("actions"),function(e){return e.action.match(i.options.substituteMatch)}),t=t?!0:!1,this.set("substitued",t)),t}}),o.OSLegislatorModel=o.OSModel.extend({osType:"legislators"}),o.OSCommitteeModel=o.OSModel.extend({osType:"committees"}),o.BillModel=o.BaseModel.extend({subbills:["bill_primary","bill_companion","bill_conference"],initialize:function(){o.BillModel.__super__.initialize.apply(this,arguments),this.loadOSBills()},loadOSBills:function(){var t=this;e.each(this.subbills,function(e){t.get(e)&&t.set(e,t.app.getModel("OSBillModel","bill_id",{bill_id:t.get(e)}))})},getOSBills:function(){var t=this;return e.filterEmpty(e.map(this.subbills,function(e){return t.get(e)}))},getOSBillIDs:function(){var t=this.getOSBills();return e.filterEmpty(e.map(t,function(t){return e.isObject(t)?t.get("bill_id"):t}))},fetchOSBills:function(){var i=this,n=[];return this.getCategories(),e.each(this.subbills,function(e){i.get("hasBill")&&i.get(e)&&n.push(i.options.app.fetchModel(i.get(e)))}),t.when.apply(t,n).done(function(){i.loadOSCompanion().done(function(){i.parseMeta(),i.lastUpdatedAt(),i.newestAction(),i.trigger("fetched:osbills")})})},loadOSCompanion:function(){var i,n=this,s=[];return this.get("hasBill")===!0&&!this.get("bill_companion")&&e.isObject(this.get("bill_primary"))&&e.isArray(this.get("bill_primary").get("companions"))&&e.isObject(this.get("bill_primary").get("companions")[0])&&(i=o.parse.detectCompanionBill(this.get("bill_primary").get("companions")[0].bill_id),i&&(this.set("bill_companion",n.options.app.getModel("OSBillModel","bill_id",{bill_id:i})),s.push(n.options.app.fetchModel(this.get("bill_companion"))))),t.when.apply(t,s)},getCategories:function(){var t=this;this.get("categories")&&this.set("categories",e.map(this.get("categories"),function(i){return e.isObject(i)||(i=t.options.app.getModel("CategoryModel","id",{id:i})),i}))},lastUpdatedAt:function(){var t,i=this.get("bill_primary"),n=this.get("bill_companion"),s=this.get("bill_conference");return e.isUndefined(this.get("last_updated_at"))&&i.get("updated_at")?(t=i.get("updated_at"),n&&n.get("updated_at")&&(t=n.get("updated_at").unix()>t.unix()?n.get("updated_at"):t),s&&s.get("updated_at")&&(t=s.get("updated_at").unix()>t.unix()?s.get("updated_at"):t),this.set("last_updated_at",t)):e.isUndefined(this.get("last_updated_at"))&&!i.get("updated_at")&&o.log("Could not fetch primary bill data from OpenStates. Check that the id "+this.get("bill_primary").get("bill_id")+" is formatted properly."),this.get("last_updated_at")},newestAction:function(){var t,i=this.get("bill_primary"),n=this.get("bill_companion"),s=this.get("bill_conference");return this.get("hasBill")&&e.isUndefined(this.get("newest_action"))&&i.get("newest_action")&&(t=i.get("newest_action"),n&&n.get("newest_action")&&(t=n.get("newest_action").date.unix()>t.date.unix()?n.get("newest_action"):t),s&&s.get("newest_action")&&(t=s.get("newest_action").date.unix()>t.date.unix()?s.get("newest_action"):t),this.set("newest_action",t)),this.get("newest_action")},parseMeta:function(){var t={upper:!1,lower:!1,conference:!1,signed:!1,last:!1},i={companion:this.get("bill_companion")?!0:!1,conference:this.get("bill_conference")?!0:!1};if(this.get("custom_events")&&this.set("custom_events",e.sortBy(this.get("custom_events"),function(e,t){return-1*(e.date.unix()+t)})),this.get("hasBill")){if(i.companion&&(this.get("bill_companion").isSubstituted()&&(i.substituted=!0),this.get("bill_primary").isSubstituted()&&(i.substituted=!0)),(!i.companion||i.substituted)&&(t.lower=this.get("bill_primary").getActionDate("passed_lower"),t.upper=this.get("bill_primary").getActionDate("passed_upper")),i.companion&&!i.substituted&&("upper"===this.get("bill_primary").get("chamber")?(t.upper=this.get("bill_primary").getActionDate("passed_upper"),t.lower=this.get("bill_companion").getActionDate("passed_lower")):(t.lower=this.get("bill_primary").getActionDate("passed_lower"),t.upper=this.get("bill_companion").getActionDate("passed_upper"))),i.conference){var n=this.get("bill_conference").getActionDate("passed_lower"),s=this.get("bill_conference").getActionDate("passed_upper");n&&s&&(t.conference=n.unix()>=s.unix()?n:s)}t.signed=i.conference?this.get("bill_conference").getActionDate("signed"):this.get("bill_primary").getActionDate("signed"),t.last=i.conference?this.get("bill_conference").getActionDate("last"):i.companion?this.get("bill_companion").getActionDate("last").unix()>=this.get("bill_primary").getActionDate("last").unix()?this.get("bill_companion").getActionDate("last"):this.get("bill_primary").getActionDate("last"):this.get("bill_primary").getActionDate("last"),this.get("description")||this.set("description",this.get("bill_primary").get("summary"))}return this.set("actions",t),this.set("bill_type",i),this}}),o.CategoryModel=o.BaseModel.extend({initialize:function(){o.CategoryModel.__super__.initialize.apply(this,arguments),this.set("bills",new o.BillsCollection(null))},getBills:function(t){var i=this,n=this.get("id");return t.each(function(t){-1!==e.indexOf(t.get("categories"),n)&&i.get("bills").push(i.app.getModel("BillModel","bill",t.attributes))}),this}}),o.CategoriesCollection=i.Collection.extend({model:o.CategoryModel,comparator:function(e){return-1!==e.get("title").toLowerCase().indexOf("recent")?"zzzzz":e.get("title")}}),o.BillsCollection=i.Collection.extend({model:o.BillModel,comparator:function(e){var t=e.newestAction()?-1*e.newestAction().date.unix():e.get("title");return t}}),o.OSBillsCollection=i.Collection.extend({model:o.OSBillModel,comparator:function(e){var t=e.get("newest_action");return t&&(t=-1*t.date.unix()),t}}),o.BaseView=l.extend({baseInit:function(e){this.options=e.options,this.app=e.app,this.router=e.router},adaptors:["Backbone"]}),o.ApplicationView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.CategoriesView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.CategoryView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.EBillView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.OSBillView=o.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),o.MainRouter=i.Router.extend({routes:{categories:"routeCategories","category/recent":"routeRecentCategory","category/:category":"routeCategory","bill/:bill":"routeEBill","*defaultR":"routeDefault"},initialize:function(e){e.router=this,this.options=e,this.app=e.app,this.app.views.application=new o.ApplicationView({el:this.app.$el,template:this.app.templates.application,data:{options:this.options,categories:this.app.categories},options:this.options,partials:{loading:this.app.templates.loading},adaptors:["Backbone"]}),this.$content=this.app.$el.find(".ls-content-container")},start:function(){i.history.start()},routeDefault:function(){this.navigate("/categories",{trigger:!0,replace:!0})},routeCategories:function(){this.app.fetchBasicBillData(),this.app.views.categories=new o.CategoriesView({el:this.$content,template:this.app.templates.categories,data:{options:this.options,categories:this.app.categories,imagePath:e.bind(this.app.imagePath,this.app)},options:this.options,partials:{loading:this.app.templates.loading},adaptors:["Backbone"]})},routeCategory:function(t){var i=this,n=decodeURI(t);t=this.app.categories.get(n),t||this.navigate("/",{trigger:!0,replace:!0}),this.app.fetchOSBillsFromCategory(t),this.app.views.category=new o.CategoryView({el:this.$content,template:this.app.templates.category,data:{options:this.options,category:t,categoryID:n,imagePath:e.bind(this.app.imagePath,this.app),translate:e.bind(this.app.translate,this.app)},options:this.options,partials:{loading:this.app.templates.loading},components:{ebill:o.EBillView.extend({template:this.app.templates.ebill,components:{osbill:o.OSBillView.extend({template:this.app.templates.osbill})}})}}),this.app.on("fetched:osbills:category:"+t.id,function(){i.app.views.category.update()})},routeRecentCategory:function(){this.app.fetchBasicBillData(),this.routeCategory("recent")},routeEBill:function(t){var i=this,n=decodeURI(t);t=this.app.bills.where({bill:n})[0],t||this.navigate("/",{trigger:!0,replace:!0}),t.fetchOSBills(),this.app.views.bill=new o.EBillView({el:this.$content,template:this.app.templates.ebill,data:{options:this.options,bill:t,billID:n,imagePath:e.bind(this.app.imagePath,this.app),translate:e.bind(this.app.translate,this.app)},options:this.options,partials:{loading:this.app.templates.loading},components:{osbill:o.OSBillView.extend({template:this.app.templates.osbill})}}),t.on("fetched:osbills",function(){i.app.views.bill.update()})},error:function(){}}),a=function(i){this.options=e.extend({},this.defaultOptions,i),this.options.app=this,this.options.$el=this.$el=t(this.options.el),this.on("fetched:base-data",this.loadBaseData),this.on("loaded:basic-bill-data",this.loadRecentCategory),this.categories=new o.CategoriesCollection(null),this.bills=new o.BillsCollection(null),this.getTemplates(),this.fetchBaseData(),this.router=new o.MainRouter(this.options),this.on("loaded:base-data",this.startRouting)},e.extend(a.prototype,i.Events),e.extend(a.prototype,{views:{},cache:{},fetched:{},startRouting:function(){this.router.start()},fetchBaseData:function(){var t=this;this.fetched.baseData!==!0&&(this.tabletop=s.init(e.extend(this.options.tabletopOptions,{key:this.options.eKey,callback:function(e,i){t.fetched.baseData=!0,t.trigger("fetched:base-data",e,i)},callbackContext:t,wanted:this.options.sheetsWanted})))},loadBaseData:function(t,i){var n,s,l=this;s=o.parsers.eData(i,this.options),e.each(s.categories,function(e){this.categories.add(this.getModel("CategoryModel","id",e))},this),e.each(s.bills,function(e){this.bills.add(this.getModel("BillModel","bill",e))},this),n={id:"recent",title:"Recent Actions",description:"The following bills have been updated in the past "+this.options.recentChangeThreshold+" days.",image:this.options.recentImage},this.categories.add(this.getModel("CategoryModel","id",n)),this.categories.each(function(e){e.getBills(l.bills)}),this.trigger("loaded:base-data")},fetchBasicBillData:function(){var i,s=this,l=[];return this.fetched.basicBillData!==!0?(this.bills.each(function(t){e.each(t.getOSBillIDs(),function(e){l.push(e)})}),i="http://openstates.org/api/v1/bills/?state="+this.options.state+"&search_window=session:"+this.options.session+"&bill_id__in="+encodeURI(l.join("|"))+"&apikey="+this.options.OSKey+"&callback=?",t.getJSON(i).done(function(t){s.fetched.basicBillData=!0,s.trigger("fetched:basic-bill-data"),e.each(t,function(e){e.created_at=n(e.created_at),e.updated_at=n(e.updated_at),s.getModel("OSBillModel","bill_id",e).set(e)}),s.trigger("loaded:basic-bill-data")})):void 0},loadRecentCategory:function(){var e=this,t=this.getModel("CategoryModel","id",{id:"recent"});this.bills.each(function(i){var s=i.get("categories");Math.abs(parseInt(i.lastUpdatedAt().diff(n(),"days"),10))<e.options.recentChangeThreshold&&(s.push(t.get("id")),i.set("categories",s))}),t.getBills(this.bills)},fetchOSBillsFromBill:function(){category.get("id");var t=[];e.each(category.get("bills"),function(e){t.push(e.fetch())})},fetchOSBillsFromCategory:function(e){var i=this,n=[];return e.getBills(this.bills),e.get("bills").each(function(e){n.push(e.fetchOSBills())}),t.when.apply(t,n).done(function(){i.trigger("fetched:osbills"),i.trigger("fetched:osbills:category:"+e.id)})},getModel:function(t,i,n,s){var l="models:"+t+":"+i+":"+n[i];return s=e.extend(s||{},{app:this}),e.isUndefined(this.cache[l])&&(this.cache[l]=new o[t](n,s)),this.cache[l]},fetchModel:function(e){var i;return e.get("fetched")!==!0?e.fetch({success:function(e){e.set("fetched",!0)}}):(i=t.Deferred(),i.resolveWith(e),i)},translate:function(t,i){var n=i;return e.isObject(this.options.wordTranslations[t])&&e.isString(this.options.wordTranslations[t][i])&&(n=this.options.wordTranslations[t][i]),n},imagePath:function(e){return 0===e.indexOf("http")?e:this.options.imagePath+e},getTemplate:function(e){return o.templates[e]},templates:{},getTemplates:function(){this.templates.application=this.getTemplate("template-application"),this.templates.loading=this.getTemplate("template-loading"),this.templates.error=this.getTemplate("template-error"),this.templates.ebill=this.getTemplate("template-ebill"),this.templates.osbill=this.getTemplate("template-osbill"),this.templates.category=this.getTemplate("template-category"),this.templates.categories=this.getTemplate("template-categories"),this.templates.header=this.getTemplate("template-header")},defaultOptions:{sheetsWanted:["Categories","Bills","Events"],fieldTranslations:{eCategories:{id:"categoryid",short_title:"shorttitle"},eBills:{bill:"bill",bill_companion:"companionbill",bill_conference:"conferencebill",categories:"categories",title:"title",description:"description"},eEvents:{bill_id:"bill",actor:"chamber",action:"title"}},wordTranslations:{chamber:{upper:"Senate",lower:"House"},partyAbbr:{"Democratic-Farmer-Labor":"DFL",Democratic:"D",Republican:"R"}},maxBills:30,substituteMatch:/substituted/i,imagePath:"./styles/images/",templatePath:"./js/app/templates/",recentChangeThreshold:7,tabletopOptions:{},scrollOffset:!1,conferenceBill:!0,recentImage:"RecentUpdatedBill.png",chamberLabel:!1,detectCompanionBill:/([A-Z]+ [1-9][0-9]*)$/,billNumberFormat:/[A-Z]+ [1-9][0-9]*/,osBillParse:!1}}),o.templates=this.LTTemplates,a});