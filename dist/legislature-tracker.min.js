/*! legislature-tracker - v0.2.0-alpha - 2014-03-27
* https://github.com/MinnPost/legislature-tracker
* Copyright (c) 2014 ; Licensed MIT */

(function(t,e){if("undefined"!=typeof module&&module.exports&&"function"==typeof require)e(require("underscore"),require("jquery"),require("backbone"),require("moment"),require("tabletop"),require("ractive"));else if("function"==typeof define&&define.amd)define("LT",["underscore","jquery","backbone","moment","tabletop","Ractive"],e);else{if(!(t._&&t.jQuery&&t.Backbone&&t.moment&&t.Tabletop))throw Error("Could not find dependencies for Legislature Tracker.");t.LT=e(t._,t.jQuery,t.Backbone,t.moment,t.Tabletop,t.Ractive)}})("undefined"!=typeof window?window:this,function(t,e,i,n,s,l){function a(t,i){this.element=t,this.$element=e(t),this._defaults=r.nav.stickDefaults,this.options=e.extend({},this._defaults,i),this._name="ltStick",this._scrollEvent="scroll.lt.ltStick",this._on=!1,this.init()}var o,r={};return this.LTTemplates={"template-application":'<div class="ls">\n\n  {{#(!!categories)}}\n    <div class="ls-header-container {{#menuOff}}menu-off{{/menuOff}}">\n      <div class="ls-header">\n\n        <a class="all-categories-link" href="#/">\n          <img src="{{ imagePath(\'back-100-85.png\') }}" />\n          All Categories\n        </a>\n\n        <span class="categories-nav">\n          &nbsp;&nbsp;|&nbsp;&nbsp;\n\n          {{#categories}}\n            <a class="" href="#/category/{{ id }}" title="{{ title }}">\n              {{ (short_title) ? short_title : title.split(\' \')[0] }}\n            </a>\n            &nbsp;&nbsp;\n          {{/categories}}\n        </span>\n      </div>\n    </div>\n  {{/()}}\n\n  {{#options.title}}\n    <h2>{{ options.title }}</h2>\n  {{/options.title}}\n\n  <div class="ls-content-container">\n    {{>loading}}\n  </div>\n</div>\n',"template-categories":'\n{{^categories}}\n  {{>loading}}\n{{/categories}}\n\n<div class="categories-container">\n  <ul class="category-list clear-block">\n    {{#categories:i}}\n      <li class="category-item category-item-{{ i }}">\n        <div class="category-inner category-{{ _.cssClass(id) }}">\n          {{#image}}\n            <a href="#/category/{{ encodeURI(id) }}">\n              <img class="category-image" src="{{ imagePath(image) }}" />\n            </a>\n          {{/image}}\n\n          <h3>\n            <a href="#/category/{{ encodeURI(id) }}">\n              {{ title }}\n            </a>\n          </h3>\n\n          <div>\n            Watching <strong>{{ bills.length }}</strong> bills.\n          </div>\n        </div>\n      </li>\n    {{/categories}}\n  </ul>\n</div>',"template-category":'\n{{^category}}\n  {{>loading}}\n{{/category}}\n\n<div class="category-container">\n  <h2>\n    {{#category.image}}\n      <img class="category-image" src="{{ imagePath(category.image) }}" />\n    {{/category.image}}\n\n    {{ category.title }}\n  </h2>\n\n  <p class="category-description">{{ category.description }}</p>\n\n  {{#(category.links && category.links.length && category.links.length > 0)}}\n    <div class="elinks">\n      <strong>In the news</strong>\n      <ul class="elinks-list">\n        {{#category.links}}\n          <li><a href="{{ url }}">{{ title }}</a></li>\n        {{/category.links}}\n      </ul>\n    </div>\n  {{/()}}\n\n  <div class="clear-block bills-list">\n    {{#category.bills:bill}}\n      <ebill bill="{{ this }}" compact="true" imagePath="{{ imagePath }}" options="{{ options }}">\n    {{/category.bills}}\n  </div>\n\n  <div class="clear-block total-bill">\n    Watching\n    <strong>{{ category.bills.length }}</strong>\n    {{#(typeof category.total_bill_count != \'undefined\')}}\n      of {{ category.total_bill_count }}\n    {{/()}}\n    bills in the {{ category.title }} category.\n  </div>\n</div>\n',"template-ebill":'\n<div class="bill ebill {{^bill.hasBill}}no-bill{{/bill.hasBill}}">\n  <div class="bill-status">\n    <img\n      class="lower {{#bill.bill_type.recent}}passed{{/bill.bill_type.recent}}"\n      src="{{ imagePath(\'RecentChanges.png\') }}"\n      title="{{#bill.bill_type.recent}}Recently changed{{/bill.bill_type.recent}}\n        {{^bill.bill_type.recent}}Not changed recently{{/bill.bill_type.recent}}"\n     />\n\n    <img\n      class="lower {{#bill.actions.lower}}passed{{/bill.actions.lower}}"\n      src="{{ imagePath(\'PassedHouse.png\') }}"\n      title="{{#bill.actions.lower}}Passed{{/bill.actions.lower}}\n        {{^bill.actions.lower}}Not passed (yet){{/bill.actions.lower}} {{ translate(\'chamber\', \'lower\') }}"\n     />\n\n    <img\n      class="lower {{#bill.actions.upper}}passed{{/bill.actions.upper}}"\n      src="{{ imagePath(\'PassedSenate.png\') }}"\n      title="{{#bill.actions.upper}}Passed{{/bill.actions.upper}}\n        {{^bill.actions.upper}}Not passed (yet){{/bill.actions.upper}} {{ translate(\'chamber\', \'upper\') }}"\n     />\n\n    {{#options.conferenceBill}}\n      <img\n        class="conference {{#bill.bill_type.conference}}passed{{/bill.bill_type.conference}}"\n        src="{{ imagePath(\'InConferenceCommittee.png\') }}"\n        title="{{#bill.bill_type.conference}}Conference bill created{{/bill.bill_type.conference}}\n          {{#bill.bill_type.conference}}Conference bill not created (yet){{/bill.bill_type.conference}}"\n       />\n    {{/options.conferenceBill}}\n\n   <img\n     class="signed {{#bill.actions.signed}}passed{{/bill.actions.signed}}"\n     src="{{ imagePath(\'SignedIntoLaw.png\') }}"\n     title="{{#bill.actions.signed}}Signed into law by the Governor{{/bill.actions.signed}}\n       {{#bill.actions.signed}}Not signed into law (yet){{/bill.actions.signed}}"\n    />\n  </div>\n\n  {{#compact}}\n    <h3>\n      {{ bill.title }}\n      <a class="permalink" title="Permanent link to bill" href="#/bill/{{ encodeURI(bill.bill) }}"></a>\n    </h3>\n  {{/compact}}\n  {{^compact}}\n    <h2>{{ bill.title }}</h2>\n  {{/compact}}\n\n  {{^bill.hasBill}}\n    <div class="latest-action">\n      <em>This bill has not been tracked by the legislature yet.</em>\n    </div>\n  {{/bill.hasBill}}\n\n  {{#bill.newest_action}}\n    <div class="latest-action">Last action about {{ date.fromNow() }}: {{ action }}.</div>\n  {{/bill.newest_action}}\n\n  <div class="description">\n    {{{ bill.description }}}\n  </div>\n\n  <div class="ebill-categories">\n    <strong>Categories:</strong>\n    {{#bill.categories:i}}\n      <a href="#/category/{{ id }}">\n        {{#image}}\n          <img class="category-image" src="{{ imagePath(image) }}" />\n        {{/image}}\n        {{ title }}\n      </a>{{#(i < bill.categories.length - 1)}},{{/()}}\n    {{/bill.categories}}\n  </div>\n\n  {{#(bill.links && bill.links.length && bill.links.length > 0)}}\n    <div class="elinks">\n      <strong>In the news</strong>\n      <ul class="elinks-list">\n        {{#bill.links}}\n          <li><a href="{{ url }}">{{ title }}</a></li>\n        {{/bill.links}}\n      </ul>\n    </div>\n  {{/()}}\n\n\n  {{#(compact == true)}}\n    <div class="osbills ebill-sponsors clear-block\n      {{#bill.bill_conference}}has-conference{{/bill.bill_conference}}\n      {{#bill.bill_primary}}has-primary{{/bill.bill_primary}}\n      {{#bill.bill_companion}}has-companion{{/bill.bill_companion}}\n      ">\n      {{#bill.bill_conference}}\n        <div class="osbill bill-conference">\n          <strong>Conference bill\n            {{#sources.0.url}}\n              <a href="{{ sources.0.url }}" target="_blank">{{ bill_id }}</a>\n            {{/sources.0.url}}\n            {{^sources.0.url}} {{ bill_id }} {{/sources.0.url}}\n          </strong>\n          {{#sponsors}}\n            <sponsor sponsor="{{ this }}" type="primary">\n          {{/sponsors}}\n        </div>\n      {{/bill.bill_conference}}\n\n      {{#bill.bill_primary}}\n        <div class="osbill bill-primary">\n          <strong>\n            {{ (options.chamberLabel) ? translate(\'chamber\', chamber) + \' Bill\' : \'Primary Bill\' }}\n            {{#sources.0.url}}\n              <a href="{{ sources.0.url }}" target="_blank">{{ bill_id }}</a>\n            {{/sources.0.url}}\n            {{^sources.0.url}} {{ bill_id }} {{/sources.0.url}}\n          </strong>\n          {{#sponsors}}\n            <sponsor sponsor="{{ this }}" type="primary">\n          {{/sponsors}}\n        </div>\n      {{/bill.bill_primary}}\n\n      {{#bill.bill_companion}}\n        <div class="osbill bill-companion">\n          <strong>\n            {{ (options.chamberLabel) ? translate(\'chamber\', chamber) + \' Bill\' : \'Companion Bill\' }}\n            {{#sources.0.url}}\n              <a href="{{ sources.0.url }}" target="_blank">{{ bill_id }}</a>\n            {{/sources.0.url}}\n            {{^sources.0.url}} {{ bill_id }} {{/sources.0.url}}\n          </strong>\n          {{#sponsors}}\n            <sponsor sponsor="{{ this }}" type="primary">\n          {{/sponsors}}\n        </div>\n      {{/bill.bill_companion}}\n    </div>\n\n    <div class="details-link">\n      <a title="See more details about bill" href="#/bill/{{ encodeURI(bill.bill) }}">More details\n        <img src="{{ imagePath(\'forward-100-85.png\') }}" /></a>\n    </div>\n  {{/()}}\n\n\n  {{#(compact != true)}}\n    {{#(bill.custom_events && bill.custom_events.length && bill.custom_events.length > 0)}}\n      <div class="custom-events">\n        <strong>Events</strong>\n        <ul class="custom-events-inner">\n          {{#bill.custom_events}}\n            <li><strong>{{ bill_id }} {{ action }}</strong> on  {{ date.format(\'MMM DD, YYYY\') }}: {{ e.description }}</li>\n          {{/bill.custom_events}}\n        </ul>\n      </div>\n    {{/()}}\n\n    <div class="osbills clear-block\n      {{#bill.bill_conference}}has-conference{{/bill.bill_conference}}\n      {{#bill.bill_primary}}has-primary{{/bill.bill_primary}}\n      {{#bill.bill_companion}}has-companion{{/bill.bill_companion}}\n    ">\n\n      {{#bill.bill_conference}}\n        <div class="osbill conference-bill">\n          <h3>Conference Bill</h3>\n          <osbill bill="{{ this }}" type="conference" imagePath="{{ imagePath }}" translate="{{ translate }}" options="{{ options }}">\n        </div>\n      {{/bill.bill_conference}}\n\n      {{#bill.bill_primary}}\n        <div class="osbill primary-bill">\n          <h3>{{ (options.chamberLabel) ? translate(\'chamber\', chamber) + \' Bill\' : \'Primary Bill\' }}</h3>\n          <osbill bill="{{ this }}" type="primary" imagePath="{{ imagePath }}" translate="{{ translate }}" options="{{ options }}">\n        </div>\n      {{/bill.bill_primary}}\n\n      {{#bill.bill_companion}}\n        <div class="osbill companion-bill">\n          <h3>{{ (options.chamberLabel) ? translate(\'chamber\', chamber) + \' Bill\' : \'Companion Bill\' }}</h3>\n          <osbill bill="{{ this }}" type="companion" imagePath="{{ imagePath }}" translate="{{ translate }}" options="{{ options }}">\n        </div>\n      {{/bill.bill_companion}}\n  {{/()}}\n\n</div>\n',"template-error":'<div class="error-container">\n  <div class="error"><span>There was an error.</span></div>\n</div>',"template-legislator":"\n<div class=\"legislator\">\n  <% if (LT.options.legImageProxy) { %>\n    <img src=\"<%= LT.options.legImageProxy %><%= encodeURI(photo_url) %>\" />\n  <% } else { %>\n    <img src=\"<%= photo_url %>\" />\n  <% } %>\n  \n  <div class=\"legislator-info\">\n    <%= full_name %><br />\n    <% if (typeof district != 'undefined') { %>\n      District <%= district %>\n    <% } %>\n    <% if (typeof party != 'undefined') { %>\n      (<%= LT.utils.translate('partyAbbr', party) %>) \n    <% } %> <br />\n    <% if (typeof chamber != 'undefined') { %>\n      <%= LT.utils.translate('chamber', chamber) %>\n    <% } %>\n  </div>\n</div>","template-loading":'<div class="loading-general-container">\n  <div class="loading-general"><span>Loading...</span></div>\n</div>',"template-osbill":'\n<div class="osbill-container {{ type }}-bill">\n  <h4>\n    {{#(!!bill.title)}}\n      {{ bill.title }} ({{ bill.bill_id }})\n    {{/()}}\n\n    {{^(!!bill.title)}}\n      {{ bill.bill_id }}\n    {{/()}}\n  </h4>\n\n  <div class="primary-sponsors">\n    <strong>Primary sponsors</strong>\n    <div class="clear-block">\n      {{#bill.sponsors}}\n        <sponsor sponsor="{{ this }}" type="primary">\n      {{/bill.sponsors}}\n    </div>\n  </div>\n\n  <div class="actions">\n    <strong>Actions</strong>\n    <div class="actions-inner">\n      {{#bill.actions}}\n        {{#(!!date)}}\n          <div>\n            {{ date.format(\'MMM DD, YYYY\') }}:\n            {{ action }}\n            ({{ translate(\'chamber\', actor) }})\n          </div>\n        {{/())}}\n      {{/bill.actions}}\n    </div>\n  </div>\n\n  <div class="co-sponsors">\n    <strong>Co-Sponsors</strong>\n    <div>\n      {{#bill.sponsors}}\n        <sponsor sponsor="{{ this }}" type="cosponsor" compact="true">\n      {{/bill.sponsors}}\n    </div>\n  </div>\n\n  {{#(bill.votes && bill.votes.length && bill.votes.length > 0)}}\n    <div class="votes">\n      <strong>Votes</strong>\n      <div>\n        {{#bill.votes}}\n          {{ date.format(\'MMM DD, YYYY\') }}\n          {{ motion }} {{ (passed) ? \'passed\' : \'failed\' }}\n          {{ yes_count }} Y -\n          {{ no_count }} N <br />\n        {{/bill.votes}}\n      </div>\n    </div>\n  {{/()}}\n\n  <div class="sources">\n    <strong>Sources</strong>\n    <div>\n      {{#bill.sources}}\n        <a href="{{ url }}" target="_blank">\n          {{#(!!text)}}\n            {{ text }}\n          {{/()}}\n          {{#(!text)}}\n            {{ url }}\n          {{/()}}\n        </a> <br />\n      {{/bill.sources}}\n    </div>\n  </div>\n</div>\n',"template-sponsor":'\n{{#(((!!type && sponsor.type === type) || !type) && !compact)}}\n\n  <div class="sponsor clear-block">\n    {{#sponsor.leg.photo_url}}\n      <div class="sponsor-image">\n        {{#options.legImageProxy}}\n          <img src="{{ options.legImageProxy }}{{ encodeURI(sponsor.leg.photo_url) }}" />\n        {{/options.legImageProxy}}\n        {{^options.legImageProxy}}\n          <img src="{{ sponsor.leg.photo_url }}" />\n        {{/options.legImageProxy}}\n      </div>\n    {{/sponsor.leg.photo_url}}\n\n    <div class="sponsor-info">\n      {{#sponsor.leg.full_name}}\n        {{ sponsor.leg.full_name }} <br />\n        District {{ sponsor.leg.district }}\n        ({{ translate(\'chamber\', sponsor.leg.chamber) }}) <br />\n        {{ translate(\'partyAbbr\', sponsor.leg.party) }}\n      {{/sponsor.leg.full_name}}\n\n      {{^sponsor.leg.full_name}}\n        {{ sponsor.name }}\n      {{/sponsor.leg.full_name}}\n    </div>\n  </div>\n{{/()}}\n\n\n{{#(((!!type && sponsor.type === type) || !type) && !!compact)}}\n  <div class="sponsor">\n    {{#sponsor.leg.full_name}}\n      {{ sponsor.leg.full_name }},\n      {{ translate(\'partyAbbr\', sponsor.leg.party) }}\n    {{/sponsor.leg.full_name}}\n\n    {{^sponsor.leg.full_name}}\n      {{ sponsor.name }}\n    {{/sponsor.leg.full_name}}\n  </div>\n{{/()}}\n'},t.mixin({filterEmpty:function(e){return t.filter(e,function(t){return t})},filterObject:function(e,i,n){return t.reduce(e,function(t,s,l){return i.call(n,s,l,e)&&(t[l]=s),t},{},n)},mapObject:function(e,i,n){return t.reduce(e,function(t,s,l){return t[l]=i.call(n,s,l,e),t},{},n)},trim:function(e){return t.isString(e)&&(e=String.prototype.trim?e.trim():e.replace(/^\s+|\s+$/g,"")),e},cssClass:function(t){return t.replace(/[^a-z0-9]/g,"-")},numberFormatCommas:function(t){return(""+t).replace(/\B(?=(\d{3})+(?!\d))/g,",")},ellipsisText:function(t,e){var i,n,s,l,a="",o="<!-- break -->",r='<ins class="ellipsis-start">[[[TEXT]]]</ins>',c='<ins class="ellipsis-ellipsis">...</ins>',p='<ins class="ellipsis-end">[[[TEXT]]]</ins>';return-1!==t.indexOf(o)?(i=t.indexOf(o),a+=r.replace("[[[TEXT]]]",t.substring(0,i))+" ",a+=c+" ",a+=p.replace("[[[TEXT]]]",t.substring(i,t.length))+" "):(l=t.split(" "),e>=l.length?a+=r.replace("[[[TEXT]]]",t):(n=l.slice(0,e),s=l.slice(e),a+=r.replace("[[[TEXT]]]",n.join(" "))+" ",a+=c+" ",a+=p.replace("[[[TEXT]]]",s.join(" "))+" ")),a},parseURL:function(t){var e=document.createElement("a");return e.href=t,e}}),i.ajax=function(){var t=arguments;return t[0].dataTypeForce!==!0&&(t[0].dataType="jsonp"),i.$.ajax.apply(i.$,t)},e.fn.hasScrollBar=function(){return this.get(0)&&this.get(0).scrollHeight?this.get(0).scrollHeight>this.height():!1},r.nav=r.nav||{},r.nav.stickDefaults={activeClass:"stuck top",wrapperClass:"menu-stick-container",topPadding:0,throttle:90},a.prototype={init:function(){this.$container=void 0===this.options.container?this.$element.parent():e(this.options.container),this.elementHeight=this.$element.outerHeight(!0),this.$spacer=e("<div>").height(this.elementHeight).hide(),this.$element.after(this.$spacer),this.options.wrapperClass&&this.$element.wrapInner('<div class="'+this.options.wrapperClass+'"></div>'),this._throttledListen=t.bind(t.throttle(this.listen,this.options.throttle),this),this._throttledListen(),e(window).on(this._scrollEvent,this._throttledListen)},listen:function(){var t=this.$container.offset().top,i=t+this.$container.height(),n=e(window).scrollTop(),s=t-this.options.topPadding,l=i-this.elementHeight-this.options.topPadding-2;!this._on&&n>s&&l>n?this.on():this._on&&(s>n||n>l)&&this.off()},on:function(){this.$element.addClass(this.options.activeClass),this.options.topPadding&&this.$element.css("top",this.options.topPadding),this.$spacer.show(),this._on=!0},off:function(){this.$element.removeClass(this.options.activeClass),this.options.topPadding&&this.$element.css("top","inherit"),this.$spacer.hide(),this._on=!1},remove:function(){this.$container.off(this._scrollEvent)}},e.fn.ltStick=function(t){return this.each(function(){e.data(this,"ltStick")||e.data(this,"ltStick",new a(this,t))})},function(){var t,e;if(!l||!i)throw Error("Could not find Ractive or Backbone! Check your paths config");l.adaptors.Backbone={filter:function(t){return t instanceof i.Model||t instanceof i.Collection,t instanceof i.Model||t instanceof i.Collection},wrap:function(n,s,l,a){return s instanceof i.Model?new t(n,s,l,a):new e(n,s,l,a)}},t=function(t,e,i,n){var s=this;this.value=e,e.on("change",this.modelChangeHandler=function(){s.setting=!0,t.set(n(e.changed)),s.setting=!1}),e.on("sync",this.modelSyncHandler=function(){t.update(i)})},t.prototype={teardown:function(){this.value.off("change",this.changeHandler),this.value.off("sync",this.modelSyncHandler)},get:function(){return this.value.attributes},set:function(t,e){this.setting||-1!==t.indexOf(".")||this.value.set(t,e)},reset:function(t){return t instanceof i.Model||"object"!=typeof t?!1:(this.value.reset(t),void 0)}},e=function(t,e,i){var n=this;this.value=e,e.on("add remove reset",this.changeHandler=function(){n.setting=!0,t.set(i,e.models),n.setting=!1}),e.on("sort",this.sortHandler=function(){n.setting=!0,t.update(i),n.setting=!1})},e.prototype={teardown:function(){this.value.off("add remove reset",this.changeHandler),this.value.off("sort",this.sortHandler)},get:function(){return this.value.models},reset:function(t){return this.setting?void 0:t instanceof i.Collection||"[object Array]"!==Object.prototype.toString.call(t)?!1:(this.value.reset(t),void 0)}}}(),r.parsers=r.parsers||{},r.log=function(e){t.isObject(console)&&t.isFunction(console.log)&&console.log(e)},r.parsers.eData=function(e,i){var n={},s=e.sheets("Bills").all();return s.length>i.maxBills&&r.log("The number of bills in your spreadsheet exceeds maxBills. Set the maxBills option to display them, but be aware that this may significantly slow down the Legislature Tracker."),n.categories=r.parsers.eCategories(e.sheets("Categories").all(),i),n.bills=r.parsers.eBills(s.slice(0,i.maxBills),i),n.events=r.parsers.eEvents(e.sheets("Events").all(),i),t.each(t.groupBy(n.events,"bill_id"),function(e,i){t.each(n.bills,function(t,s){t.bill===i&&(n.bills[s].custom_events=e)})}),n},r.parsers.validateBillNumber=function(t,e){return e.billNumberFormat.test(t)},r.parsers.eBills=function(e,i){return t.map(e,function(e){return r.parsers.translateFields(i.fieldTranslations.eBills,e),e.links=r.parsers.eLinks(e.links),e.categories=e.categories?e.categories.split(","):[],e.categories=t.map(e.categories,t.trim),e.bill_primary=t.trim(e.bill),e.bill&&!r.parsers.validateBillNumber(e.bill,i)&&r.log('Invalid primary bill number "'+e.bill+'" for row '+e.rowNumber+", see documentation."),e.bill_companion=t.trim(e.bill_companion),e.bill_companion&&!r.parsers.validateBillNumber(e.bill_companion,i)&&r.log('Invalid companion bill number "'+e.bill_companion+'" for row '+e.rowNumber+", see documentation."),e.bill_conference=t.trim(e.bill_conference),e.bill_conference&&!r.parsers.validateBillNumber(e.bill_conference,i)&&r.log('Invalid conference bill number "'+e.bill_conference+'" for row '+e.rowNumber+", see documentation."),e.hasBill=!0,e.bill&&e.bill_primary||(e.hasBill=!1,e.bill=t.cssClass(e.title.toLowerCase())),e})},r.parsers.eCategories=function(e,i){return t.map(e,function(t){return r.parsers.translateFields(i.fieldTranslations.eCategories,t),t.links=r.parsers.eLinks(t.links),t})},r.parsers.eEvents=function(e,i){return t.map(e,function(t){return r.parsers.translateFields(i.fieldTranslations.eEvents,t),t.links=r.parsers.eLinks(t.links),t.date=n(t.date),t.type=["custom"],t})},r.parsers.eLinks=function(e){var i=[];return e=t.trim(e),0===e.length?i:(e='"'===e.substring(0,1)?e.substring(1):e,e='"'===e.substring(e.length-1,e.length)?e.slice(0,-1):e,i=e.split('", "'),i=t.map(i,function(t){return{title:t.split("|")[0],url:t.split("|")[1]}}))},r.parsers.csvCategories=function(e){return e=t.trim(e),0===e.length?[]:(e='"'===e.substring(0,1)?e.substring(1):e,e='"'===e.substring(e.length-1,e.length)?e.slice(0,-1):e,e.split('", "'))},r.parsers.detectCompanionBill=function(e,i){var n,s;return t.isFunction(i.detectCompanionBill)?(n=i.detectCompanionBill(e),s=r.parsers.validateBillNumber(n,i)?n:void 0):t.isRegExp(i.detectCompanionBill)&&(n=i.detectCompanionBill.exec(e),s=n&&r.parsers.validateBillNumber(n[1],i)?n[1]:void 0),t.trim(s)},r.parsers.translateFields=function(e,i){return t.each(e,function(t,e){i[e]=i[t],e!==t&&delete i[t]}),i},r.BaseModel=i.Model.extend({initialize:function(t,e){this.options=e,this.app=this.options.app,this.on("sync",function(t){t.set("fetched",!0)})}}),r.OSModel=r.BaseModel.extend({urlBase:function(){return"http://openstates.org/api/v1/"},urlEnd:function(){return"/?apikey="+encodeURI(this.app.options.OSKey)+"&callback=?"},url:function(){return this.urlBase()+encodeURI(this.osType)+"/"+encodeURI(this.id)+this.urlEnd()},initialize:function(){r.OSModel.__super__.initialize.apply(this,arguments)}}),r.OSStateModel=r.OSModel.extend({url:function(){return this.urlBase()+"metadata/"+encodeURI(this.options.state)+this.urlEnd()}}),r.OSLegislatorModel=r.OSModel.extend({osType:"legislators",initialize:function(){r.OSBillModel.__super__.initialize.apply(this,arguments),this.get("leg_id")&&this.app.fetchModel(this)}}),r.OSCommitteeModel=r.OSModel.extend({osType:"committees"}),r.OSBillModel=r.OSModel.extend({url:function(){return t.isUndefined(this.id)?t.isUndefined(this.get("bill_id"))||""===this.get("bill_id")?void 0:this.urlBase()+"bills/"+encodeURI(this.app.options.state)+"/"+encodeURI(this.app.options.session)+"/"+encodeURI(this.get("bill_id"))+this.urlEnd():this.urlBase()+"bills/"+this.id+this.urlEnd()},initialize:function(){r.OSBillModel.__super__.initialize.apply(this,arguments)},parse:function(e){var i=this;return e.created_at=e.created_at?n(e.created_at):void 0,e.updated_at=e.updated_at?n(e.updated_at):void 0,e.action_dates=t.filterObject(e.action_dates,function(t){return t}),e.action_dates=t.mapObject(e.action_dates,function(t){return n(t)}),e.actions=t.mapObject(e.actions,function(t){return t.date=n(t.date),t}),e.votes=t.mapObject(e.votes,function(t){return t.date=n(t.date),t}),this.get("custom_events")&&(e.actions=t.union(e.actions,this.get("custom_events"))),e.actions=t.sortBy(e.actions,function(t,e){return-1*(t.date.unix()+e)}),e.newest_action=e.actions[0],this.app.options.osBillParse&&t.isFunction(this.app.options.osBillParse)&&(e=this.options.osBillParse(e,this)),e.sponsors&&(e.sponsors=t.map(e.sponsors,function(t){return t.id=t.leg_id,t.leg=i.app.getModel("OSLegislatorModel","leg_id",t),t})),e},getActionDate:function(t){return this.get("action_dates")[t]?this.get("action_dates")[t]:!1},isSubstituted:function(){var e=!1,i=this;return t.isBoolean(this.get("substitued"))?e=this.get("substitued"):this.app.options.substituteMatch===!1?e=!1:(e=t.find(this.get("actions"),function(t){return t.action.match(i.app.options.substituteMatch)}),e=e?!0:!1,this.set("substitued",e)),e}}),r.BillModel=r.BaseModel.extend({subbills:["bill_primary","bill_companion","bill_conference"],initialize:function(){r.BillModel.__super__.initialize.apply(this,arguments),this.loadOSBills()},loadOSBills:function(){var e=this;t.each(this.subbills,function(t){var i;e.get(t)&&(i=e.app.getModel("OSBillModel","bill_id",{bill_id:e.get(t)}),e.set(t,i))})},getOSBills:function(){var e=this;return t.filterEmpty(t.map(this.subbills,function(t){return e.get(t)}))},getOSBillIDs:function(){var e=this.getOSBills();return t.filterEmpty(t.map(e,function(e){return t.isObject(e)?e.get("bill_id"):e}))},fetchOSBills:function(){var i=this,n=[];return this.getCategories(),t.each(this.subbills,function(t){i.get("hasBill")&&i.get(t)&&n.push(i.app.fetchModel(i.get(t)))}),e.when.apply(e,n).done(function(){i.loadOSCompanion().done(function(){i.parseMeta(),i.lastUpdatedAt(),i.newestAction(),i.trigger("fetched:osbills")})})},fetch:function(){return this.fetchOSBills()},loadOSCompanion:function(){var i,n=this,s=[];return this.get("hasBill")===!0&&!this.get("bill_companion")&&t.isObject(this.get("bill_primary"))&&t.isArray(this.get("bill_primary").get("companions"))&&t.isObject(this.get("bill_primary").get("companions")[0])&&(i=r.parse.detectCompanionBill(this.get("bill_primary").get("companions")[0].bill_id),i&&(this.set("bill_companion",n.app.getModel("OSBillModel","bill_id",{bill_id:i})),s.push(n.app.fetchModel(this.get("bill_companion"))))),e.when.apply(e,s)},getCategories:function(){var e=this;this.get("categories")&&this.set("categories",t.map(this.get("categories"),function(i){return t.isObject(i)||(i=e.app.getModel("CategoryModel","id",{id:i})),i}))},lastUpdatedAt:function(){var t,e=this.get("bill_primary"),i=this.get("bill_companion"),n=this.get("bill_conference");return e&&e.get("updated_at")&&(t=e.get("updated_at"),i&&i.get("updated_at")&&(t=i.get("updated_at").unix()>t.unix()?i.get("updated_at"):t),n&&n.get("updated_at")&&(t=n.get("updated_at").unix()>t.unix()?n.get("updated_at"):t),this.set("last_updated_at",t)),this.get("last_updated_at")},newestAction:function(){var t,e=this.get("bill_primary"),i=this.get("bill_companion"),n=this.get("bill_conference");return this.get("hasBill")&&e.get("newest_action")&&(t=e.get("newest_action"),i&&i.get("newest_action")&&(t=i.get("newest_action").date.unix()>t.date.unix()?i.get("newest_action"):t),n&&n.get("newest_action")&&(t=n.get("newest_action").date.unix()>t.date.unix()?n.get("newest_action"):t),this.set("newest_action",t)),this.get("newest_action")},isRecent:function(){var e=this.newestAction(),i=this.get("bill_primary")?this.get("bill_primary").get("action_dates"):null;return t.isObject(e)&&e.date&&n().diff(e.date,"days")<=this.app.options.recentChangeThreshold?!0:t.isObject(i)&&i.last&&n().diff(i.last,"days")<=this.app.options.recentChangeThreshold?!0:!1},parseMeta:function(){var e,i,n=this,s={upper:!1,lower:!1,conference:!1,signed:!1,last:!1},l={companion:this.get("bill_companion")?!0:!1,conference:this.get("bill_conference")?!0:!1};if(this.get("custom_events")&&this.set("custom_events",t.sortBy(this.get("custom_events"),function(t,e){return-1*(t.date.unix()+e)})),this.get("hasBill")){if(l.companion&&(this.get("bill_companion").isSubstituted()&&(l.substituted=!0),this.get("bill_primary").isSubstituted()&&(l.substituted=!0,e=this.get("bill_primary").get("bill_id"),i=this.get("bill_companion").get("bill_id"),this.unset("bill_primary"),this.set("bill_primary",function(){return n.app.getModel("OSBillModel","bill_id",{bill_id:i})}()),this.unset("bill_companion"),this.set("bill_companion",function(){return n.app.getModel("OSBillModel","bill_id",{bill_id:e})}()))),(!l.companion||l.substituted)&&(s.lower=this.get("bill_primary").getActionDate("passed_lower"),s.upper=this.get("bill_primary").getActionDate("passed_upper")),l.companion&&!l.substituted&&("upper"===this.get("bill_primary").get("chamber")?(s.upper=this.get("bill_primary").getActionDate("passed_upper"),s.lower=this.get("bill_companion").getActionDate("passed_lower")):(s.lower=this.get("bill_primary").getActionDate("passed_lower"),s.upper=this.get("bill_companion").getActionDate("passed_upper"))),l.conference){var a=this.get("bill_conference").getActionDate("passed_lower"),o=this.get("bill_conference").getActionDate("passed_upper");a&&o&&(s.conference=a.unix()>=o.unix()?a:o)}s.signed=l.conference?this.get("bill_conference").getActionDate("signed"):this.get("bill_primary").getActionDate("signed"),s.last=l.conference?this.get("bill_conference").getActionDate("last"):l.companion?this.get("bill_companion").getActionDate("last").unix()>=this.get("bill_primary").getActionDate("last").unix()?this.get("bill_companion").getActionDate("last"):this.get("bill_primary").getActionDate("last"):this.get("bill_primary").getActionDate("last"),this.get("description")||this.set("description",this.get("bill_primary").get("summary"))}return l.recent=this.isRecent(),this.set("actions",s),this.set("bill_type",l),this.trigger("change"),this}}),r.CategoryModel=r.BaseModel.extend({initialize:function(){r.CategoryModel.__super__.initialize.apply(this,arguments),this.set("bills",new r.BillsCollection(null))},getBills:function(e){var i=this,n=this.get("id");return e.each(function(e){-1!==t.indexOf(e.get("categories"),n)&&i.get("bills").push(i.app.getModel("BillModel","bill",e.attributes))}),this}}),r.CategoriesCollection=i.Collection.extend({model:r.CategoryModel,comparator:function(t){return-1!==t.get("title").toLowerCase().indexOf("recent")?"zzzzz":t.get("title")}}),r.BillsCollection=i.Collection.extend({model:r.BillModel,comparator:function(t){return t.newestAction()?-1*t.newestAction().date.unix():9999}}),r.OSBillsCollection=i.Collection.extend({model:r.OSBillModel,comparator:function(t){var e=t.get("newest_action");return e?-1*e.date.unix():9999}}),r.OSLegislatorsCollection=i.Collection.extend({model:r.OSLegislatorModel,comparator:function(t){return("primary"===t.get("type")?"aaa":"bbb")+t.get("name")}}),r.BaseView=l.extend({baseInit:function(t){this.options=t.options,this.app=t.app,this.router=t.router},adaptors:["Backbone"]}),r.ApplicationView=r.BaseView.extend({init:function(){this.baseInit.apply(this,arguments),this.stuck=!1,this.observe("categories",function(i){this.stuck||this.get("options").stickMenu===!0||(this.stuck=!0),!this.stuck&&i&&t.isObject(i)&&i.length>0&&(this.stuck=!0,e(this.el).find(".ls-header").ltStick({container:e(this.el)}))})}}),r.CategoriesView=r.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),r.CategoryView=r.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),r.EBillView=r.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),r.OSBillView=r.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),r.OSSponsorView=r.BaseView.extend({init:function(){this.baseInit.apply(this,arguments)}}),r.MainRouter=i.Router.extend({routes:{categories:"routeCategories","category/recent":"routeRecentCategory","category/:category":"routeCategory","bill/:bill":"routeEBill","*defaultR":"routeDefault"},initialize:function(e){e.router=this,this.options=e,this.app=e.app,this.imagePath=t.bind(this.app.imagePath,this.app),this.translate=t.bind(this.app.translate,this.app),this.app.views.application=new r.ApplicationView({el:this.app.$el,template:this.app.templates.application,data:{options:this.options,categories:this.app.categories,imagePath:this.imagePath},options:this.options,partials:{loading:this.app.templates.loading}}),this.$content=this.app.$el.find(".ls-content-container")
},start:function(){i.history.start()},routeDefault:function(){this.navigate("/categories",{trigger:!0,replace:!0})},routeCategories:function(){this.app.fetchBasicBillData(),this.app.views.application.set("menuOff",!0),t.isObject(this.app.views.categories)&&this.app.views.categories.teardown(),this.app.views.categories=new r.CategoriesView({el:this.$content,template:this.app.templates.categories,data:{options:this.options,categories:this.app.categories,imagePath:this.imagePath},options:this.options,partials:{loading:this.app.templates.loading}})},routeCategory:function(e,i){i=i||!0;var n=decodeURI(e),s={options:this.options,imagePath:this.imagePath,translate:this.translate};e=this.app.categories.get(n),this.app.views.application.set("menuOff",!1),e||this.navigate("/",{trigger:!0,replace:!0}),t.isObject(this.app.views.category)&&this.app.views.category.teardown(),i&&this.app.fetchOSBillsFromCategory(e),this.app.views.category=new r.CategoryView({el:this.$content,template:this.app.templates.category,data:t.extend({},s,{category:e,categoryID:n}),options:this.options,partials:{loading:this.app.templates.loading},components:{ebill:r.EBillView.extend({template:this.app.templates.ebill,data:s,components:{osbill:r.OSBillView.extend({template:this.app.templates.osbill,data:s}),sponsor:r.OSSponsorView.extend({template:this.app.templates.sponsor,data:s})}})}}),this.app.on("fetched:osbills:category:"+e.id,function(){e.get("bills").sort()})},routeRecentCategory:function(){var t=this;this.app.fetchBasicBillData().done(function(){t.app.fetchOSBillsFromCategory(t.app.categories.get("recent"))}),this.routeCategory("recent",!1)},routeEBill:function(e){var i=decodeURI(e),n={options:this.options,imagePath:this.imagePath,translate:this.translate};e=this.app.bills.where({bill:i})[0],this.app.views.application.set("menuOff",!1),e||this.navigate("/",{trigger:!0,replace:!0}),t.isObject(this.app.views.bill)&&this.app.views.bill.teardown(),e.fetchOSBills(),this.app.views.bill=new r.EBillView({el:this.$content,template:this.app.templates.ebill,data:t.extend({},n,{bill:e,billID:i}),options:this.options,partials:{loading:this.app.templates.loading},components:{osbill:r.OSBillView.extend({template:this.app.templates.osbill,data:n,components:{sponsor:r.OSSponsorView.extend({template:this.app.templates.sponsor,data:n})}})}})},error:function(){}}),o=function(i){this.options=t.extend({},this.defaultOptions,i),this.options.app=this,this.options.$el=this.$el=e(this.options.el),this.on("fetched:base-data",this.loadBaseData),this.on("loaded:basic-bill-data",this.loadRecentCategory),this.categories=new r.CategoriesCollection(null),this.bills=new r.BillsCollection(null),this.getTemplates(),this.fetchBaseData(),this.router=new r.MainRouter(this.options),this.on("loaded:base-data",this.startRouting)},t.extend(o.prototype,i.Events),t.extend(o.prototype,{views:{},cache:{},fetched:{},startRouting:function(){this.router.start()},fetchBaseData:function(){var e=this;this.fetched.baseData!==!0&&(this.tabletop=s.init(t.extend(this.options.tabletopOptions,{key:this.options.eKey,callback:function(t,i){e.fetched.baseData=!0,e.trigger("fetched:base-data",t,i)},callbackContext:e,wanted:this.options.sheetsWanted})))},loadBaseData:function(e,i){var n,s,l=this;s=r.parsers.eData(i,this.options),t.each(s.categories,function(t){this.categories.add(this.getModel("CategoryModel","id",t))},this),t.each(s.bills,function(t){this.bills.add(this.getModel("BillModel","bill",t))},this),n={id:"recent",title:"Recent Actions",description:"The following bills have been updated in the past "+this.options.recentChangeThreshold+" days.",image:this.options.recentImage},this.categories.add(this.getModel("CategoryModel","id",n)),this.categories.each(function(t){t.getBills(l.bills)}),this.trigger("loaded:base-data")},fetchBasicBillData:function(){var i,s=this,l=[];return this.fetched.basicBillData===!0?e.when.apply(e,[]):(this.bills.each(function(e){t.each(e.getOSBillIDs(),function(t){l.push(t)})}),i="http://openstates.org/api/v1/bills/?state="+this.options.state+"&fields=action_dates,chamber,title,id,created_at,updated_at,bill_id"+"&search_window=session:"+this.options.session+"&bill_id__in="+encodeURI(l.join("|"))+"&apikey="+this.options.OSKey+"&callback=?",e.getJSON(i).done(function(e){s.fetched.basicBillData=!0,s.trigger("fetched:basic-bill-data"),t.each(e,function(e){e.action_dates=t.filterObject(e.action_dates,function(t){return t}),e.action_dates=t.mapObject(e.action_dates,function(t){return n(t)}),e.created_at=n(e.created_at),e.updated_at=n(e.updated_at),s.getModel("OSBillModel","bill_id",e).set(e)}),s.trigger("loaded:basic-bill-data")}))},loadRecentCategory:function(){var t=this.getModel("CategoryModel","id",{id:"recent"});this.bills.each(function(e){var i=e.get("categories");e.isRecent()&&(i.push(t.get("id")),e.set("categories",i))}),t.getBills(this.bills)},fetchOSBillsFromBill:function(){category.get("id");var e=[];t.each(category.get("bills"),function(t){e.push(t.fetch())})},fetchOSBillsFromCategory:function(t){var i=this,n=[];return t.getBills(this.bills),t.get("bills").each(function(t){n.push(i.fetchModel(t))}),e.when.apply(e,n).done(function(){i.trigger("fetched:osbills"),i.trigger("fetched:osbills:category:"+t.id)})},getModel:function(e,i,n,s){var l="models:"+e+":"+i+":"+n[i];return s=t.extend(s||{},{app:this}),t.isUndefined(this.cache[l])&&(this.cache[l]=new r[e](n,s)),this.cache[l]},fetchModel:function(t){var i;return t.get("fetched")!==!0?t.fetch({success:function(t){t.set("fetched",!0,{silent:!0})}}):(i=e.Deferred(),i.resolveWith(t),i)},translate:function(e,i){var n=i;return t.isObject(this.options.wordTranslations[e])&&t.isString(this.options.wordTranslations[e][i])&&(n=this.options.wordTranslations[e][i]),n},imagePath:function(t){return 0===t.indexOf("http")?t:this.options.imagePath+t},getTemplate:function(t){return r.templates[t]},templates:{},getTemplates:function(){this.templates.application=this.getTemplate("template-application"),this.templates.loading=this.getTemplate("template-loading"),this.templates.error=this.getTemplate("template-error"),this.templates.ebill=this.getTemplate("template-ebill"),this.templates.osbill=this.getTemplate("template-osbill"),this.templates.category=this.getTemplate("template-category"),this.templates.categories=this.getTemplate("template-categories"),this.templates.sponsor=this.getTemplate("template-sponsor")},defaultOptions:{sheetsWanted:["Categories","Bills","Events"],fieldTranslations:{eCategories:{id:"categoryid",short_title:"shorttitle"},eBills:{bill:"bill",bill_companion:"companionbill",bill_conference:"conferencebill",categories:"categories",title:"title",description:"description"},eEvents:{bill_id:"bill",actor:"chamber",action:"title"}},wordTranslations:{chamber:{upper:"Senate",lower:"House"},partyAbbr:{"Democratic-Farmer-Labor":"DFL",Democratic:"D",Republican:"R"}},maxBills:30,substituteMatch:/substituted/i,imagePath:"./styles/images/",recentChangeThreshold:7,tabletopOptions:{},conferenceBill:!0,recentImage:"RecentUpdatedBill.png",chamberLabel:!1,detectCompanionBill:/([A-Z]+ [1-9][0-9]*)$/,billNumberFormat:/[A-Z]+ [1-9][0-9]*/,osBillParse:void 0,stickMenu:!0}}),r.templates=this.LTTemplates,o});