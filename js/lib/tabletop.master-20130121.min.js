(function(e){"use strict";Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){t==null?t=0:t<0&&(t=Math.max(0,this.length+t));for(var n=t,r=this.length;n<r;n++)if(this[n]===e)return n;return-1});var t=e.Tabletop=function(e){if(!this||!(this instanceof t))return new t(e);typeof e=="string"&&(e={key:e}),this.callback=e.callback,this.wanted=e.wanted||[],this.key=e.key,this.simpleSheet=!!e.simpleSheet,this.parseNumbers=!!e.parseNumbers,this.wait=!!e.wait,this.postProcess=e.postProcess,this.debug=!!e.debug,this.query=e.query||"",/key=/.test(this.key)&&(this.log("You passed a key as a URL! Attempting to parse."),this.key=this.key.match("key=(.*?)&")[1]);if(!this.key){alert("You need to pass Tabletop a key!");return}this.log("Initializing with key "+this.key),this.models={},this.model_names=[],this.base_json_url="https://spreadsheets.google.com/feeds/worksheets/"+this.key+"/public/basic?alt=json-in-script",this.wait||this.fetch()};t.callbacks={},t.init=function(e){return new t(e)},t.sheets=function(){alert("Times have changed! You'll want to use var tabletop = Tabletop.init(...); tabletop.sheets(...); instead of Tabletop.sheets(...)")},t.prototype={fetch:function(e){typeof e!="undefined"&&(this.callback=e),this.injectScript(this.base_json_url,this.loadSheets)},injectScript:function(e,n){var r=document.createElement("script"),i=this,s="tt"+ +(new Date)+Math.floor(Math.random()*1e5);t.callbacks[s]=function(){var e=Array.prototype.slice.call(arguments,0);n.apply(i,e),r.parentNode.removeChild(r),delete t.callbacks[s]},e=e+"&callback="+"Tabletop.callbacks."+s,r.src=e,document.getElementsByTagName("script")[0].parentNode.appendChild(r)},isWanted:function(e){return this.wanted.length===0?!0:this.wanted.indexOf(e)!=-1},data:function(){return this.model_names.length===0?undefined:this.simpleSheet?(this.model_names.length>1&&this.debug&&console.debug("WARNING You have more than one sheet but are using simple sheet mode! Don't blame me when something goes wrong."),this.models[this.model_names[0]].all()):this.models},addWanted:function(e){this.wanted.indexOf(e)==-1&&this.wanted.push(e)},loadSheets:function(e){var t,n,r=[];for(t=0,n=e.feed.entry.length;t<n;t++)if(this.isWanted(e.feed.entry[t].content.$t)){var i=e.feed.entry[t].link[3].href.substr(e.feed.entry[t].link[3].href.length-3,3),s="https://spreadsheets.google.com/feeds/list/"+this.key+"/"+i+"/public/values?alt=json-in-script&sq="+this.query;this.log(s),r.push(s)}this.sheetsToLoad=r.length;for(t=0,n=r.length;t<n;t++)this.injectScript(r[t],this.loadSheet)},sheets:function(e){if(typeof e=="undefined")return this.models;if(typeof this.models[e]=="undefined")return;return this.models[e]},loadSheet:function(e){var n=new t.Model({data:e,parseNumbers:this.parseNumbers,postProcess:this.postProcess,tabletop:this});this.models[n.name]=n,this.model_names.indexOf(n.name)==-1&&this.model_names.push(n.name),this.sheetsToLoad--,this.sheetsToLoad===0&&this.doCallback()},doCallback:function(){this.sheetsToLoad===0&&this.callback.apply(this.callbackContext||this,[this.data(),this])},log:function(e){this.debug&&typeof console!="undefined"&&typeof console.log!="undefined"&&Function.prototype.apply.apply(console.log,[console,arguments])}},t.Model=function(e){var t,n,r,i;this.column_names=[],this.name=e.data.feed.title.$t,this.elements=[],this.raw=e.data;if(typeof e.data.feed.entry=="undefined"){e.tabletop.log("Missing data for "+this.name+", make sure you didn't forget column headers"),this.elements=[];return}for(var s in e.data.feed.entry[0])/^gsx/.test(s)&&this.column_names.push(s.replace("gsx$",""));for(t=0,r=e.data.feed.entry.length;t<r;t++){var o=e.data.feed.entry[t],u={};for(var n=0,i=this.column_names.length;n<i;n++){var a=o["gsx$"+this.column_names[n]];e.parseNumbers&&a.$t!==""&&!isNaN(a.$t)?u[this.column_names[n]]=+a.$t:u[this.column_names[n]]=a.$t}u.rowNumber===undefined&&(u.rowNumber=t+1),e.postProcess&&e.postProcess(u),this.elements.push(u)}},t.Model.prototype={all:function(){return this.elements},toArray:function(){var e=[],t,n,r,i;for(t=0,r=this.elements.length;t<r;t++){var s=[];for(n=0,i=this.column_names.length;n<i;n++)s.push(this.elements[t][this.column_names[n]]);e.push(s)}return e}}})(this);